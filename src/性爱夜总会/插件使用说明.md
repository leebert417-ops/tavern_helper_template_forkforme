# 江畔夜总会插件使用说明

## 📋 前置要求

1. **SillyTavern** 环境
2. **MVU（Magical Variable Update）插件** 已安装并启用
3. 已在世界书中添加 `[InitVar]` 变量初始化条目

## 🚀 快速开始

### 方法1：使用快速加载脚本（推荐测试）

1. **打开 SillyTavern 控制台**
   - 按 `F12` 打开开发者工具
   - 切换到 `Console（控制台）` 标签

2. **复制并执行脚本**
   - 打开 `快速加载插件.js`
   - 复制全部内容
   - 粘贴到控制台
   - 按 `Enter` 执行

3. **查看效果**
   - 在页面右下角应该能看到 🌙 浮动按钮
   - 点击按钮打开管理面板

### 方法2：使用完整版插件

1. **复制完整插件代码**
   - 打开 `状态栏插件.js`
   - 复制全部内容

2. **在控制台执行**
   - 粘贴到控制台并执行

3. **永久安装（可选）**
   - 将代码保存到 SillyTavern 的插件目录
   - 或者通过 SillyTavern 的脚本扩展功能加载

## 🔍 故障排查

### 问题1：看不到浮动按钮

**诊断步骤：**

```javascript
// 在控制台执行以下命令检查
console.log('按钮元素:', document.getElementById('nightclub-toggle-btn'));
console.log('Mvu 可用:', typeof Mvu !== 'undefined');
```

**解决方案：**

- 确保脚本执行成功（控制台显示 ✅ 消息）
- 检查是否有 z-index 冲突
- 尝试刷新页面后重新执行

### 问题2：提示"MVU 框架未加载"

**原因：** MVU 插件未安装或未启用

**解决方案：**

1. 在 SillyTavern 中安装 MVU 插件
2. 确保 MVU 插件已启用
3. 刷新页面后重试

### 问题3：显示"stat_data 不存在"

**原因：** 变量系统未初始化

**解决方案：**

1. 确保已创建世界书条目
2. 条目名称包含 `[InitVar]`
3. 条目内容为 `变量初始化_beta.xyaml` 的 JSON5 数据
4. 确保条目已激活（不一定要常驻）
5. 发送一条消息，让 AI 回复后再打开面板

## 🎯 功能说明

### 完整版插件功能

- ✅ 可拖动浮动按钮
- ✅ 全屏管理面板
- ✅ 时间地点显示
- ✅ 经营数据概览
- ✅ 工坊培养状况（带进度条）
- ✅ 已归档艺人列表
- ✅ 传媒公司联系信息
- ✅ 可折叠分区
- ✅ 深色主题支持

### 快速测试版功能

- ✅ 基础数据显示
- ✅ 浮动按钮
- ✅ 简化版面板
- ⚠️ 不包含完整的进度条和交互

## 📊 数据结构说明

插件从 MVU 系统读取以下数据结构：

```javascript
{
  "时间信息": {
    "当前日期": "...",
    "当前时间": "...",
    "营业状态": "..."
  },
  "地点信息": {
    "当前位置": "..."
  },
  "夜总会经营": {
    "本月营收": 数字,
    "在职员工数": 数字,
    "VIP客户数": 数字,
    "待处理订单": [...]
  },
  "工坊培养对象": {
    "培养列表": [
      {
        "姓名": "...",
        "培养进度": {
          "社交礼仪": 0-100,
          "才艺培养": 0-100,
          ...
        }
      }
    ]
  },
  ...
}
```

## 🎨 自定义样式

可以通过修改插件中的 CSS 变量来自定义外观：

```css
:root {
  --nightclub-primary: #e94560;  /* 主题色 */
  --nightclub-bg-dark: #1a1a2e;  /* 深色背景 */
  --nightclub-bg-mid: #16213e;   /* 中等背景 */
  ...
}
```

## 🔄 更新数据

插件会在以下情况自动刷新数据：

- 打开面板时
- 点击浮动按钮时

手动刷新：关闭面板后重新打开

## 💡 提示

1. **性能优化**：大量数据时可能需要等待几秒加载
2. **兼容性**：需要现代浏览器（支持 ES6+）
3. **移动端**：可以使用，但建议在桌面端操作
4. **持久化**：浮动按钮位置会自动保存到 localStorage

## 🆘 仍然无法使用？

运行诊断脚本（在控制台执行）：

```javascript
console.log('=== 江畔夜总会插件诊断 ===');
console.log('1. Mvu 框架:', typeof Mvu !== 'undefined' ? '✅ 可用' : '❌ 不可用');
console.log('2. getLastMessageId:', typeof getLastMessageId !== 'undefined' ? '✅ 可用' : '❌ 不可用');
console.log('3. jQuery:', typeof jQuery !== 'undefined' ? '✅ 可用' : '❌ 不可用');

if (typeof Mvu !== 'undefined' && typeof getLastMessageId === 'function') {
  const data = Mvu.getMvuData({ type: 'message', message_id: getLastMessageId() });
  console.log('4. MVU 数据:', data ? '✅ 有数据' : '❌ 无数据');
  if (data && data.stat_data) {
    console.log('5. stat_data 结构:', Object.keys(data.stat_data));
  }
}
```

将诊断结果截图反馈，以便进一步排查问题。
