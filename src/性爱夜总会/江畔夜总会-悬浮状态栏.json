{
  "type": "script",
  "enabled": true,
  "name": "江畔夜总会-悬浮状态栏",
  "id": "3f8e2a9c-4d7b-4f1a-9c8e-5b6a7d9e0f2a",
  "content": "// ==================== 江畔夜总会管理面板 - SillyTavern 插件版 ====================\n// 动态状态栏插件，支持可拖动浮动按钮\n// 版本：1.0\n\nconsole.log('🌙 加载江畔夜总会管理面板插件...');\n\n// ==================== 样式定义 ====================\nconst styles = `\n<style id=\"nightclub-plugin-styles\">\n* {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n}\n\n.no-select {\n    user-select: none;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    -ms-user-select: none;\n}\n\nbutton:focus,\nbutton:active,\n.nightclub-toggle-btn:focus,\n.nightclub-toggle-btn:active {\n    outline: none !important;\n    -webkit-tap-highlight-color: transparent !important;\n}\n\n* {\n    -webkit-tap-highlight-color: transparent;\n    -webkit-touch-callout: none;\n}\n\n:root {\n    --nightclub-primary: #e94560;\n    --nightclub-bg-dark: #1a1a2e;\n    --nightclub-bg-mid: #16213e;\n    --nightclub-text-light: #eee;\n    --nightclub-text-dim: #aaa;\n    --nightclub-text-dimmer: #bbb;\n}\n\n.nightclub-toggle-btn {\n    position: fixed;\n    bottom: 80px;\n    right: 20px;\n    width: 60px;\n    height: 60px;\n    border-radius: 50%;\n    background: linear-gradient(135deg, var(--nightclub-primary) 0%, #ff6b6b 100%);\n    border: 3px solid rgba(233, 69, 96, 0.5);\n    color: white;\n    font-size: 24px;\n    cursor: move;\n    z-index: 9998;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    box-shadow: 0 4px 20px rgba(233, 69, 96, 0.5);\n    transition: transform 0.2s, box-shadow 0.2s;\n    touch-action: none;\n}\n\n.nightclub-toggle-btn:hover {\n    transform: scale(1.1);\n    box-shadow: 0 6px 30px rgba(233, 69, 96, 0.7);\n}\n\n.nightclub-toggle-btn:active {\n    transform: scale(0.95);\n}\n\n.nightclub-main-panel {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.85);\n    z-index: 9999;\n    display: none;\n    justify-content: center;\n    align-items: center;\n    padding: 20px;\n    overflow-y: auto;\n}\n\n.nightclub-main-panel.active {\n    display: flex;\n}\n\n.nightclub-panel-content {\n    background: linear-gradient(135deg, var(--nightclub-bg-dark) 0%, var(--nightclub-bg-mid) 100%);\n    border: 2px solid var(--nightclub-primary);\n    border-radius: 12px;\n    box-shadow: 0 8px 32px rgba(233, 69, 96, 0.4);\n    max-width: 800px;\n    width: 100%;\n    max-height: 90vh;\n    overflow-y: auto;\n    color: var(--nightclub-text-light);\n    font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;\n}\n\n.nightclub-panel-header {\n    position: sticky;\n    top: 0;\n    background: rgba(233, 69, 96, 0.15);\n    border-bottom: 2px solid var(--nightclub-primary);\n    padding: 20px;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    z-index: 1;\n}\n\n.nightclub-panel-header h2 {\n    font-size: 24px;\n    color: var(--nightclub-primary);\n    text-shadow: 0 0 10px rgba(233, 69, 96, 0.5);\n}\n\n.nightclub-close-btn {\n    background: transparent;\n    border: 2px solid var(--nightclub-primary);\n    color: var(--nightclub-primary);\n    width: 36px;\n    height: 36px;\n    border-radius: 50%;\n    cursor: pointer;\n    font-size: 20px;\n    transition: all 0.3s;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.nightclub-close-btn:hover {\n    background: var(--nightclub-primary);\n    color: white;\n    transform: rotate(90deg);\n}\n\n.nightclub-panel-body {\n    padding: 20px;\n}\n\n.nightclub-section {\n    margin-bottom: 20px;\n}\n\n.nightclub-section-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 12px;\n    background: rgba(233, 69, 96, 0.2);\n    border-radius: 8px;\n    cursor: pointer;\n    transition: background 0.3s;\n    user-select: none;\n}\n\n.nightclub-section-header:hover {\n    background: rgba(233, 69, 96, 0.3);\n}\n\n.nightclub-section-header.expanded {\n    border-bottom-left-radius: 0;\n    border-bottom-right-radius: 0;\n}\n\n.nightclub-section-header span:first-child {\n    font-size: 16px;\n    font-weight: bold;\n    color: var(--nightclub-primary);\n}\n\n.nightclub-section-header span:last-child {\n    font-size: 14px;\n    color: var(--nightclub-primary);\n    transition: transform 0.3s;\n}\n\n.nightclub-section-content {\n    max-height: 0;\n    overflow: hidden;\n    transition: max-height 0.3s ease-out;\n    background: rgba(255, 255, 255, 0.03);\n    border-radius: 0 0 8px 8px;\n}\n\n.nightclub-section-content.expanded {\n    max-height: 3000px;\n    padding: 15px;\n}\n\n.nightclub-property {\n    margin-bottom: 12px;\n    padding: 10px;\n    background: rgba(255, 255, 255, 0.05);\n    border-radius: 6px;\n    border-left: 3px solid var(--nightclub-primary);\n}\n\n.nightclub-property-name {\n    font-size: 13px;\n    color: var(--nightclub-text-dim);\n    margin-bottom: 5px;\n}\n\n.nightclub-property-value {\n    display: flex;\n    align-items: baseline;\n    gap: 8px;\n}\n\n.nightclub-value-main {\n    font-size: 18px;\n    font-weight: bold;\n    color: white;\n}\n\n.nightclub-value-desc {\n    font-size: 12px;\n    color: var(--nightclub-text-dimmer);\n}\n\n.nightclub-highlight {\n    color: var(--nightclub-primary);\n}\n\n.nightclub-progress-container {\n    background: rgba(0, 0, 0, 0.3);\n    border-radius: 10px;\n    height: 18px;\n    overflow: hidden;\n    margin-top: 6px;\n}\n\n.nightclub-progress-bar {\n    height: 100%;\n    border-radius: 10px;\n    transition: width 0.5s ease;\n}\n\n.nightclub-progress-low {\n    background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);\n}\n\n.nightclub-progress-mid {\n    background: linear-gradient(90deg, #f39c12 0%, #e67e22 100%);\n}\n\n.nightclub-progress-high {\n    background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%);\n}\n\n.nightclub-trainee-card {\n    background: rgba(233, 69, 96, 0.1);\n    border: 1px solid rgba(233, 69, 96, 0.3);\n    border-radius: 6px;\n    padding: 12px;\n    margin-bottom: 12px;\n}\n\n.nightclub-trainee-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 10px;\n    padding-bottom: 8px;\n    border-bottom: 1px solid rgba(233, 69, 96, 0.2);\n}\n\n.nightclub-trainee-name {\n    font-size: 15px;\n    font-weight: bold;\n    color: var(--nightclub-primary);\n}\n\n.nightclub-trainee-id {\n    font-size: 11px;\n    color: var(--nightclub-text-dim);\n}\n\n.nightclub-trainee-info {\n    font-size: 12px;\n    color: var(--nightclub-text-dimmer);\n    margin: 5px 0;\n}\n\n.nightclub-archive-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));\n    gap: 10px;\n    margin-top: 12px;\n}\n\n.nightclub-archive-item {\n    background: rgba(255, 255, 255, 0.05);\n    padding: 10px;\n    border-radius: 6px;\n    border: 1px solid rgba(233, 69, 96, 0.2);\n}\n\n.nightclub-archive-name {\n    font-weight: bold;\n    color: var(--nightclub-primary);\n    font-size: 13px;\n    margin-bottom: 4px;\n}\n\n.nightclub-archive-details {\n    font-size: 11px;\n    color: var(--nightclub-text-dim);\n    margin: 2px 0;\n}\n\n.nightclub-error {\n    color: #ff6b6b;\n    padding: 20px;\n    text-align: center;\n    background: rgba(255, 107, 107, 0.1);\n    border-radius: 8px;\n    margin: 20px;\n}\n\n@media (max-width: 768px) {\n    .nightclub-panel-content {\n        max-height: 95vh;\n        margin: 10px;\n    }\n    \n    .nightclub-toggle-btn {\n        bottom: 60px;\n        right: 15px;\n        width: 50px;\n        height: 50px;\n        font-size: 20px;\n    }\n    \n    .nightclub-archive-grid {\n        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));\n    }\n}\n</style>\n`;\n\n// ==================== HTML 结构 ====================\nconst html = `\n<div id=\"nightclub-status-plugin\">\n    <button class=\"nightclub-toggle-btn no-select\" id=\"nightclub-toggle-btn\">\n        🌙\n    </button>\n    \n    <div class=\"nightclub-main-panel\" id=\"nightclub-main-panel\">\n        <div class=\"nightclub-panel-content\">\n            <div class=\"nightclub-panel-header\">\n                <h2>🌙 江畔夜总会 - 管理面板</h2>\n                <button class=\"nightclub-close-btn\" id=\"nightclub-close-btn\">×</button>\n            </div>\n            \n            <div class=\"nightclub-panel-body\" id=\"nightclub-panel-body\">\n                <div class=\"nightclub-section\">\n                    <div class=\"nightclub-section-header\" data-section=\"time\">\n                        <span>⏰ 时空信息</span>\n                        <span>▼</span>\n                    </div>\n                    <div class=\"nightclub-section-content\" data-section=\"time\">\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">📅 当前日期</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main\" id=\"nc-time-date\">未设置</span>\n                            </div>\n                        </div>\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">🕐 当前时间</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main\" id=\"nc-time-clock\">--:--</span>\n                            </div>\n                        </div>\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">📍 当前位置</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main\" id=\"nc-location\">未知</span>\n                            </div>\n                        </div>\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">🎭 营业状态</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main\" id=\"nc-status\">未知</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                <div class=\"nightclub-section\">\n                    <div class=\"nightclub-section-header\" data-section=\"business\">\n                        <span>💼 经营概况</span>\n                        <span>▼</span>\n                    </div>\n                    <div class=\"nightclub-section-content\" data-section=\"business\">\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">💰 本月营收 (万元)</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main nightclub-highlight\" id=\"nc-revenue\">0</span>\n                            </div>\n                        </div>\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">👥 在职员工</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main\" id=\"nc-employees\">0</span>\n                                <span class=\"nightclub-value-desc\">人</span>\n                            </div>\n                        </div>\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">⭐ VIP客户</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main\" id=\"nc-vip\">0</span>\n                                <span class=\"nightclub-value-desc\">位</span>\n                            </div>\n                        </div>\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">📋 待处理订单</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main nightclub-highlight\" id=\"nc-orders\">0</span>\n                                <span class=\"nightclub-value-desc\">单</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                <div class=\"nightclub-section\">\n                    <div class=\"nightclub-section-header\" data-section=\"workshop\">\n                        <span>🎓 工坊培养状况</span>\n                        <span>▼</span>\n                    </div>\n                    <div class=\"nightclub-section-content\" data-section=\"workshop\">\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">当前培养人数</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main nightclub-highlight\" id=\"nc-workshop-count\">0</span>\n                                <span class=\"nightclub-value-desc\">人</span>\n                            </div>\n                        </div>\n                        <div id=\"nc-trainees-container\"></div>\n                    </div>\n                </div>\n                \n                <div class=\"nightclub-section\">\n                    <div class=\"nightclub-section-header\" data-section=\"archive\">\n                        <span>📚 已归档艺人</span>\n                        <span>▼</span>\n                    </div>\n                    <div class=\"nightclub-section-content\" data-section=\"archive\">\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">归档总数</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main\" id=\"nc-archive-count\">0</span>\n                                <span class=\"nightclub-value-desc\">人</span>\n                            </div>\n                        </div>\n                        <div id=\"nc-archive-container\" class=\"nightclub-archive-grid\"></div>\n                    </div>\n                </div>\n                \n                <div class=\"nightclub-section\">\n                    <div class=\"nightclub-section-header\" data-section=\"media\">\n                        <span>🎬 鹿忧传媒联系</span>\n                        <span>▼</span>\n                    </div>\n                    <div class=\"nightclub-section-content\" data-section=\"media\">\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">可调派艺人</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main\" id=\"nc-media-available\">0</span>\n                                <span class=\"nightclub-value-desc\">人</span>\n                            </div>\n                        </div>\n                        <div class=\"nightclub-property\">\n                            <div class=\"nightclub-property-name\">本月已调派</div>\n                            <div class=\"nightclub-property-value\">\n                                <span class=\"nightclub-value-main\" id=\"nc-media-dispatched\">0</span>\n                                <span class=\"nightclub-value-desc\">人</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n`;\n\n// ==================== 工具函数 ====================\nfunction SafeGetValue(obj, path, defaultValue = 'N/A') {\n  const keys = Array.isArray(path) ? path : path.split('.');\n  let current = obj;\n  for (let i = 0; i < keys.length; i++) {\n    if (!current || typeof current !== 'object' || !current.hasOwnProperty(keys[i])) {\n      return defaultValue;\n    }\n    current = current[keys[i]];\n  }\n  if (current === undefined || current === null) {\n    return defaultValue;\n  }\n  if (Array.isArray(current)) {\n    return current.length > 0 ? String(current[0]) : defaultValue;\n  }\n  return String(current);\n}\n\nfunction getProgressColor(value) {\n  if (value < 40) return 'nightclub-progress-low';\n  if (value < 70) return 'nightclub-progress-mid';\n  return 'nightclub-progress-high';\n}\n\n// ==================== 数据加载函数 ====================\nasync function loadNightclubData() {\n  try {\n    if (typeof Mvu === 'undefined') {\n      if (window.parent && typeof window.parent.Mvu !== 'undefined') {\n        window.Mvu = window.parent.Mvu;\n        console.log('✅ 已从父窗口引用 MVU');\n      } else if (window.top && typeof window.top.Mvu !== 'undefined') {\n        window.Mvu = window.top.Mvu;\n        console.log('✅ 已从顶层窗口引用 MVU');\n      } else {\n        console.error('❌ MVU 框架未加载');\n        return null;\n      }\n    }\n\n    let targetMessageId = 'latest';\n    if (typeof getLastMessageId === 'function') {\n      targetMessageId = getLastMessageId();\n      console.log('📍 使用消息 ID:', targetMessageId);\n    }\n\n    const mvuResult = Mvu.getMvuData({\n      type: 'message',\n      message_id: targetMessageId,\n    });\n    const characterData = mvuResult?.stat_data;\n\n    if (!characterData) {\n      console.error('❌ stat_data 不存在');\n      return null;\n    }\n\n    console.log('✅ 成功加载夜总会数据', characterData);\n    return characterData;\n  } catch (error) {\n    console.error('❌ 加载数据出错:', error);\n    return null;\n  }\n}\n\nfunction updateNightclubDisplay(data) {\n  if (!data) {\n    document.getElementById('nightclub-panel-body').innerHTML = '<div class=\"nightclub-error\">无法加载状态数据</div>';\n    return;\n  }\n\n  document.getElementById('nc-time-date').textContent = SafeGetValue(data, '时间信息.当前日期', '未设置');\n  document.getElementById('nc-time-clock').textContent = SafeGetValue(data, '时间信息.当前时间', '--:--');\n  document.getElementById('nc-location').textContent = SafeGetValue(data, '地点信息.当前位置', '未知');\n  document.getElementById('nc-status').textContent = SafeGetValue(data, '时间信息.营业状态', '未知');\n\n  document.getElementById('nc-revenue').textContent = SafeGetValue(data, '夜总会经营.本月营收', '0');\n  document.getElementById('nc-employees').textContent = SafeGetValue(data, '夜总会经营.在职员工数', '0');\n  document.getElementById('nc-vip').textContent = SafeGetValue(data, '夜总会经营.VIP客户数', '0');\n\n  const orders = data['夜总会经营'] && data['夜总会经营']['待处理订单'];\n  document.getElementById('nc-orders').textContent = Array.isArray(orders) ? orders.length : '0';\n\n  document.getElementById('nc-workshop-count').textContent = SafeGetValue(data, '工坊培养对象.当前培养人数', '0');\n  document.getElementById('nc-archive-count').textContent = SafeGetValue(data, '已归档艺人.总数', '0');\n  document.getElementById('nc-media-available').textContent = SafeGetValue(data, '鹿忧传媒联系.可调派艺人数', '0');\n  document.getElementById('nc-media-dispatched').textContent = SafeGetValue(data, '鹿忧传媒联系.本月已调派', '0');\n\n  updateTraineesDisplay(data);\n  updateArchiveDisplay(data);\n}\n\nfunction updateTraineesDisplay(data) {\n  const container = document.getElementById('nc-trainees-container');\n  const trainees = data['工坊培养对象'] && data['工坊培养对象']['培养列表'];\n\n  if (!container || !Array.isArray(trainees)) return;\n\n  container.innerHTML = '';\n\n  trainees.forEach(trainee => {\n    const name = SafeGetValue(trainee, '姓名', '未知');\n    const id = SafeGetValue(trainee, '编号', '');\n    const days = SafeGetValue(trainee, '基本信息.培养天数', '0');\n    const target = SafeGetValue(trainee, '定制信息.目标形象', '未定');\n    const status = SafeGetValue(trainee, '当前状态', '');\n    const order = SafeGetValue(trainee, '定制信息.对应订单', '无');\n\n    const etiquette = parseFloat(SafeGetValue(trainee, '培养进度.社交礼仪', '0'));\n    const talent = parseFloat(SafeGetValue(trainee, '培养进度.才艺培养', '0'));\n    const skill = parseFloat(SafeGetValue(trainee, '培养进度.性爱技巧', '0'));\n    const body = parseFloat(SafeGetValue(trainee, '培养进度.形体改造', '0'));\n    const overall = parseFloat(SafeGetValue(trainee, '培养进度.综合完成度', '0'));\n\n    const card = document.createElement('div');\n    card.className = 'nightclub-trainee-card';\n    card.innerHTML = `\n            <div class=\"nightclub-trainee-header\">\n                <div>\n                    <span class=\"nightclub-trainee-name\">${name}</span>\n                    <span class=\"nightclub-trainee-id\">（编号: ${id}）</span>\n                </div>\n                <div class=\"nightclub-trainee-info\">培养 ${days} 天</div>\n            </div>\n            <div class=\"nightclub-trainee-info\">🎯 目标: ${target}${order !== '无' ? ` | 📝 订单: ${order}` : ''}</div>\n            <div class=\"nightclub-trainee-info\">📍 ${status}</div>\n            <div style=\"margin-top: 10px;\">\n                <div class=\"nightclub-trainee-info\">社交礼仪: ${etiquette}%</div>\n                <div class=\"nightclub-progress-container\">\n                    <div class=\"nightclub-progress-bar ${getProgressColor(\n                      etiquette,\n                    )}\" style=\"width: ${etiquette}%\"></div>\n                </div>\n                <div class=\"nightclub-trainee-info\" style=\"margin-top: 6px;\">才艺培养: ${talent}%</div>\n                <div class=\"nightclub-progress-container\">\n                    <div class=\"nightclub-progress-bar ${getProgressColor(talent)}\" style=\"width: ${talent}%\"></div>\n                </div>\n                <div class=\"nightclub-trainee-info\" style=\"margin-top: 6px;\">性爱技巧: ${skill}%</div>\n                <div class=\"nightclub-progress-container\">\n                    <div class=\"nightclub-progress-bar ${getProgressColor(skill)}\" style=\"width: ${skill}%\"></div>\n                </div>\n                <div class=\"nightclub-trainee-info\" style=\"margin-top: 6px;\">形体改造: ${body}%</div>\n                <div class=\"nightclub-progress-container\">\n                    <div class=\"nightclub-progress-bar ${getProgressColor(body)}\" style=\"width: ${body}%\"></div>\n                </div>\n                <div class=\"nightclub-trainee-info\" style=\"margin-top: 8px; font-weight: bold;\">\n                    综合完成度: <span class=\"nightclub-highlight\">${overall}%</span>\n                </div>\n            </div>\n        `;\n    container.appendChild(card);\n  });\n}\n\nfunction updateArchiveDisplay(data) {\n  const container = document.getElementById('nc-archive-container');\n  const archives = data['已归档艺人'] && data['已归档艺人']['档案列表'];\n\n  if (!container || !Array.isArray(archives)) return;\n\n  container.innerHTML = '';\n\n  archives.slice(0, 6).forEach(artist => {\n    const name = SafeGetValue(artist, '艺名', '未知');\n    const type = SafeGetValue(artist, '类型', '');\n    const status = SafeGetValue(artist, '当前状态', '');\n\n    const item = document.createElement('div');\n    item.className = 'nightclub-archive-item';\n    item.innerHTML = `\n            <div class=\"nightclub-archive-name\">${name}</div>\n            <div class=\"nightclub-archive-details\">${type}</div>\n            <div class=\"nightclub-archive-details\">${status}</div>\n        `;\n    container.appendChild(item);\n  });\n\n  if (archives.length > 6) {\n    const more = document.createElement('div');\n    more.className = 'nightclub-archive-item';\n    more.style.color = '#aaa';\n    more.innerHTML = `<div>还有 ${archives.length - 6} 人...</div>`;\n    container.appendChild(more);\n  }\n}\n\n// ==================== 拖动功能 ====================\nfunction initDraggable() {\n  const btn = document.getElementById('nightclub-toggle-btn');\n  if (!btn) return;\n\n  let isDragging = false;\n  let startX, startY, startLeft, startTop;\n  let hasMoved = false;\n\n  function onStart(e) {\n    const touch = e.type === 'touchstart' ? e.touches[0] : e;\n    isDragging = true;\n    hasMoved = false;\n    startX = touch.clientX;\n    startY = touch.clientY;\n    const rect = btn.getBoundingClientRect();\n    startLeft = rect.left;\n    startTop = rect.top;\n    e.preventDefault();\n  }\n\n  function onMove(e) {\n    if (!isDragging) return;\n    const touch = e.type === 'touchmove' ? e.touches[0] : e;\n    const deltaX = touch.clientX - startX;\n    const deltaY = touch.clientY - startY;\n\n    if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {\n      hasMoved = true;\n    }\n\n    const newLeft = startLeft + deltaX;\n    const newTop = startTop + deltaY;\n\n    const maxX = window.innerWidth - btn.offsetWidth;\n    const maxY = window.innerHeight - btn.offsetHeight;\n\n    btn.style.left = Math.max(0, Math.min(newLeft, maxX)) + 'px';\n    btn.style.top = Math.max(0, Math.min(newTop, maxY)) + 'px';\n    btn.style.right = 'auto';\n    btn.style.bottom = 'auto';\n\n    e.preventDefault();\n  }\n\n  function onEnd(e) {\n    if (isDragging && !hasMoved) {\n      togglePanel();\n    }\n    isDragging = false;\n    hasMoved = false;\n  }\n\n  btn.addEventListener('mousedown', onStart);\n  document.addEventListener('mousemove', onMove);\n  document.addEventListener('mouseup', onEnd);\n\n  btn.addEventListener('touchstart', onStart, { passive: false });\n  document.addEventListener('touchmove', onMove, { passive: false });\n  document.addEventListener('touchend', onEnd);\n}\n\n// ==================== 面板控制 ====================\nfunction togglePanel() {\n  const panel = document.getElementById('nightclub-main-panel');\n  if (!panel) return;\n\n  if (panel.classList.contains('active')) {\n    panel.classList.remove('active');\n  } else {\n    panel.classList.add('active');\n    loadNightclubData().then(data => {\n      if (data) updateNightclubDisplay(data);\n    });\n  }\n}\n\nfunction closePanel() {\n  const panel = document.getElementById('nightclub-main-panel');\n  if (panel) {\n    panel.classList.remove('active');\n  }\n}\n\nfunction toggleSection(header) {\n  const content = header.nextElementSibling;\n  const arrow = header.querySelector('span:last-child');\n  if (!content || !arrow) return;\n\n  const isExpanded = content.classList.toggle('expanded');\n  header.classList.toggle('expanded', isExpanded);\n  arrow.textContent = isExpanded ? '▲' : '▼';\n}\n\n// ==================== 初始化函数 ====================\nfunction initializeNightclubPlugin() {\n  console.log('🏗️ 初始化江畔夜总会插件...');\n\n  if (document.getElementById('nightclub-status-plugin')) {\n    console.log('⚠️ 插件已存在，跳过初始化');\n    return;\n  }\n\n  const styleElement = document.createElement('div');\n  styleElement.innerHTML = styles;\n  document.head.appendChild(styleElement.firstElementChild);\n\n  const pluginContainer = document.createElement('div');\n  pluginContainer.innerHTML = html;\n  document.body.appendChild(pluginContainer.firstElementChild);\n\n  document.getElementById('nightclub-close-btn').addEventListener('click', closePanel);\n\n  document.querySelectorAll('.nightclub-section-header').forEach(header => {\n    header.addEventListener('click', () => toggleSection(header));\n  });\n\n  const mainPanel = document.getElementById('nightclub-main-panel');\n  if (mainPanel) {\n    mainPanel.addEventListener('click', e => {\n      if (e.target === mainPanel) {\n        closePanel();\n      }\n    });\n  }\n\n  initDraggable();\n\n  console.log('✅ 江畔夜总会插件初始化完成');\n}\n\n// ==================== jQuery 等待函数 ====================\nfunction waitForJQuery(callback) {\n  if (typeof jQuery !== 'undefined') {\n    jQuery(document).ready(() => {\n      callback();\n    });\n  } else {\n    setTimeout(() => waitForJQuery(callback), 100);\n  }\n}\n\n// ==================== 启动插件 ====================\nwaitForJQuery(() => {\n  console.log('🚀 启动江畔夜总会插件');\n  initializeNightclubPlugin();\n});\n\nconsole.log('✨ 江畔夜总会插件脚本加载完成');",
  "info": "江畔夜总会管理面板 - 动态显示经营状况、工坊培养进度、已归档艺人等信息",
  "button": {
    "enabled": true,
    "buttons": []
  },
  "data": {}
}
