{
  "type": "script",
  "enabled": true,
  "name": "æ‚¬æµ®çŠ¶æ€æ è„šæœ¬",
  "id": "8bb6240c-e3ad-4729-ba07-4233af3b24b3",
  "content": "// ==================== æŒä¸Šå…¬å¯“ - SillyTavern æ’ä»¶ç‰ˆ ====================\n// å®Œæ•´åŠŸèƒ½çš„å…¬å¯“ç®¡ç†ç³»ç»Ÿï¼Œå¸¦å¯æ‹–åŠ¨æŒ‰é’®\n// ç‰ˆæœ¬ï¼šåŠ¨æ€æ‰©å±•ç‰ˆ\n\nconsole.log('ğŸ¢ åŠ è½½æŒä¸Šå…¬å¯“æ’ä»¶...');\n\n// ==================== æ ·å¼å®šä¹‰ ====================\nconst styles = `\n<style id=\"apartment-plugin-styles\">\n/* ==================== å…¨å±€æ ·å¼ ==================== */\n* { \n    margin: 0; \n    padding: 0; \n    box-sizing: border-box;\n}\n\n/* æ”¯æŒåˆ˜æµ·å±ç­‰å®‰å…¨åŒºåŸŸ - ä»…åœ¨å°å±å¹•åº”ç”¨ */\n@media (max-width: 768px) {\n    @supports (padding: max(0px)) {\n        .apartment-main-panel {\n            padding-top: max(0px, env(safe-area-inset-top)) !important;\n            padding-bottom: max(0px, env(safe-area-inset-bottom)) !important;\n            padding-left: max(0px, env(safe-area-inset-left)) !important;\n            padding-right: max(0px, env(safe-area-inset-right)) !important;\n        }\n    }\n}\n\n.no-select { \n    user-select: none; \n    -webkit-user-select: none; \n    -moz-user-select: none; \n    -ms-user-select: none; \n}\n\n/* ç§»é™¤æ‰€æœ‰æŒ‰é’®å’Œå¯äº¤äº’å…ƒç´ çš„ç„¦ç‚¹æ¡† */\nbutton:focus,\nbutton:active,\n.actionable:focus,\n.actionable:active,\n.room-card:focus,\n.room-card:active,\n.dock-button:focus,\n.dock-button:active,\n.zoom-btn:focus,\n.zoom-btn:active,\n.confirm-btn:focus,\n.confirm-btn:active,\n.add-floor-btn:focus,\n.add-floor-btn:active,\n.add-room-btn:focus,\n.add-room-btn:active {\n    outline: none !important;\n    -webkit-tap-highlight-color: transparent !important;\n}\n\n/* ç§»é™¤ç§»åŠ¨ç«¯è§¦æ‘¸é«˜äº® */\n* {\n    -webkit-tap-highlight-color: transparent;\n    -webkit-touch-callout: none;\n}\n\n/* æ€§èƒ½ä¼˜åŒ– - ä»…å¯¹æ‹–åŠ¨å…ƒç´ ä½¿ç”¨ */\n#apartment-canvas {\n    -webkit-transform: translateZ(0);\n    transform: translateZ(0);\n}\n\n/* æ‹–åŠ¨æ—¶ç¦ç”¨æ–‡æœ¬é€‰æ‹© */\n.canvas-viewport {\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    -ms-user-select: none;\n    user-select: none;\n}\n\n:root { \n    --theme-phone-bg: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%); \n    --theme-phone-bg-solid: #f8f9fa;\n    --theme-text-color: #2c3e50; \n    --theme-border-color: #dee2e6; \n    --theme-container-bg: #ffffff; \n    --theme-subtitle-color: #6c757d; \n    --theme-header-bg: linear-gradient(135deg, #6c8cdc 0%, #8b7bb8 100%);\n    --theme-dock-bg: rgba(255, 255, 255, 0.95); \n    --theme-modal-btn-bg: #f8f9fa; \n    --theme-input-bg: #ffffff;\n    --theme-input-text: #2c3e50;\n    --color-fixed: #fff9e6; \n    --color-bedroom-empty: #f8e8e8;\n    --color-bedroom-occupied: #ffd4d4;\n    --color-functional: #e6f2ff; \n    --color-empty: #f0f0f0; \n    --color-outdoor: #e8f5e9; \n    --color-pending: #fff8e1;\n    --color-danger: #ffe0e0; \n    --your-room-bg: #e1f5fe; \n    --progress-bar-bg: #e9ecef; \n    --progress-bar-favor-fill: #ff8a80; \n    --progress-bar-lust-fill: #ff80ab; \n    --color-add-room: #e8f5e9; \n}\n\n.dark-theme { \n    --theme-phone-bg: linear-gradient(180deg, #1e2530 0%, #2a3441 100%); \n    --theme-phone-bg-solid: #1e2530;\n    --theme-text-color: #e8eaed; \n    --theme-border-color: #4a5568; \n    --theme-container-bg: #2a3441; \n    --theme-subtitle-color: #9ca3af;\n    --theme-header-bg: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); \n    --theme-dock-bg: rgba(42, 52, 65, 0.95); \n    --theme-modal-btn-bg: #374151; \n    --theme-input-bg: #1e2530;\n    --theme-input-text: #e8eaed;\n    --color-fixed: #4a4332; \n    --color-bedroom-empty: #3d3338;\n    --color-bedroom-occupied: #4a3333;\n    --color-functional: #2d3d52; \n    --color-empty: #363d47; \n    --color-outdoor: #354237;\n    --color-pending: #4a4636; \n    --color-danger: #5a3333; \n    --your-room-bg: #2d4550; \n    --progress-bar-bg: #374151; \n    --progress-bar-favor-fill: #ef4444; \n    --progress-bar-lust-fill: #ec4899; \n    --color-add-room: #354237; \n}\n\n/* ==================== æ‹–åŠ¨æŒ‰é’® ==================== */\n.apartment-toggle-btn {\n    position: fixed !important;\n    top: 100px;\n    left: 20px;\n    width: 64px;\n    height: 64px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    cursor: grab;\n    z-index: 10000 !important;\n    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n    user-select: none;\n    -webkit-user-select: none;\n    touch-action: none;\n    font-size: 28px;\n    border: 3px solid rgba(255, 255, 255, 0.3);\n}\n\n.apartment-toggle-btn.dragging {\n    cursor: grabbing !important;\n    opacity: 0.9;\n    z-index: 10001 !important;\n}\n\n/* ç§»åŠ¨ç«¯ä¼˜åŒ– */\n@media (max-width: 768px) {\n    .apartment-toggle-btn {\n        width: 56px;\n        height: 56px;\n        font-size: 24px;\n        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);\n    }\n}\n\n@media (max-width: 480px) {\n    .apartment-toggle-btn {\n        /* ğŸ”§ ç¡®ä¿æŒ‰é’®åœ¨å°å±å¹•ä¸‹ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ */\n        z-index: 10002 !important;\n        pointer-events: auto !important;\n    }\n}\n\n/* ==================== ä¸»ç•Œé¢å®¹å™¨ ==================== */\n.apartment-main-panel {\n    position: fixed !important;\n    top: 50vh !important;\n    left: 50vw !important;\n    transform: translate(-50%, -50%) !important;\n    width: 90vw !important;\n    max-width: 900px !important;\n    height: 85vh !important;\n    max-height: 650px !important;\n    min-height: 400px !important;\n    min-width: 320px !important;\n    background: var(--theme-phone-bg-solid);\n    border: 12px solid transparent;\n    background-clip: padding-box;\n    border-radius: 32px;\n    box-shadow: \n        0 0 0 1px rgba(0, 0, 0, 0.1),\n        0 24px 64px rgba(0, 0, 0, 0.4),\n        0 0 80px rgba(102, 126, 234, 0.2);\n    z-index: 999 !important;\n    display: none;\n    flex-direction: column;\n    overflow: hidden;\n    color: var(--theme-text-color);\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;\n    backdrop-filter: blur(20px);\n}\n\n.apartment-main-panel::before {\n    content: '';\n    position: absolute;\n    inset: 0;\n    background: var(--theme-phone-bg);\n    border-radius: 20px;\n    z-index: -1;\n}\n\n.apartment-main-panel.active {\n    display: flex;\n}\n\n/* ==================== ç§»åŠ¨ç«¯å“åº”å¼ ==================== */\n/* 481px - 768pxï¼šå¹³æ¿å¤§å° */\n@media (min-width: 481px) and (max-width: 768px) {\n    .apartment-main-panel {\n        top: 8vh !important;\n        left: 5vw !important;\n        transform: none !important;\n        width: 90vw !important;\n        height: 84vh !important;\n        max-width: none !important;\n        max-height: none !important;\n        min-width: 0 !important;\n        min-height: 0 !important;\n        border-radius: 20px !important;\n    }\n}\n\n/* 480pxä»¥ä¸‹ï¼šæ‰‹æœºå¤§å° */\n@media (max-width: 480px) {\n    .apartment-main-panel {\n        position: fixed !important;\n        top: 3vh !important;\n        left: 2.5vw !important;\n        transform: none !important;\n        width: 95vw !important;\n        /* ğŸ”§ ç®€åŒ–é«˜åº¦è®¡ç®—ï¼Œç¡®ä¿ç¨³å®šæ˜¾ç¤º */\n        height: 88vh !important;\n        max-width: none !important;\n        max-height: 92vh !important;\n        min-width: 0 !important;\n        min-height: 0 !important;\n        border-radius: 16px !important;\n        z-index: 999 !important;\n    }\n    \n    /* ğŸ”§ åªåœ¨activeæ—¶è®¾ç½®flexï¼Œé¿å…è¦†ç›–æ˜¾ç¤º/éšè—é€»è¾‘ */\n    .apartment-main-panel.active {\n        display: flex !important;\n        flex-direction: column !important;\n    }\n    \n    .apartment-main-panel::before {\n        border-radius: 12px !important;\n    }\n}\n\n/* ==================== å¤´éƒ¨ ==================== */\n.mobile-header { \n    flex-shrink: 0; \n    padding: 16px 20px;\n    background: var(--theme-header-bg);\n    border-bottom: none;\n    display: flex; \n    justify-content: space-between; \n    align-items: center; \n    font-size: 0.9em; \n    position: relative; \n    z-index: 20;\n    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);\n    color: white;\n    min-height: 56px;\n}\n\n.mobile-header > div:first-child {\n    font-weight: 600;\n    letter-spacing: 0.3px;\n}\n\n#mode-display { \n    font-weight: 700; \n    padding: 6px 14px; \n    border-radius: 20px;\n    font-size: 0.9em;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\n}\n\n#mode-display.observation-mode { \n    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);\n    color: #2c3e50; \n}\n\n#mode-display.build-mode { \n    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);\n    color: white;\n}\n\n@media (max-width: 768px) {\n    .mobile-header {\n        padding: 12px 16px;\n        font-size: 0.85em;\n        min-height: 52px;\n    }\n    \n    #mode-display {\n        padding: 5px 12px;\n        font-size: 0.85em;\n    }\n}\n\n@media (max-width: 480px) {\n    .mobile-header {\n        padding: 10px 12px;\n        font-size: 0.75em;\n        min-height: 48px;\n        flex-shrink: 0 !important;\n    }\n    \n    .mobile-header > div:first-child {\n        font-size: 0.95em;\n    }\n    \n    #mode-display {\n        padding: 4px 10px;\n        font-size: 0.8em;\n    }\n    \n    /* ğŸ”§ ç¡®ä¿ç”»å¸ƒè§†å£èƒ½æ­£ç¡®flex */\n    .canvas-viewport {\n        flex: 1 1 auto !important;\n        min-height: 0 !important;\n        overflow: auto !important;\n    }\n}\n\n/* ==================== ç”»å¸ƒè§†å£ ==================== */\n.canvas-viewport { \n    flex-grow: 1; \n    position: relative; \n    overflow: auto; \n    min-height: 0; \n    border-radius: 20px; \n    cursor: grab;\n}\n\n.canvas-viewport:active { \n    cursor: grabbing; \n}\n\n/* ç¡®ä¿æ»šåŠ¨æ¡æ ·å¼ç¾è§‚ */\n.canvas-viewport::-webkit-scrollbar {\n    width: 8px;\n    height: 8px;\n}\n\n.canvas-viewport::-webkit-scrollbar-track {\n    background: rgba(0, 0, 0, 0.1);\n    border-radius: 4px;\n}\n\n.canvas-viewport::-webkit-scrollbar-thumb {\n    background: rgba(102, 126, 234, 0.5);\n    border-radius: 4px;\n}\n\n.canvas-viewport::-webkit-scrollbar-thumb:hover {\n    background: rgba(102, 126, 234, 0.7);\n}\n\n#apartment-canvas { \n    position: absolute; \n    left: 50%; \n    top: 50%; \n    transform: translate(-50%, -50%) scale(1); \n    transform-origin: center center;\n    display: flex; \n    flex-direction: column; \n    align-items: stretch; \n    gap: 10px;\n    min-width: 1515px;\n}\n\n/* ç¼©æ”¾æ—¶æ·»åŠ å¹³æ»‘è¿‡æ¸¡ */\n#apartment-canvas.zooming {\n    transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);\n}\n\n/* ==================== åº•éƒ¨å·¥å…·æ  ==================== */\n.mobile-footer { \n    flex-shrink: 0; \n    padding: 12px 8px; \n    background: var(--theme-dock-bg);\n    backdrop-filter: blur(20px) saturate(180%); \n    border-top: 1px solid rgba(0, 0, 0, 0.05);\n    display: flex; \n    justify-content: space-around; \n    align-items: center; \n    z-index: 20; \n    overflow-x: auto; \n    overflow-y: hidden; \n    gap: 4px;\n    box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.08);\n    min-height: 60px;\n    /* ğŸ”§ ç§»åŠ¨ç«¯åº•éƒ¨å®‰å…¨åŒºåŸŸé€‚é…ï¼ˆé˜²æ­¢è¢«æµè§ˆå™¨å·¥å…·æ é®æŒ¡ï¼‰ */\n    padding-bottom: max(12px, env(safe-area-inset-bottom, 12px));\n}\n\n.dock-button { \n    display: flex; \n    flex-direction: column; \n    align-items: center; \n    gap: 4px; \n    cursor: pointer; \n    background: transparent; \n    border: none;\n    color: var(--theme-subtitle-color); \n    font-size: 11px; \n    font-family: inherit; \n    min-width: 60px; \n    flex: 1; \n    max-width: 85px; \n    padding: 8px 4px;\n    border-radius: 12px;\n    position: relative;\n}\n\n@media (max-width: 768px) {\n    .dock-button { \n        font-size: 10px; \n        min-width: 52px; \n        padding: 6px 2px; \n    }\n}\n\n@media (max-width: 480px) {\n    .mobile-footer {\n        padding: 8px 4px;\n        min-height: 56px;\n        flex-shrink: 0 !important;\n        /* ğŸ”§ æ‰‹æœºç«¯å¢åŠ æ›´å¤šåº•éƒ¨å®‰å…¨é—´è·ï¼ˆé˜²æ­¢è¢«å·¥å…·æ é®æŒ¡ï¼‰ */\n        padding-bottom: max(16px, calc(env(safe-area-inset-bottom, 0px) + 8px));\n    }\n    \n    .dock-button { \n        font-size: 9px; \n        min-width: 44px; \n        padding: 5px 1px;\n        gap: 2px;\n    }\n    .dock-button-icon { \n        font-size: 18px !important; \n    }\n    .dock-button span:not(.dock-button-icon) { \n        font-size: 8px;\n        line-height: 1.2;\n    }\n}\n\n.dock-button:disabled { \n    color: #999 !important;\n    cursor: not-allowed;\n    opacity: 0.5; \n} \n\n.dock-button-icon { \n    font-size: 26px;\n}\n\n.dock-button.active {\n    color: #667eea;\n    background: rgba(102, 126, 234, 0.12);\n}\n\n.dock-button.active .dock-button-icon { \n    color: #667eea;\n}\n\n/* ==================== æ¥¼å±‚å’Œæˆ¿é—´ ==================== */\n.above-ground-wrapper { \n    display: grid; \n    grid-template-columns: 200px 1fr 200px; \n    align-items: end; \n    gap: 20px;\n    padding: 20px 20px 0 20px; \n}\n\n.basement-wrapper { \n    display: grid; \n    grid-template-columns: 200px 1fr 200px; \n    gap: 20px;\n    padding: 0 20px 20px 20px; \n}\n\n.indoor-levels { \n    display: flex; \n    flex-direction: column; \n    gap: 20px;\n}\n\n.level { \n    background-color: var(--theme-container-bg); \n    border-radius: 12px; \n    box-shadow: 0 4px 12px rgba(0,0,0,0.06); \n    padding: 15px;\n    border: 1px solid var(--theme-border-color); \n    display: flex; \n    flex-direction: column; \n    width: 1275px; \n    box-sizing: border-box;\n}\n\n.level-title { \n    font-size: 1.2em; \n    font-weight: 600; \n    margin: 0 0 15px 5px;\n    color: var(--theme-text-color); \n    flex-shrink: 0; \n}\n\n.room-grid { \n    display: flex; \n    gap: 10px; \n    flex: 1; \n    align-items: stretch; \n}\n\n.room-card { \n    flex-shrink: 0;\n    flex-basis: 0; \n    border-radius: 12px; \n    padding: 16px 12px; \n    min-height: 80px;\n    min-width: 80px; \n    display: flex; \n    flex-direction: column; \n    justify-content: center; \n    align-items: center; \n    text-align: center;\n    font-weight: 600; \n    font-size: 0.9em; \n    border: 2px solid rgba(255, 255, 255, 0.3); \n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);\n    position: relative;\n    overflow: hidden;\n}\n\n/* ç§»é™¤ä¸å¿…è¦çš„::beforeä¼ªå…ƒç´ ä»¥æå‡æ€§èƒ½ */\n\n.size-2 { flex-grow: 2; }\n.size-3 { flex-grow: 3; }\n.size-6 { flex-grow: 6; }\n\n.room-card.actionable { \n    cursor: pointer;\n}\n\n@media (max-width: 768px) {\n    .room-card {\n        padding: 12px 8px;\n        min-height: 70px;\n        min-width: 70px;\n        font-size: 0.85em;\n    }\n}\n\n.placeholder { \n    visibility: hidden; \n}\n\n.fixed-room { \n    background: var(--color-fixed);\n}\n\n.fixed-room .room-name::before {\n    content: 'ğŸ›ï¸ ';\n}\n\n.outdoor-room { \n    background: var(--color-outdoor); \n}\n\n.outdoor-room .room-name::before {\n    content: 'ğŸŒ³ ';\n}\n\n.empty-room { \n    background: var(--color-empty);\n    position: relative;\n}\n\n.empty-room::after {\n    content: 'ğŸšï¸';\n    display: block;\n    font-size: 1.8em;\n    opacity: 0.35;\n    margin-top: 4px;\n}\n\n.empty-room .room-name::after {\n    content: ' (ç©ºç½®)';\n    font-size: 0.85em;\n    opacity: 0.7;\n    font-weight: 400;\n}\n\n.bedroom-room { \n    background: var(--color-bedroom-empty);\n}\n\n.bedroom-room .room-name::before {\n    content: 'ğŸ›ï¸ ';\n}\n\n/* å·²ä½äººçš„å§å®¤ä½¿ç”¨æ›´æ·±çš„é¢œè‰² */\n.bedroom-room[data-occupant]:not([data-occupant=\"\"]):not([data-occupant=\"æœªçŸ¥\"]) {\n    background: var(--color-bedroom-occupied);\n}\n\n.your-room { \n    background: var(--your-room-bg); \n}\n\n.your-room .room-name::before {\n    content: '';\n}\n\n.functional-room { \n    background: var(--color-functional); \n}\n\n.functional-room .room-name::before {\n    content: 'ğŸ¨ ';\n}\n\n.pending-decoration { \n    background-color: var(--color-pending); \n    border-style: dashed;\n}\n\n.pending-eviction { \n    background-color: var(--color-danger); \n    border-style: dotted; \n    color: #721c24; \n}\n\n.pending-demolition { \n    background-color: var(--color-danger); \n    border-style: dashed;\n    color: #721c24; \n}\n\n.room-name { \n    font-weight: bold; \n}\n\n.room-occupant { \n    font-size: 0.8em; \n    color: var(--theme-subtitle-color); \n    margin-top: 5px; \n}\n\n.add-room-card { \n    background: var(--color-add-room); \n    border: 2px dashed #96c47c; \n    font-size: 2em; \n    color: #2d5016;\n}\n\n.add-floor-btn { \n    width: 100%; \n    min-width: 1515px; \n    padding: 14px 16px; \n    background: var(--color-add-room); \n    border: 2px dashed #96c47c; \n    border-radius: 12px; \n    cursor: pointer; \n    font-weight: 700; \n    color: #2d5016;\n    font-size: 1em; \n    display: block; \n    box-sizing: border-box;\n}\n\n.add-room-btn { \n    width: 100%; \n    padding: 12px 16px; \n    background: var(--color-add-room); \n    border: 2px dashed #96c47c; \n    border-radius: 12px; \n    cursor: pointer; \n    font-weight: 700; \n    margin: 12px 0; \n    color: #2d5016;\n    font-size: 0.95em; \n    display: block; \n    box-sizing: border-box;\n}\n\n@media (max-width: 768px) {\n    .add-floor-btn,\n    .add-room-btn {\n        padding: 10px 12px;\n        font-size: 0.9em;\n    }\n}\n\n.slot-indicator { \n    font-size: 0.7em; \n    color: var(--theme-subtitle-color); \n    margin-top: 3px; \n}\n\n.outdoor-room { \n    background-color: var(--color-outdoor); \n    min-height: 100%; \n}\n\n.floor-wrapper { \n    display: flex; \n    align-items: stretch; \n    width: 100%; \n    min-width: 1515px; \n}\n\n.floor-outdoor-left { \n    width: 120px; \n    flex-shrink: 0; \n    display: flex; \n    flex-direction: column; \n}\n\n.floor-outdoor-right { \n    width: 120px; \n    flex-shrink: 0; \n    display: flex; \n    flex-direction: column; \n}\n\n.floor-main { \n    flex: 1; \n    display: flex; \n    justify-content: center; \n    align-items: stretch; \n}\n\n.outdoor-card { \n    width: 100%; \n    flex: 1; \n    display: flex; \n    flex-direction: column; \n    align-items: center; \n    justify-content: center; \n    text-align: center; \n    padding: 10px; \n    font-size: 0.85em; \n}\n\n/* ==================== æµ®åŠ¨UI ==================== */\n.floating-ui { \n    position: absolute; \n    bottom: 80px; \n    right: 20px; \n    z-index: 10; \n    display: flex; \n    flex-direction: column; \n    align-items: flex-end;\n    gap: 10px; \n}\n\n@media (max-width: 480px) {\n    .floating-ui {\n        /* ğŸ”§ åœ¨åº•éƒ¨å·¥å…·æ ä¸Šæ–¹ç•™å‡ºå®‰å…¨è·ç¦» */\n        bottom: max(70px, calc(env(safe-area-inset-bottom, 0px) + 70px));\n        right: 10px;\n    }\n}\n\n.zoom-controls { \n    display: flex; \n    flex-direction: column; \n    gap: 5px;\n}\n\n.zoom-btn, .confirm-btn { \n    width: 48px; \n    height: 48px; \n    border-radius: 50%; \n    border: none; \n    background: rgba(102, 126, 234, 0.9);\n    color: white; \n    font-size: 24px; \n    font-weight: 700; \n    cursor: pointer; \n    line-height: 1;\n    box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);\n    backdrop-filter: blur(10px);\n}\n\n.confirm-btn { \n    width: auto;\n    padding: 0 24px; \n    border-radius: 24px; \n    font-size: 16px;\n    background: rgba(86, 171, 47, 0.9);\n}\n\n@media (max-width: 768px) {\n    .zoom-btn, .confirm-btn {\n        width: 44px;\n        height: 44px;\n        font-size: 20px;\n    }\n    \n    .confirm-btn {\n        padding: 0 20px;\n        font-size: 15px;\n    }\n}\n\n/* ==================== æ¨¡æ€æ¡† ==================== */\n.modal-overlay { \n    position: fixed !important; \n    top: 0 !important;\n    left: 0 !important; \n    width: 100vw !important; \n    height: 100vh !important; \n    background: rgba(0, 0, 0, 0.5);\n    backdrop-filter: blur(4px);\n    display: flex; \n    justify-content: center; \n    align-items: center; \n    z-index: 1000 !important;\n    overflow-y: auto;\n    padding: 20px 0;\n}\n\n.modal-content { \n    background: var(--theme-container-bg); \n    color: var(--theme-text-color); \n    padding: 28px; \n    border-radius: 20px; \n    width: 90%; \n    max-width: 420px;\n    max-height: 80vh;\n    overflow-y: auto;\n    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\n    display: flex;\n    flex-direction: column;\n    margin: auto;\n}\n\n.modal-title { \n    margin: 0 0 12px 0;\n    font-size: 1.4em;\n    font-weight: 700;\n}\n\n.modal-subtitle { \n    color: var(--theme-subtitle-color); \n    margin: 0 0 24px 0; \n    font-size: 0.95em;\n    line-height: 1.5;\n}\n\n.modal-choices button, .modal-confirm-btn { \n    display: block;\n    width: 100%; \n    padding: 14px 16px; \n    margin-bottom: 12px; \n    font-size: 1em; \n    font-weight: 600;\n    border-radius: 12px; \n    border: 2px solid transparent; \n    cursor: pointer; \n    background: #667eea;\n    color: white;\n    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);\n}\n\n.modal-choices button:disabled { \n    background: #ccc; \n    color: #666; \n    cursor: not-allowed;\n    box-shadow: none;\n}\n\n@media (max-width: 768px) {\n    .modal-overlay {\n        padding: 10px;\n    }\n    \n    .modal-content {\n        padding: 20px;\n        border-radius: 16px;\n        width: 92%;\n        max-height: 85vh;\n    }\n    \n    .modal-title {\n        font-size: 1.2em;\n    }\n    \n    .modal-subtitle {\n        font-size: 0.9em;\n        margin-bottom: 16px;\n    }\n    \n    .modal-choices button, .modal-confirm-btn {\n        padding: 12px 14px;\n        font-size: 0.95em;\n    }\n}\n\n@media (max-width: 480px) {\n    .modal-overlay {\n        padding: 5px;\n    }\n    \n    .modal-content {\n        padding: 16px;\n        width: 95%;\n        max-height: 90vh;\n        border-radius: 12px;\n    }\n    \n    .modal-title {\n        font-size: 1.1em;\n    }\n    \n    .modal-subtitle {\n        font-size: 0.85em;\n    }\n    \n    .modal-choices button, .modal-confirm-btn {\n        padding: 10px 12px;\n        font-size: 0.9em;\n        margin-bottom: 10px;\n    }\n}\n\n.modal-functional-input { \n    margin-top: 16px; \n}\n\n.modal-functional-input label {\n    display: block;\n    margin-bottom: 8px;\n    font-weight: 600;\n    color: var(--theme-text-color);\n}\n\n.modal-functional-input input, \n.modal-functional-input select { \n    width: 100%; \n    padding: 12px 16px;\n    box-sizing: border-box; \n    border: 2px solid var(--theme-border-color); \n    border-radius: 12px; \n    margin-bottom: 12px; \n    background-color: var(--theme-input-bg) !important; \n    color: var(--theme-input-text) !important;\n    font-size: 1em;\n}\n\n/* ç‰¹åˆ«å¼ºåˆ¶æ‹›å‹Ÿè¾“å…¥æ¡†çš„æ ·å¼ */\n#recruitment-keywords {\n    background-color: var(--theme-input-bg) !important;\n    color: var(--theme-input-text) !important;\n}\n\n/* ç™½å¤©æ¨¡å¼å¼ºåˆ¶ç™½è‰²èƒŒæ™¯ */\n:root #recruitment-keywords,\n:root .modal-functional-input input,\n:root .modal-functional-input select {\n    background-color: #ffffff !important;\n    color: #2c3e50 !important;\n}\n\n:root .modal-functional-input input::placeholder {\n    color: #6c757d !important;\n    opacity: 0.7;\n}\n\n/* å¤œæ™šæ¨¡å¼å¼ºåˆ¶æ·±è‰²èƒŒæ™¯ */\n.dark-theme #recruitment-keywords,\n.dark-theme .modal-functional-input input,\n.dark-theme .modal-functional-input select {\n    background-color: #2a3441 !important;\n    color: #e8eaed !important;\n}\n\n.dark-theme .modal-functional-input input::placeholder {\n    color: #9ca3af !important;\n    opacity: 0.7;\n}\n\n/* WebKitæµè§ˆå™¨å…¼å®¹ */\ninput:-webkit-autofill,\ninput:-webkit-autofill:hover,\ninput:-webkit-autofill:focus {\n    -webkit-text-fill-color: var(--theme-input-text) !important;\n    -webkit-box-shadow: 0 0 0 1000px var(--theme-input-bg) inset !important;\n}\n\n.modal-functional-input input:focus,\n.modal-functional-input select:focus {\n    outline: none;\n    border-color: #667eea;\n}\n\n.hidden { \n    display: none !important; \n}\n\n.danger-btn { \n    background: #eb3b5a !important;\n    color: white !important;\n    box-shadow: 0 2px 8px rgba(235, 59, 90, 0.25);\n}\n\n/* ==================== äº‹ä»¶æ¨¡æ€æ¡† ==================== */\n.event-modal { \n    position: absolute; \n    bottom: 0; \n    left: 0; \n    right: 0; \n    height: 75%; \n    background: var(--theme-container-bg);\n    border-top: none;\n    border-radius: 24px 24px 0 0; \n    z-index: 100; \n    transform: translateY(100%); \n    display: flex;\n    flex-direction: column;\n    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);\n    transition: transform 0.3s ease-out;\n}\n\n.event-modal.visible { \n    transform: translateY(0); \n}\n\n.event-header { \n    padding: 20px; \n    text-align: center;\n    font-weight: 700; \n    font-size: 1.2em;\n    border-bottom: 2px solid var(--theme-border-color); \n    flex-shrink: 0;\n    background: rgba(102, 126, 234, 0.05);\n    cursor: pointer;\n}\n\n.event-body { \n    padding: 20px; \n    overflow-y: auto; \n    flex-grow: 1;\n}\n\n.event-section-title { \n    font-size: 1.2em; \n    font-weight: 700; \n    margin-bottom: 14px; \n    border-left: 5px solid #667eea; \n    padding-left: 12px;\n    color: var(--theme-text-color);\n}\n\n.event-buttons-grid { \n    display: grid; \n    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); \n    gap: 12px;\n}\n\n@media (max-width: 768px) {\n    .event-buttons-grid {\n        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));\n        gap: 10px;\n    }\n}\n\n@media (max-width: 480px) {\n    .event-buttons-grid {\n        grid-template-columns: repeat(2, 1fr);\n    }\n}\n\n.event-button { \n    padding: 16px 12px; \n    font-size: 0.95em; \n    font-weight: 600; \n    border-radius: 12px; \n    border: 2px solid var(--theme-border-color);\n    cursor: pointer; \n    background: var(--theme-modal-btn-bg);\n    color: var(--theme-text-color);\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);\n}\n\n.event-button.random { \n    background: #667eea;\n    color: white;\n    border-color: #667eea;\n    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);\n}\n\n/* ==================== ä¿¡æ¯æ¨¡æ€æ¡†ç¾åŒ– ==================== */\n#info-modal .modal-content {\n    padding: 0;\n    overflow: hidden;\n    max-height: 75vh;\n    display: flex;\n    flex-direction: column;\n    position: relative;\n}\n\n#info-modal-header {\n    padding: 20px 25px;\n    padding-right: 60px; /* ä¸ºå…³é—­æŒ‰é’®ç•™ç©ºé—´ */\n    border-bottom: 1px solid var(--theme-border-color);\n    flex-shrink: 0;\n    position: relative;\n}\n\n/* ğŸ”§ æ·»åŠ å…³é—­æŒ‰é’®æ ·å¼ */\n.modal-close-btn {\n    position: absolute;\n    top: 15px;\n    right: 15px;\n    width: 36px;\n    height: 36px;\n    border-radius: 50%;\n    border: none;\n    background: rgba(0, 0, 0, 0.1);\n    color: var(--theme-text-color);\n    font-size: 24px;\n    line-height: 1;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s;\n    z-index: 10;\n}\n\n.modal-close-btn:hover {\n    background: rgba(235, 59, 90, 0.15);\n    color: #eb3b5a;\n    transform: scale(1.1);\n}\n\n.modal-close-btn:active {\n    transform: scale(0.95);\n}\n\n#info-modal-details {\n    padding: 20px 25px;\n    overflow-y: auto;\n    -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */\n    flex: 1;\n    max-height: calc(75vh - 120px);\n}\n\n/* ç§»åŠ¨ç«¯ä¼˜åŒ– */\n@media (max-width: 768px) {\n    #info-modal .modal-content {\n        max-height: 80vh;\n    }\n    \n    #info-modal-header {\n        padding: 16px 20px;\n        padding-right: 55px;\n    }\n    \n    #info-modal-details {\n        padding: 16px 20px;\n        max-height: calc(80vh - 100px);\n    }\n}\n\n@media (max-width: 480px) {\n    #info-modal .modal-content {\n        max-height: 70vh; /* ğŸ”§ å‡å°é«˜åº¦ï¼Œæ›´æ–¹ä¾¿æ“ä½œ */\n        width: 92%;\n    }\n    \n    #info-modal-header {\n        padding: 14px 16px;\n        padding-right: 50px;\n    }\n    \n    #info-modal-details {\n        padding: 14px 16px;\n        max-height: calc(70vh - 90px);\n    }\n    \n    .modal-close-btn {\n        width: 32px;\n        height: 32px;\n        font-size: 20px;\n        top: 12px;\n        right: 12px;\n    }\n}\n\n#info-modal-details ul {\n    list-style: none;\n    padding: 0;\n    margin: 0;\n}\n\n#info-modal-details li {\n    padding: 8px 0;\n    border-bottom: 1px solid var(--theme-border-color);\n    font-size: 0.95em;\n}\n\n#info-modal-details li:last-child {\n    border-bottom: none;\n}\n\n#info-modal-details li strong {\n    color: var(--theme-subtitle-color);\n    margin-right: 10px;\n    display: inline-block;\n    width: 50px;\n}\n\n#info-modal-details p strong {\n    font-weight: 600;\n    margin-right: 5px;\n}\n\n.progress-bar-container {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    margin: 8px 0;\n}\n\n.progress-bar {\n    flex-grow: 1;\n    height: 14px;\n    background-color: var(--progress-bar-bg);\n    border-radius: 10px;\n    overflow: hidden;\n    position: relative;\n    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);\n}\n\n.progress-bar-fill {\n    height: 100%;\n    width: 0%;\n    border-radius: 10px;\n    position: relative;\n    overflow: hidden;\n}\n\n.progress-bar-favor { \n    background: var(--progress-bar-favor-fill); \n}\n\n.progress-bar-lust { \n    background: var(--progress-bar-lust-fill); \n}\n\n.progress-value {\n    font-weight: 700;\n    font-size: 0.95em;\n    min-width: 35px;\n    text-align: right;\n    color: var(--theme-text-color);\n}\n\n/* ==================== å†å²ã€æˆå°±ã€å…³ç³»æ¨¡æ€æ¡†ä¼˜åŒ– ==================== */\n#history-modal .modal-content,\n#achievement-modal .modal-content,\n#relation-modal .modal-content {\n    max-height: 70vh !important;\n    overflow: hidden !important;\n    display: flex !important;\n    flex-direction: column !important;\n    position: relative !important;\n}\n\n/* ğŸ”§ æ ‡é¢˜åŒºåŸŸæ ·å¼ */\n#history-modal .modal-title,\n#achievement-modal .modal-title,\n#relation-modal .modal-title {\n    padding-right: 50px; /* ä¸ºå…³é—­æŒ‰é’®ç•™ç©ºé—´ */\n    flex-shrink: 0;\n}\n\n/* ğŸ”§ å†…å®¹åŒºåŸŸå¯æ»šåŠ¨ */\n#history-content,\n#achievement-content,\n#relation-content {\n    overflow-y: auto !important;\n    -webkit-overflow-scrolling: touch;\n    flex: 1 !important;\n    padding: 15px !important;\n    max-height: calc(70vh - 80px) !important;\n}\n\n@media (max-width: 768px) {\n    #history-modal .modal-content,\n    #achievement-modal .modal-content,\n    #relation-modal .modal-content {\n        max-height: 75vh !important;\n        width: 95% !important;\n    }\n    \n    #history-content,\n    #achievement-content,\n    #relation-content {\n        padding: 12px !important;\n        font-size: 0.95em;\n        max-height: calc(75vh - 70px) !important;\n    }\n}\n\n@media (max-width: 480px) {\n    #history-modal .modal-content,\n    #achievement-modal .modal-content,\n    #relation-modal .modal-content {\n        max-height: 70vh !important;\n        width: 92% !important;\n    }\n    \n    #history-content,\n    #achievement-content,\n    #relation-content {\n        padding: 10px !important;\n        font-size: 0.9em;\n        max-height: calc(70vh - 65px) !important;\n    }\n}\n\n/* ==================== æ ¼å­é€‰æ‹©å™¨ ==================== */\n.grid-cell {\n    padding: 16px 8px;\n    border: 2px solid var(--theme-border-color);\n    border-radius: 10px;\n    text-align: center;\n    cursor: pointer;\n    user-select: none;\n    background: var(--theme-modal-btn-bg);\n    font-weight: 600;\n    font-size: 1.1em;\n    color: var(--theme-text-color);\n}\n\n.grid-cell.occupied {\n    background: #ddd !important;\n    cursor: not-allowed !important;\n    opacity: 0.5;\n    color: #999;\n}\n\n.grid-cell.selected {\n    background: #d4fc79 !important;\n    border-color: #28a745 !important;\n    font-weight: 700;\n    color: #155724;\n}\n\n@media (max-width: 768px) {\n    .grid-cell {\n        padding: 14px 6px;\n        font-size: 1em;\n    }\n}\n\n@media (max-width: 480px) {\n    .grid-cell {\n        padding: 12px 4px;\n        font-size: 0.95em;\n    }\n}\n\n/* ==================== å…¨å±€ç§»åŠ¨ç«¯ä¼˜åŒ– ==================== */\n\n/* é˜²æ­¢åŒå‡»ç¼©æ”¾ */\n* {\n    touch-action: manipulation;\n}\n\n/* ä¼˜åŒ–æ»šåŠ¨ä½“éªŒ */\n.event-body,\n#info-modal-details,\n#history-content,\n#achievement-content,\n#relation-content {\n    -webkit-overflow-scrolling: touch;\n    overflow-y: auto;\n}\n\n.canvas-viewport {\n    -webkit-overflow-scrolling: touch;\n}\n\n/* ç§»åŠ¨ç«¯å­—ä½“ä¼˜åŒ– */\n@media (max-width: 768px) {\n    body {\n        -webkit-text-size-adjust: 100%;\n        -ms-text-size-adjust: 100%;\n        text-size-adjust: 100%;\n    }\n}\n\n/* å°å±å¹•ä¸‹çš„æ¥¼å±‚å¸ƒå±€ä¼˜åŒ– */\n@media (max-width: 768px) {\n    .level {\n        /* ä¿æŒå›ºå®šå®½åº¦ï¼Œå…è®¸æ¨ªå‘æ»šåŠ¨ï¼Œä¸å‹ç¼© */\n        width: 1275px;\n        min-width: 1275px;\n    }\n    \n    .floor-wrapper {\n        /* ä¿æŒå›ºå®šå®½åº¦ï¼Œå…è®¸æ¨ªå‘æ»šåŠ¨ï¼Œä¸å‹ç¼© */\n        min-width: 1515px;\n    }\n    \n    .add-floor-btn {\n        /* ä¿æŒå›ºå®šå®½åº¦ï¼Œå…è®¸æ¨ªå‘æ»šåŠ¨ï¼Œä¸å‹ç¼© */\n        min-width: 1515px;\n    }\n}\n\n/* è¶…å°å±å¹•ä¼˜åŒ– */\n@media (max-width: 360px) {\n    .mobile-header {\n        font-size: 0.75em;\n    }\n    \n    .dock-button-icon {\n        font-size: 18px !important;\n    }\n    \n    .room-card {\n        font-size: 0.8em;\n        padding: 10px 6px;\n        min-height: 60px;\n    }\n    \n    .event-section-title {\n        font-size: 1em;\n    }\n}\n\n/* æ¨ªå±ä¼˜åŒ– */\n@media (orientation: landscape) and (max-height: 500px) {\n    .apartment-main-panel {\n        height: 95%;\n        max-height: none;\n    }\n    \n    .mobile-header {\n        padding: 8px 16px;\n    }\n    \n    .mobile-footer {\n        padding: 6px 4px;\n        /* ğŸ”§ æ¨ªå±æ¨¡å¼ä¸‹ä¹Ÿè¦è€ƒè™‘åº•éƒ¨å®‰å…¨åŒºåŸŸ */\n        padding-bottom: max(6px, calc(env(safe-area-inset-bottom, 0px) + 6px));\n    }\n    \n    .dock-button {\n        padding: 4px 2px;\n        gap: 2px;\n    }\n    \n    .dock-button-icon {\n        font-size: 20px;\n    }\n}\n</style>\n`;\n\n// ==================== HTML ç»“æ„ ====================\nconst html = `\n<!-- æ‹–åŠ¨æŒ‰é’® -->\n<div id=\"apartment-toggle-btn\" class=\"apartment-toggle-btn\">\n    <span>ğŸ¢</span>\n</div>\n\n<!-- ä¸»é¢æ¿ -->\n<div id=\"apartment-main-panel\" class=\"apartment-main-panel\">\n    <header class=\"mobile-header\">\n        <div>\n            <span id=\"date-display\">åŠ è½½ä¸­...</span> |\n            <span id=\"time-display\"></span>\n        </div>\n        <div id=\"mode-display\"></div>\n    </header>\n    \n    <div class=\"canvas-viewport\" id=\"screen\">\n        <div id=\"apartment-canvas\">\n            <!-- åŠ¨æ€ç”Ÿæˆçš„å…¬å¯“æ¥¼å±‚å°†æ’å…¥è¿™é‡Œ -->\n        </div>\n        <div class=\"floating-ui\">\n            <button id=\"execute-actions-btn\" class=\"confirm-btn hidden\"></button>\n            <div class=\"zoom-controls\">\n                <button id=\"zoom-in-btn\" class=\"zoom-btn\">+</button>\n                <button id=\"zoom-out-btn\" class=\"zoom-btn\">-</button>\n            </div>\n        </div>\n    </div>\n    \n    <footer class=\"mobile-footer\">\n        <button id=\"recruitment-btn\" class=\"dock-button\">\n            <span class=\"dock-button-icon\">ğŸ‘¤</span>\n            <span>æ‹›å‹Ÿ</span>\n        </button>\n        <button id=\"build-mode-btn\" class=\"dock-button\">\n            <span class=\"dock-button-icon\">ğŸ”¨</span>\n            <span>å»ºé€ </span>\n        </button>\n        <button id=\"event-generator-btn\" class=\"dock-button\">\n            <span class=\"dock-button-icon\">ğŸ²</span>\n            <span>äº‹ä»¶</span>\n        </button>\n        <button id=\"history-btn\" class=\"dock-button\">\n            <span class=\"dock-button-icon\">ğŸ“œ</span>\n            <span>å†å²</span>\n        </button>\n        <button id=\"achievement-btn\" class=\"dock-button\">\n            <span class=\"dock-button-icon\">ğŸ†</span>\n            <span>æˆå°±</span>\n        </button>\n        <button id=\"relation-btn\" class=\"dock-button\">\n            <span class=\"dock-button-icon\">ğŸ•¸ï¸</span>\n            <span>å…³ç³»</span>\n        </button>\n        <button id=\"settings-btn\" class=\"dock-button\">\n            <span class=\"dock-button-icon\">âš™ï¸</span>\n            <span>è®¾ç½®</span>\n        </button>\n    </footer>\n    \n    <!-- äº‹ä»¶æ¨¡æ€æ¡† -->\n    <div id=\"event-modal\" class=\"event-modal\">\n        <div class=\"event-header\" id=\"close-event-modal-btn\">äº‹ä»¶ç”Ÿæˆå™¨ (ç‚¹å‡»æ­¤å¤„å…³é—­)</div>\n        <div class=\"event-body\">\n            <div style=\"margin-bottom: 25px;\">\n                <h3 class=\"event-section-title\">ä¸ªäººäº‹ä»¶</h3>\n                <div class=\"event-buttons-grid\" id=\"single-events\">\n                    <button class=\"event-button\" data-event-type=\"ä¸ªäººæƒ…æ„Ÿç±»\">æƒ…æ„Ÿæ±‚åŠ©</button>\n                    <button class=\"event-button\" data-event-type=\"ç”Ÿæ´»ç»æµç±»\">ç»æµå›°éš¾</button>\n                    <button class=\"event-button\" data-event-type=\"æ—¥å¸¸å§”æ‰˜ç±»\">æ—¥å¸¸å§”æ‰˜</button>\n                    <button class=\"event-button\" data-event-type=\"å®¶å±…ä¿®ç†ç±»\">å®¶å±…ä¿®ç†</button>\n                    <button class=\"event-button random\" data-event-type=\"random-single\">ğŸ² éšæœºä¸€ä»¶</button>\n                </div>\n            </div>\n            <div>\n                <h3 class=\"event-section-title\">é›†ä½“äº‹ä»¶</h3>\n                <div class=\"event-buttons-grid\" id=\"group-events\">\n                    <button class=\"event-button\" data-event-type=\"èŠ‚æ—¥æ´¾å¯¹ç±»\">èŠ‚æ—¥æ´¾å¯¹</button>\n                    <button class=\"event-button\" data-event-type=\"å®¤å†…å¨±ä¹ç±»\">å®¤å†…å¨±ä¹</button>\n                    <button class=\"event-button\" data-event-type=\"çªå‘çŠ¶å†µç±»\">çªå‘çŠ¶å†µ</button>\n                    <button class=\"event-button\" data-event-type=\"å…±åŒåˆ›ä½œç±»\">å…±åŒåˆ›ä½œ</button>\n                    <button class=\"event-button random\" data-event-type=\"random-group\">ğŸ² éšæœºä¸€ä»¶</button>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n\n<!-- æ‰€æœ‰æ¨¡æ€æ¡† -->\n<div id=\"add-room-modal\" class=\"modal-overlay hidden\">\n    <div class=\"modal-content\">\n        <h2 class=\"modal-title\" id=\"add-room-modal-title\">æ–°å»ºç©ºæˆ¿é—´</h2>\n        <p class=\"modal-subtitle\" id=\"add-room-modal-subtitle\" style=\"white-space: pre-line;\"></p>\n        <div class=\"modal-functional-input\">\n            <div id=\"grid-selector-container\" style=\"margin: 15px 0;\">\n                <label style=\"font-weight: bold; margin-bottom: 10px; display: block;\">\n                    é€‰æ‹©æˆ¿é—´ä½ç½®ï¼ˆç‚¹å‡»å¹¶æ‹–åŠ¨é€‰æ‹©è¿ç»­æ ¼å­ï¼‰ï¼š\n                </label>\n                <div id=\"grid-selector\" style=\"display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin: 10px 0; user-select: none;\"></div>\n                <p id=\"selected-range-display\" style=\"margin-top: 10px; font-size: 0.9em; color: var(--theme-subtitle-color);\"></p>\n            </div>\n            <button id=\"confirm-add-room-btn\" class=\"modal-confirm-btn\">ç¡®è®¤æ–°å»ºç©ºæˆ¿é—´</button>\n        </div>\n    </div>\n</div>\n\n<div id=\"add-floor-modal\" class=\"modal-overlay hidden\">\n    <div class=\"modal-content\">\n        <h2 class=\"modal-title\">æ–°å»ºæ¥¼å±‚</h2>\n        <div class=\"modal-functional-input\">\n            <label>æ¥¼å±‚åç§°ï¼š</label>\n            <input type=\"text\" id=\"add-floor-name\" placeholder=\"ä¾‹å¦‚ï¼šäº”æ¥¼ã€åœ°ä¸‹äºŒæ¥¼\">\n            <label>æ¥¼å±‚ä½ç½®ï¼š</label>\n            <select id=\"add-floor-position\">\n                <option value=\"top\">æœ€é¡¶å±‚ï¼ˆå‘ä¸Šæ‰©å±•ï¼‰</option>\n                <option value=\"bottom\">æœ€åº•å±‚ï¼ˆå‘ä¸‹æ‰©å±•ï¼‰</option>\n            </select>\n            <button id=\"confirm-add-floor-btn\" class=\"modal-confirm-btn\">ç¡®è®¤æ–°å»º</button>\n        </div>\n    </div>\n</div>\n\n<div id=\"management-modal\" class=\"modal-overlay hidden\">\n    <div class=\"modal-content\">\n        <h2 id=\"management-modal-title\" class=\"modal-title\"></h2>\n        <p id=\"management-modal-subtitle\" class=\"modal-subtitle\"></p>\n        <div id=\"management-modal-choices\" class=\"modal-choices\"></div>\n    </div>\n</div>\n\n<div id=\"info-modal\" class=\"modal-overlay hidden\">\n    <div class=\"modal-content\">\n        <div id=\"info-modal-header\">\n            <button id=\"info-modal-close-btn\" class=\"modal-close-btn\">Ã—</button>\n            <h2 id=\"info-modal-title\" class=\"modal-title\"></h2>\n            <p id=\"info-modal-subtitle\" class=\"modal-subtitle\"></p>\n        </div>\n        <div id=\"info-modal-details\"></div>\n    </div>\n</div>\n\n<div id=\"recruitment-modal\" class=\"modal-overlay hidden\">\n    <div class=\"modal-content\">\n        <h2 class=\"modal-title\">æ‹›å‹Ÿæ–°ç§Ÿå®¢</h2>\n        <p class=\"modal-subtitle\">è¯·è¾“å…¥æ‚¨æœŸæœ›çš„ç§Ÿå®¢ç‰¹å¾</p>\n        <div class=\"modal-functional-input\">\n            <input type=\"text\" id=\"recruitment-keywords\" placeholder=\"ä¾‹å¦‚ï¼šäººå¦»ã€é‡‘å‘ã€JK\">\n            <button id=\"confirm-recruitment-btn\" class=\"modal-confirm-btn\">ç¡®è®¤æ‹›å‹Ÿ</button>\n        </div>\n    </div>\n</div>\n\n<div id=\"history-modal\" class=\"modal-overlay hidden\">\n    <div class=\"modal-content\">\n        <button id=\"history-modal-close-btn\" class=\"modal-close-btn\">Ã—</button>\n        <h2 class=\"modal-title\">ğŸ“œ äº‹ä»¶å†å²</h2>\n        <div id=\"history-content\">\n            <p style=\"color: var(--theme-subtitle-color);\">åŠ è½½ä¸­...</p>\n        </div>\n    </div>\n</div>\n\n<div id=\"achievement-modal\" class=\"modal-overlay hidden\">\n    <div class=\"modal-content\">\n        <button id=\"achievement-modal-close-btn\" class=\"modal-close-btn\">Ã—</button>\n        <h2 class=\"modal-title\">ğŸ† æˆå°±åˆ—è¡¨</h2>\n        <div id=\"achievement-content\">\n            <p style=\"color: var(--theme-subtitle-color);\">åŠ è½½ä¸­...</p>\n        </div>\n    </div>\n</div>\n\n<div id=\"settings-modal\" class=\"modal-overlay hidden\">\n    <div class=\"modal-content\">\n        <h2 class=\"modal-title\">ç³»ç»Ÿè®¾ç½®</h2>\n        <div class=\"modal-choices\">\n            <button data-theme=\"light\">â˜€ï¸ å…‰è¾‰ç™½æ—¥</button>\n            <button data-theme=\"dark\">ğŸŒ™ é™è°§å¤œæ™š</button>\n        </div>\n    </div>\n</div>\n\n<div id=\"relation-modal\" class=\"modal-overlay hidden\">\n    <div class=\"modal-content\">\n        <button id=\"relation-modal-close-btn\" class=\"modal-close-btn\">Ã—</button>\n        <h2 class=\"modal-title\">ğŸ•¸ï¸ å…³ç³»ç½‘ç»œ</h2>\n        <p class=\"modal-subtitle\" style=\"margin-bottom: 15px;\">ç‚¹å‡»æŸ¥çœ‹è¯¥è§’è‰²å¯¹å…¶ä»–äººçš„å…³ç³»</p>\n        <div id=\"relation-content\">\n            <p style=\"color: var(--theme-subtitle-color);\">åŠ è½½ä¸­...</p>\n        </div>\n    </div>\n</div>\n`;\n\n// ==================== JavaScript åŠŸèƒ½å®ç° ====================\n\n// å…¨å±€å˜é‡\nlet isBuildMode = false;\nlet actionQueue = {};\nlet currentEditingRoomId = null;\nlet currentEditingRoomName = null;\nlet currentFloorForNewRoom = null;\nlet cachedMVUData = null;\nlet btnDragData = null;  // æŒ‰é’®æ‹–åŠ¨æ•°æ®\nlet tempRoomCounters = {};  // ä¸´æ—¶è·Ÿè¸ªæ¯ä¸ªæ¥¼å±‚æ–°å»ºçš„æˆ¿é—´æ•°ï¼ˆé˜²æ­¢é‡å¤ç¼–å·ï¼‰\n\nlet scale = 1, posX = 0, posY = 0;\nlet isDragging = false, hasDragged = false;\nlet startX, startY, lastX, lastY;\n\nconst MAX_RETRIES = 5;\nconst RETRY_DELAY = 400;\nlet currentRetry = 0;\n\n// ==================== å·¥å…·å‡½æ•° ====================\nfunction SafeGetValue(data, path, defaultValue = 'æœªçŸ¥') {\n    if (!data) return defaultValue;\n    const keys = path.split('.');\n    let current = data;\n    for (const key of keys) {\n        if (current === undefined || current === null || typeof current !== 'object' || !current.hasOwnProperty(key)) {\n            return defaultValue;\n        }\n        current = current[key];\n    }\n    if (current === undefined || current === null) return defaultValue;\n    if (Array.isArray(current) && current.length > 0) {\n        const value = current[0];\n        return String(value) === '' ? defaultValue : String(value);\n    }\n    return String(current) === '' ? defaultValue : String(current);\n}\n\nfunction countCurrentTenants(data) {\n    const tenantList = data?.ç§Ÿå®¢åˆ—è¡¨?.[0];\n    if (!tenantList) return 0;\n    let count = 0;\n    for (const key in tenantList) {\n        if (key !== '$meta' && typeof tenantList[key] === 'object') {\n            count++;\n        }\n    }\n    return count;\n}\n\nfunction countAvailableBedrooms(data) {\n    const roomsData = data?.å…¬å¯“?.æˆ¿é—´åˆ—è¡¨?.[0];\n    if (!roomsData) return 0;\n    let bedroomCount = 0;\n    for (const roomKey in roomsData) {\n        if (roomKey === '$meta') continue;\n        const roomData = roomsData[roomKey];\n        const roomType = SafeGetValue(roomData, 'ç±»å‹');\n        // åªç»Ÿè®¡å§å®¤ç±»å‹çš„æˆ¿é—´\n        if (roomType === 'å§å®¤') {\n            bedroomCount++;\n        }\n    }\n    return bedroomCount;\n}\n\nfunction parsePosition(posStr) {\n    const parts = posStr.split('-');\n    return { start: parseInt(parts[0]), end: parseInt(parts[1]) };\n}\n\nfunction calculateSize(posStr) {\n    const pos = parsePosition(posStr);\n    return pos.end - pos.start + 1;\n}\n\nfunction findAvailableSlots(floorName, roomsData, totalCapacity = 10) {\n    const occupied = [];\n    for (const roomKey in roomsData) {\n        if (roomKey === '$meta') continue;\n        const layout = roomsData[roomKey]?.å¸ƒå±€;\n        if (layout && SafeGetValue(layout, 'æ¥¼å±‚') === floorName) {\n            const pos = parsePosition(SafeGetValue(layout, 'ä½ç½®', '1-2'));\n            for (let i = pos.start; i <= pos.end; i++) {\n                occupied.push(i);\n            }\n        }\n    }\n    const available = [];\n    let start = null;\n    for (let i = 1; i <= totalCapacity; i++) {\n        if (!occupied.includes(i)) {\n            if (start === null) start = i;\n            if (i === totalCapacity || occupied.includes(i + 1)) {\n                available.push({ start, end: i, size: i - start + 1 });\n                start = null;\n            }\n        } else {\n            start = null;\n        }\n    }\n    return available;\n}\n\n// ==================== åˆå§‹åŒ–å‡½æ•° ====================\nfunction initializeApartmentPlugin() {\n    console.log('ğŸš€ åˆå§‹åŒ–æŒä¸Šå…¬å¯“æ’ä»¶...');\n    \n    // è·å–ç›®æ ‡æ–‡æ¡£\n    const targetDoc = window.top ? window.top.document : document;\n    \n    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨\n    if (targetDoc.getElementById('apartment-toggle-btn')) {\n        console.log('âš ï¸ æŒä¸Šå…¬å¯“å·²å­˜åœ¨ï¼Œå…ˆç§»é™¤æ—§çš„');\n        targetDoc.getElementById('apartment-toggle-btn')?.remove();\n        targetDoc.getElementById('apartment-main-panel')?.remove();\n        // ç§»é™¤æ‰€æœ‰æ¨¡æ€æ¡†\n        targetDoc.querySelectorAll('[id$=\"-modal\"]').forEach(el => {\n            if (el.id.includes('apartment') || el.id.includes('add-') || el.id.includes('management') || \n                el.id.includes('info') || el.id.includes('recruitment') || el.id.includes('history') || \n                el.id.includes('achievement') || el.id.includes('settings')) {\n                el.remove();\n            }\n        });\n        \n        // æ¸…ç†äº‹ä»¶\n        $(targetDoc).off('.apartment-plugin');\n    }\n    \n    // æ³¨å…¥æ ·å¼\n    if (!targetDoc.getElementById('apartment-plugin-styles')) {\n        targetDoc.head.insertAdjacentHTML('beforeend', styles);\n        console.log('âœ… æ ·å¼å·²æ³¨å…¥');\n    }\n    \n    // æ³¨å…¥ HTML\n    targetDoc.body.insertAdjacentHTML('beforeend', html);\n    console.log('âœ… HTML å·²æ³¨å…¥');\n    \n    // ä» localStorage æ¢å¤æŒ‰é’®ä½ç½®\n    const btn = targetDoc.getElementById('apartment-toggle-btn');\n    try {\n        const saved = localStorage.getItem('apartment-btn-position');\n        if (saved) {\n            const pos = JSON.parse(saved);\n            btn.style.left = pos.left + 'px';\n            btn.style.top = pos.top + 'px';\n            console.log('ğŸ“ æ¢å¤æŒ‰é’®ä½ç½®:', pos);\n        }\n    } catch (e) {\n        console.warn('âš ï¸ æ¢å¤æŒ‰é’®ä½ç½®å¤±è´¥');\n    }\n    \n    // åˆå§‹åŒ–æŒ‰é’®æ‹–åŠ¨åŠŸèƒ½\n    initializeButtonDrag(targetDoc);\n    \n    // åˆå§‹åŒ–å…¬å¯“ç³»ç»Ÿ\n    initializeApartmentSystem(targetDoc);\n    \n    console.log('âœ… æŒä¸Šå…¬å¯“æ’ä»¶åˆå§‹åŒ–å®Œæˆï¼');\n}\n\n// ==================== æŒ‰é’®æ‹–åŠ¨åŠŸèƒ½ ====================\nfunction initializeButtonDrag(targetDoc) {\n    const btn = targetDoc.getElementById('apartment-toggle-btn');\n    const panel = targetDoc.getElementById('apartment-main-panel');\n    const $targetDoc = $(targetDoc);\n    \n    // æ‹–åŠ¨å¼€å§‹\n    function handleBtnDragStart(clientX, clientY) {\n        if (btnDragData) return false;\n        \n        const computedStyle = window.getComputedStyle(btn);\n        const currentLeft = parseInt(computedStyle.left) || 0;\n        const currentTop = parseInt(computedStyle.top) || 0;\n        \n        btnDragData = {\n            startX: clientX,\n            startY: clientY,\n            initialLeft: currentLeft,\n            initialTop: currentTop\n        };\n        \n        btn.classList.add('dragging');\n        console.log('ğŸ–±ï¸ å¼€å§‹æ‹–åŠ¨æŒ‰é’®');\n        return true;\n    }\n    \n    // æ‹–åŠ¨ç§»åŠ¨\n    function handleBtnDragMove(clientX, clientY) {\n        if (!btnDragData) return;\n        \n        const deltaX = clientX - btnDragData.startX;\n        const deltaY = clientY - btnDragData.startY;\n        \n        let newLeft = btnDragData.initialLeft + deltaX;\n        let newTop = btnDragData.initialTop + deltaY;\n        \n        // é™åˆ¶èŒƒå›´\n        const targetWindow = window.top || window;\n        const maxX = $(targetWindow).width() - 80;\n        const maxY = $(targetWindow).height() - 80;\n        \n        newLeft = Math.max(0, Math.min(newLeft, maxX));\n        newTop = Math.max(0, Math.min(newTop, maxY));\n        \n        btn.style.left = newLeft + 'px';\n        btn.style.top = newTop + 'px';\n    }\n    \n    // æ‹–åŠ¨ç»“æŸ\n    function handleBtnDragEnd(clientX, clientY) {\n        if (!btnDragData) return;\n        \n        btn.classList.remove('dragging');\n        \n        // è®¡ç®—æ‹–åŠ¨è·ç¦»\n        const deltaX = clientX - btnDragData.startX;\n        const deltaY = clientY - btnDragData.startY;\n        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n        \n        // ä¿å­˜ä½ç½®\n        const computedStyle = window.getComputedStyle(btn);\n        const currentLeft = parseInt(computedStyle.left) || 0;\n        const currentTop = parseInt(computedStyle.top) || 0;\n        \n        const position = {\n            left: currentLeft,\n            top: currentTop\n        };\n        \n        localStorage.setItem('apartment-btn-position', JSON.stringify(position));\n        console.log('âœ… æŒ‰é’®æ‹–åŠ¨ç»“æŸï¼Œä¿å­˜ä½ç½®:', position);\n        \n        btnDragData = null;\n        \n        // å¦‚æœæ˜¯ç‚¹å‡»ï¼ˆç§»åŠ¨è·ç¦»å°äº5åƒç´ ï¼‰ï¼Œæ‰“å¼€/å…³é—­é¢æ¿\n        if (distance < 5) {\n            console.log('ğŸ¨ æ£€æµ‹åˆ°ç‚¹å‡»ï¼Œåˆ‡æ¢é¢æ¿');\n            panel.classList.toggle('active');\n            // æ‰“å¼€é¢æ¿æ—¶åŠ è½½æ•°æ®\n            if (panel.classList.contains('active')) {\n                currentRetry = 0;  // é‡ç½®é‡è¯•è®¡æ•°å™¨\n                populateDataWithMVU(targetDoc);\n            }\n        }\n    }\n    \n    // ç»‘å®šäº‹ä»¶\n    $(btn).on('mousedown.apartment-plugin', function(e) {\n        if (handleBtnDragStart(e.clientX, e.clientY)) {\n            e.preventDefault();\n            e.stopPropagation();\n        }\n    });\n    \n    $(btn).on('touchstart.apartment-plugin', function(e) {\n        const touch = e.originalEvent.touches[0];\n        if (handleBtnDragStart(touch.clientX, touch.clientY)) {\n            e.preventDefault();\n            e.stopPropagation();\n        }\n    });\n    \n    $targetDoc.on('mousemove.apartment-plugin', function(e) {\n        handleBtnDragMove(e.clientX, e.clientY);\n        if (btnDragData) e.preventDefault();\n    });\n    \n    $targetDoc.on('touchmove.apartment-plugin', function(e) {\n        const touch = e.originalEvent.touches[0];\n        handleBtnDragMove(touch.clientX, touch.clientY);\n        if (btnDragData) e.preventDefault();\n    });\n    \n    $targetDoc.on('mouseup.apartment-plugin', function(e) {\n        handleBtnDragEnd(e.clientX, e.clientY);\n    });\n    \n    $targetDoc.on('touchend.apartment-plugin touchcancel.apartment-plugin', function(e) {\n        const touch = e.originalEvent.changedTouches[0];\n        if (touch) {\n            handleBtnDragEnd(touch.clientX, touch.clientY);\n        } else {\n            handleBtnDragEnd(0, 0);\n        }\n    });\n    \n    console.log('âœ… æŒ‰é’®æ‹–åŠ¨åŠŸèƒ½å·²åˆå§‹åŒ–');\n}\n\n// ==================== å…¬å¯“ç³»ç»Ÿåˆå§‹åŒ– ====================\nfunction initializeApartmentSystem(targetDoc) {\n    const screen = targetDoc.getElementById('screen');\n    const canvas = targetDoc.getElementById('apartment-canvas');\n    const modeDisplay = targetDoc.getElementById('mode-display');\n    const buildModeBtn = targetDoc.getElementById('build-mode-btn');\n    const allModals = targetDoc.querySelectorAll('.modal-overlay');\n    \n    // è®¾ç½®åˆå§‹æ¨¡å¼\n    modeDisplay.textContent = 'è§‚å¯Ÿæ¨¡å¼';\n    modeDisplay.className = 'observation-mode';\n    \n    // è§†å›¾æ§åˆ¶å‡½æ•° - ç›´æ¥æ›´æ–°ï¼Œæœ€é«˜æ€§èƒ½\n    function updateTransform() {\n        canvas.style.transform = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;\n    }\n    \n    function zoom(factor) {\n        // æ·»åŠ ç¼©æ”¾åŠ¨ç”»ç±»\n        canvas.classList.add('zooming');\n        \n        scale = Math.min(Math.max(0.2, scale * factor), 2);\n        updateTransform();\n        \n        // åŠ¨ç”»ç»“æŸåç§»é™¤ç±»\n        setTimeout(() => {\n            canvas.classList.remove('zooming');\n        }, 300);\n    }\n    \n    // æ‹–åŠ¨ç”»å¸ƒ\n    function handleDragStart(e) {\n        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨æŒ‰é’®ç­‰UIæ§ä»¶ä¸Šï¼ˆä¸åŒ…æ‹¬æˆ¿é—´å¡ç‰‡ï¼Œæˆ¿é—´å¡ç‰‡éœ€è¦æ¥æ”¶ç‚¹å‡»ï¼‰\n        const target = e.target;\n        if (target.closest('.dock-button') || \n            target.closest('.zoom-btn') || \n            target.closest('.confirm-btn') ||\n            target.closest('.add-room-btn') ||\n            target.closest('.add-floor-btn') ||\n            target.closest('.level-title') ||\n            (target.tagName === 'BUTTON' && !target.closest('.room-card'))) {\n            return; // ç‚¹å‡»UIæ§ä»¶æ—¶ä¸è§¦å‘æ‹–åŠ¨\n        }\n        \n        e.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º\n        canvas.classList.remove('zooming'); // ç¡®ä¿æ‹–åŠ¨æ—¶æ²¡æœ‰è¿‡æ¸¡åŠ¨ç”»\n        isDragging = true;\n        hasDragged = false;\n        const touch = e.touches ? e.touches[0] : e;\n        startX = touch.clientX;\n        startY = touch.clientY;\n        lastX = posX;\n        lastY = posY;\n    }\n    \n    function handleDragMove(e) {\n        if (!isDragging) return;\n        \n        const touch = e.touches ? e.touches[0] : e;\n        const currentX = touch.clientX;\n        const currentY = touch.clientY;\n        const deltaX = currentX - startX;\n        const deltaY = currentY - startY;\n        \n        // é™ä½é˜ˆå€¼åˆ°3åƒç´ ï¼Œè®©æ‹–åŠ¨æ›´çµæ•\n        if (!hasDragged && (Math.abs(deltaX) > 3 || Math.abs(deltaY) > 3)) {\n            hasDragged = true;\n            e.preventDefault();\n        }\n        \n        if (hasDragged) {\n            e.preventDefault();\n            posX = lastX + deltaX;\n            posY = lastY + deltaY;\n            canvas.style.transform = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;\n        }\n    }\n    \n    function handleDragEnd(e) {\n        if (isDragging) {\n            isDragging = false;\n        }\n        \n        // å»¶è¿Ÿé‡ç½® hasDraggedï¼Œè®© onclick èƒ½å¤Ÿæ­£ç¡®åˆ¤æ–­\n        if (hasDragged) {\n            setTimeout(() => {\n                hasDragged = false;\n            }, 50);\n        }\n    }\n    \n    // ç»‘å®šç”»å¸ƒæ‹–åŠ¨äº‹ä»¶ - ä½¿ç”¨éè¢«åŠ¨æ¨¡å¼ç¡®ä¿ç«‹å³å“åº”\n    screen.addEventListener('mousedown', handleDragStart, { passive: false });\n    targetDoc.addEventListener('mousemove', handleDragMove, { passive: false });\n    targetDoc.addEventListener('mouseup', handleDragEnd, { passive: false });\n    screen.addEventListener('touchstart', handleDragStart, { passive: false });\n    targetDoc.addEventListener('touchmove', handleDragMove, { passive: false });\n    targetDoc.addEventListener('touchend', handleDragEnd, { passive: false });\n    \n    // è¾…åŠ©å‡½æ•°ï¼šç‚¹å‡»åç§»é™¤ç„¦ç‚¹\n    const clickAndBlur = (element, handler) => {\n        element.addEventListener('click', (e) => {\n            handler();\n            setTimeout(() => element.blur(), 0);\n        });\n    };\n    \n    // ç»‘å®šæŒ‰é’®äº‹ä»¶ï¼ˆç‚¹å‡»åè‡ªåŠ¨ç§»é™¤ç„¦ç‚¹ï¼Œé˜²æ­¢å‡ºç°ç„¦ç‚¹æ¡†ï¼‰\n    clickAndBlur(targetDoc.getElementById('zoom-in-btn'), () => zoom(1.2));\n    clickAndBlur(targetDoc.getElementById('zoom-out-btn'), () => zoom(0.8));\n    clickAndBlur(targetDoc.getElementById('build-mode-btn'), toggleBuildMode);\n    clickAndBlur(targetDoc.getElementById('recruitment-btn'), openRecruitmentModal);\n    clickAndBlur(targetDoc.getElementById('settings-btn'), openSettingsModal);\n    clickAndBlur(targetDoc.getElementById('event-generator-btn'), openEventGenerator);\n    clickAndBlur(targetDoc.getElementById('history-btn'), openHistoryModal);\n    clickAndBlur(targetDoc.getElementById('achievement-btn'), openAchievementModal);\n    clickAndBlur(targetDoc.getElementById('relation-btn'), openRelationModal);\n    \n    // ç»‘å®šæ¨¡æ€æ¡†å…³é—­\n    allModals.forEach(modal => {\n        modal.addEventListener('click', (e) => {\n            if (e.target === modal) closeAllModals();\n        });\n    });\n    \n    // æ–°å»ºæˆ¿é—´ç›¸å…³ï¼ˆç‚¹å‡»åç§»é™¤ç„¦ç‚¹ï¼‰\n    clickAndBlur(targetDoc.getElementById('confirm-add-room-btn'), confirmAddRoom);\n    clickAndBlur(targetDoc.getElementById('confirm-add-floor-btn'), confirmAddFloor);\n    clickAndBlur(targetDoc.getElementById('confirm-recruitment-btn'), confirmRecruitment);\n    \n    // ğŸ”§ æ‰€æœ‰æ¨¡æ€æ¡†çš„å…³é—­æŒ‰é’®\n    const infoModalCloseBtn = targetDoc.getElementById('info-modal-close-btn');\n    if (infoModalCloseBtn) {\n        clickAndBlur(infoModalCloseBtn, closeAllModals);\n    }\n    \n    const historyModalCloseBtn = targetDoc.getElementById('history-modal-close-btn');\n    if (historyModalCloseBtn) {\n        clickAndBlur(historyModalCloseBtn, closeAllModals);\n    }\n    \n    const achievementModalCloseBtn = targetDoc.getElementById('achievement-modal-close-btn');\n    if (achievementModalCloseBtn) {\n        clickAndBlur(achievementModalCloseBtn, closeAllModals);\n    }\n    \n    const relationModalCloseBtn = targetDoc.getElementById('relation-modal-close-btn');\n    if (relationModalCloseBtn) {\n        clickAndBlur(relationModalCloseBtn, closeAllModals);\n    }\n    \n    // è®¾ç½®ä¸»é¢˜åˆ‡æ¢\n    targetDoc.querySelector('#settings-modal .modal-choices').addEventListener('click', (e) => {\n        if (e.target.dataset.theme) switchTheme(e.target.dataset.theme);\n    });\n    \n    // äº‹ä»¶ç”Ÿæˆå™¨\n    clickAndBlur(targetDoc.getElementById('close-event-modal-btn'), closeEventGenerator);\n    targetDoc.getElementById('single-events').addEventListener('click', (e) => {\n        if (e.target.matches('.event-button')) {\n            triggerEvent(e.target.dataset.eventType, 'ä¸ªäºº');\n        }\n    });\n    targetDoc.getElementById('group-events').addEventListener('click', (e) => {\n        if (e.target.matches('.event-button')) {\n            triggerEvent(e.target.dataset.eventType, 'é›†ä½“');\n        }\n    });\n    \n    // æ¨¡å¼åˆ‡æ¢å‡½æ•°\n    function toggleBuildMode() {\n        isBuildMode = !isBuildMode;\n        buildModeBtn.classList.toggle('active');\n        if (isBuildMode) {\n            modeDisplay.textContent = 'å»ºé€ æ¨¡å¼';\n            modeDisplay.className = 'build-mode';\n        } else {\n            modeDisplay.textContent = 'è§‚å¯Ÿæ¨¡å¼';\n            modeDisplay.className = 'observation-mode';\n        }\n        if (cachedMVUData) {\n            renderApartment(cachedMVUData, targetDoc);\n        }\n    }\n    \n    // å±…ä¸­è§†å›¾\n    function centerView() {\n        setTimeout(() => {\n            const viewportWidth = screen.offsetWidth;\n            const viewportHeight = screen.offsetHeight;\n            const canvasWidth = 1515;\n            \n            const scaleX = (viewportWidth - 40) / canvasWidth;\n            const scaleY = (viewportHeight - 40) / 800;\n            scale = Math.min(1, Math.max(0.25, Math.min(scaleX, scaleY)));\n            \n            posX = 0;\n            posY = 0;\n            \n            updateTransform();\n        }, 200);\n    }\n    \n    centerView();\n    console.log('âœ… å…¬å¯“ç³»ç»Ÿå·²åˆå§‹åŒ–');\n}\n\n// ==================== æ•°æ®åŠ è½½å‡½æ•° ====================\nasync function populateDataWithMVU(targetDoc) {\n    try {\n        // æ£€æŸ¥MVUæ˜¯å¦å¯ç”¨\n        if (typeof Mvu === 'undefined') {\n            // å°è¯•ä»çˆ¶çª—å£è·å–\n            if (window.parent && typeof window.parent.Mvu !== 'undefined') {\n                window.Mvu = window.parent.Mvu;\n                console.log('âœ… å·²ä»çˆ¶çª—å£å¼•ç”¨MVU');\n            } else {\n                console.warn('âš ï¸ MVUæ¡†æ¶æœªåŠ è½½');\n                if (currentRetry < MAX_RETRIES) {\n                    currentRetry++;\n                    setTimeout(() => populateDataWithMVU(targetDoc), RETRY_DELAY);\n                } else {\n                    targetDoc.getElementById('date-display').innerText = \"MVUæœªåŠ è½½\";\n                }\n                return;\n            }\n        }\n        \n        // æ™ºèƒ½è·å–åº”è¯¥æ˜¾ç¤ºçš„æ•°æ®\n        let targetMessageId = 'latest';\n        if (typeof getLastMessageId === 'function' && typeof getChatMessages === 'function') {\n            let currentId = getLastMessageId();\n            \n            while (currentId >= 0) {\n                const message = getChatMessages(currentId).at(-1);\n                if (message && message.role !== 'user') {\n                    targetMessageId = currentId;\n                    if (currentId !== getLastMessageId()) {\n                        console.log(`ğŸ“ å‘ä¸ŠæŸ¥æ‰¾åˆ°ç¬¬ ${currentId} å±‚çš„AIæ¶ˆæ¯`);\n                    }\n                    break;\n                }\n                currentId--;\n            }\n            \n            if (currentId < 0) {\n                targetMessageId = 'latest';\n                console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°AIæ¶ˆæ¯ï¼Œä½¿ç”¨æœ€åä¸€å±‚');\n            }\n        }\n        \n        // ä½¿ç”¨Mvu.getMvuDataè·å–æ•°æ®\n        const mvuResult = Mvu.getMvuData({ type: 'message', message_id: targetMessageId });\n        const data = mvuResult?.stat_data;\n        \n        if (!data) {\n            console.warn('âš ï¸ MVUæ•°æ®ä¸ºç©º');\n            if (currentRetry < MAX_RETRIES) {\n                currentRetry++;\n                setTimeout(() => populateDataWithMVU(targetDoc), RETRY_DELAY);\n            } else {\n                targetDoc.getElementById('date-display').innerText = \"æœªèƒ½åŠ è½½æ•°æ®QAQ\";\n            }\n            return;\n        }\n        \n        cachedMVUData = data;\n        console.log('âœ… æ•°æ®åŠ è½½æˆåŠŸ', data);\n        \n        // ğŸ”§ é‡ç½®ä¸´æ—¶æˆ¿é—´è®¡æ•°å™¨ï¼ˆæ•°æ®åˆ·æ–°è¯´æ˜ä¹‹å‰çš„å‘½ä»¤å·²æ‰§è¡Œï¼‰\n        tempRoomCounters = {};\n        \n        // æ›´æ–°æ—¶é—´æ˜¾ç¤º\n        const world = data.ä¸–ç•Œ;\n        targetDoc.getElementById('date-display').textContent = `${SafeGetValue(world, 'å¹´ä»½')} ${SafeGetValue(world, 'æ—¥æœŸ')} ${SafeGetValue(world, 'æ˜ŸæœŸ')}`;\n        targetDoc.getElementById('time-display').textContent = SafeGetValue(world, 'æ—¶é—´');\n        \n        // æ›´æ–°æ‹›å‹ŸæŒ‰é’®çŠ¶æ€ï¼šåªæœ‰ç§Ÿå®¢æ•°é‡ < å§å®¤æ•°é‡ä¸” < 6 æ—¶æ‰èƒ½æ‹›å‹Ÿ\n        const tenantCount = countCurrentTenants(data);\n        const bedroomCount = countAvailableBedrooms(data);\n        // ç§Ÿå®¢æ•°é‡å¿…é¡»å°äºå§å®¤æ•°é‡ï¼Œä¸”ä¸è¶…è¿‡6ä¸ªï¼ˆé˜²æ­¢AIæ³¨æ„ä¸è¿‡æ¥ï¼‰\n        targetDoc.getElementById('recruitment-btn').disabled = (tenantCount >= bedroomCount || tenantCount >= 6);\n        \n        // æ¸²æŸ“å…¬å¯“\n        renderApartment(data, targetDoc);\n        \n    } catch (error) {\n        console.error(\"çŠ¶æ€æ åŠ è½½å‡ºé”™:\", error);\n        console.error(\"é”™è¯¯è¯¦æƒ…:\", error.stack);\n        targetDoc.getElementById('date-display').innerText = \"åŠ è½½å‡ºé”™: \" + error.message;\n    }\n}\n\n// ==================== æ¸²æŸ“å…¬å¯“ ====================\nfunction renderApartment(data, targetDoc) {\n    const floorConfig = data.å…¬å¯“?.æ¥¼å±‚é…ç½®;\n    const roomsData = data.å…¬å¯“?.æˆ¿é—´åˆ—è¡¨?.[0];\n    \n    if (!floorConfig || !roomsData) return;\n    \n    const floors = [];\n    for (const floorKey in floorConfig) {\n        if (floorKey === '$meta') continue;\n        const floorInfo = floorConfig[floorKey];\n        floors.push({\n            key: floorKey,\n            name: SafeGetValue(floorInfo, 'æ˜¾ç¤ºåç§°', floorKey),\n            order: parseFloat(SafeGetValue(floorInfo, 'é¡ºåº', '999')),\n            capacity: parseInt(SafeGetValue(floorInfo, 'æ€»å®¹é‡', '10'))\n        });\n    }\n    floors.sort((a, b) => b.order - a.order);\n    \n    const canvas = targetDoc.getElementById('apartment-canvas');\n    canvas.innerHTML = '';\n    \n    // æ·»åŠ æ–°å»ºæ¥¼å±‚æŒ‰é’®ï¼ˆé¡¶éƒ¨ï¼‰\n    if (isBuildMode) {\n        const addTopFloorBtn = document.createElement('button');\n        addTopFloorBtn.className = 'add-floor-btn';\n        addTopFloorBtn.textContent = 'â• æ–°å»ºæ¥¼å±‚ï¼ˆå‘ä¸Šæ‰©å±•ï¼‰';\n        addTopFloorBtn.onclick = () => openAddFloorModal('top');\n        canvas.appendChild(addTopFloorBtn);\n    }\n    \n    // æ¸²æŸ“æ¯ä¸ªæ¥¼å±‚\n    floors.forEach(floor => {\n        const floorElement = createFloorElement(floor, roomsData, targetDoc);\n        canvas.appendChild(floorElement);\n    });\n    \n    // æ·»åŠ æ–°å»ºæ¥¼å±‚æŒ‰é’®ï¼ˆåº•éƒ¨ï¼‰\n    if (isBuildMode) {\n        const addBottomFloorBtn = document.createElement('button');\n        addBottomFloorBtn.className = 'add-floor-btn';\n        addBottomFloorBtn.textContent = 'â• æ–°å»ºæ¥¼å±‚ï¼ˆå‘ä¸‹æ‰©å±•ï¼‰';\n        addBottomFloorBtn.onclick = () => openAddFloorModal('bottom');\n        canvas.appendChild(addBottomFloorBtn);\n    }\n}\n\n// ==================== åˆ›å»ºæ¥¼å±‚å…ƒç´  ====================\nfunction createFloorElement(floor, roomsData, targetDoc) {\n    const floorRooms = [];\n    const outdoorRooms = { left: null, right: null };\n    \n    for (const roomKey in roomsData) {\n        if (roomKey === '$meta') continue;\n        const roomData = roomsData[roomKey];\n        const layout = roomData?.å¸ƒå±€;\n        if (layout && SafeGetValue(layout, 'æ¥¼å±‚') === floor.name) {\n            const position = SafeGetValue(layout, 'ä½ç½®', '1-2');\n            \n            if (position === 'outdoor-left') {\n                outdoorRooms.left = { key: roomKey, data: roomData };\n            } else if (position === 'outdoor-right') {\n                outdoorRooms.right = { key: roomKey, data: roomData };\n            } else {\n                const pos = parsePosition(position);\n                floorRooms.push({\n                    key: roomKey,\n                    data: roomData,\n                    position: position,\n                    start: pos.start,\n                    end: pos.end,\n                    size: pos.end - pos.start + 1\n                });\n            }\n        }\n    }\n    floorRooms.sort((a, b) => a.start - b.start);\n    \n    const floorWrapper = document.createElement('div');\n    floorWrapper.className = 'floor-wrapper';\n    \n    // å·¦ä¾§åŒºåŸŸ\n    const leftDiv = document.createElement('div');\n    leftDiv.className = 'floor-outdoor-left';\n    if (outdoorRooms.left) {\n        leftDiv.appendChild(createOutdoorCard(outdoorRooms.left, targetDoc));\n    }\n    floorWrapper.appendChild(leftDiv);\n    \n    // ä¸»æ¥¼å±‚\n    const mainDiv = document.createElement('div');\n    mainDiv.className = 'floor-main';\n    \n    const floorDiv = document.createElement('div');\n    floorDiv.className = 'level';\n    floorDiv.dataset.floorKey = floor.key;\n    \n    const titleDiv = document.createElement('div');\n    titleDiv.className = 'level-title';\n    titleDiv.textContent = floor.name;\n    floorDiv.appendChild(titleDiv);\n    \n    const gridDiv = document.createElement('div');\n    gridDiv.className = 'room-grid';\n    \n    let currentPos = 1;\n    floorRooms.forEach(room => {\n        if (room.start > currentPos) {\n            const emptySize = room.start - currentPos;\n            const emptyDiv = document.createElement('div');\n            emptyDiv.className = 'placeholder';\n            emptyDiv.style.flexGrow = emptySize;\n            gridDiv.appendChild(emptyDiv);\n        }\n        \n        const roomCard = createRoomCard(room, targetDoc);\n        gridDiv.appendChild(roomCard);\n        currentPos = room.end + 1;\n    });\n    \n    if (currentPos <= floor.capacity) {\n        const emptySize = floor.capacity - currentPos + 1;\n        const emptyDiv = document.createElement('div');\n        emptyDiv.className = 'placeholder';\n        emptyDiv.style.flexGrow = emptySize;\n        gridDiv.appendChild(emptyDiv);\n    }\n    \n    floorDiv.appendChild(gridDiv);\n    \n    if (isBuildMode) {\n        const availableSlots = findAvailableSlots(floor.name, roomsData, floor.capacity);\n        if (availableSlots.length > 0) {\n            const addRoomBtn = document.createElement('button');\n            addRoomBtn.className = 'add-room-btn';\n            addRoomBtn.textContent = `â• åœ¨${floor.name}æ–°å»ºæˆ¿é—´`;\n            addRoomBtn.onclick = () => openAddRoomModal(floor.name, availableSlots);\n            floorDiv.appendChild(addRoomBtn);\n        }\n    }\n    \n    mainDiv.appendChild(floorDiv);\n    floorWrapper.appendChild(mainDiv);\n    \n    // å³ä¾§åŒºåŸŸ\n    const rightDiv = document.createElement('div');\n    rightDiv.className = 'floor-outdoor-right';\n    if (outdoorRooms.right) {\n        rightDiv.appendChild(createOutdoorCard(outdoorRooms.right, targetDoc));\n    }\n    floorWrapper.appendChild(rightDiv);\n    \n    return floorWrapper;\n}\n\n//====================åˆ›å»ºå®¤å¤–å¡ç‰‡====================\nfunction createOutdoorCard(outdoorRoom, targetDoc) {\n    const card = document.createElement('div');\n    card.className = 'room-card outdoor-room outdoor-card actionable';\n    card.dataset.roomName = outdoorRoom.key;\n    \n    const roomName = SafeGetValue(outdoorRoom.data, 'åç§°');\n    const nameSpan = document.createElement('span');\n    nameSpan.className = 'room-name';\n    nameSpan.textContent = roomName;\n    card.appendChild(nameSpan);\n    \n    // é˜»æ­¢æˆ¿é—´å¡ç‰‡è§¦å‘ç”»å¸ƒæ‹–åŠ¨\n    card.addEventListener('mousedown', (e) => {\n        e.stopPropagation();\n    });\n    \n    // PCç«¯ç‚¹å‡»äº‹ä»¶\n    card.onclick = (e) => {\n        e.stopPropagation();\n        handleRoomClick(card, targetDoc);\n    };\n    \n    // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶\n    card.addEventListener('touchstart', (e) => {\n        e.stopPropagation();\n    }, { passive: true });\n    \n    card.addEventListener('touchend', (e) => {\n        e.stopPropagation();\n        e.preventDefault();\n        handleRoomClick(card, targetDoc);\n        // è§¦æ‘¸åç«‹å³ç§»é™¤ç„¦ç‚¹ï¼Œé˜²æ­¢å‡ºç°ç„¦ç‚¹æ¡†\n        setTimeout(() => card.blur(), 0);\n    });\n    \n    return card;\n}\n\n// ==================== åˆ›å»ºæˆ¿é—´å¡ç‰‡ ====================\nfunction createRoomCard(room, targetDoc) {\n    const roomCard = document.createElement('div');\n    roomCard.className = 'room-card actionable';\n    roomCard.dataset.roomName = room.key;\n    roomCard.style.flexGrow = room.size;\n    \n    const roomType = SafeGetValue(room.data, 'ç±»å‹');\n    const roomName = SafeGetValue(room.data, 'åç§°', room.key);\n    const occupant = SafeGetValue(room.data, 'ä½æˆ·');\n    \n    if (roomType === 'æ‚¨çš„æˆ¿é—´') {\n        roomCard.classList.add('your-room');\n    } else if (roomType === 'å›ºå®šè®¾æ–½') {\n        roomCard.classList.add('fixed-room');\n    } else if (roomType === 'å§å®¤') {\n        roomCard.classList.add('bedroom-room');\n    } else if (roomType === 'åŠŸèƒ½æ€§æˆ¿é—´') {\n        roomCard.classList.add('functional-room');\n    } else {\n        roomCard.classList.add('empty-room');\n    }\n    \n    const nameSpan = document.createElement('span');\n    nameSpan.className = 'room-name';\n    nameSpan.textContent = roomType === 'æ‚¨çš„æˆ¿é—´' ? 'ğŸ‘‘ ' + roomName : roomName;\n    roomCard.appendChild(nameSpan);\n    \n    if (roomType === 'å§å®¤') {\n        const occupantSpan = document.createElement('span');\n        occupantSpan.className = 'room-occupant';\n        if (occupant !== 'æœªçŸ¥' && occupant !== '<user>') {\n            occupantSpan.textContent = `å…¥ä½: ${occupant}`;\n            roomCard.dataset.occupant = occupant;\n        } else {\n            occupantSpan.textContent = '(ç©º)';\n        }\n        roomCard.appendChild(occupantSpan);\n    }\n    \n    // é˜»æ­¢æˆ¿é—´å¡ç‰‡è§¦å‘ç”»å¸ƒæ‹–åŠ¨\n    roomCard.addEventListener('mousedown', (e) => {\n        e.stopPropagation();\n    });\n    \n    // PCç«¯ç‚¹å‡»äº‹ä»¶\n    roomCard.onclick = (e) => {\n        e.stopPropagation();\n        handleRoomClick(roomCard, targetDoc);\n    };\n    \n    // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶\n    roomCard.addEventListener('touchstart', (e) => {\n        e.stopPropagation();\n    }, { passive: true });\n    \n    roomCard.addEventListener('touchend', (e) => {\n        e.stopPropagation();\n        e.preventDefault();\n        handleRoomClick(roomCard, targetDoc);\n        // è§¦æ‘¸åç«‹å³ç§»é™¤ç„¦ç‚¹ï¼Œé˜²æ­¢å‡ºç°ç„¦ç‚¹æ¡†\n        setTimeout(() => roomCard.blur(), 0);\n    });\n    \n    return roomCard;\n}\n\n// ==================== æˆ¿é—´ç‚¹å‡»å¤„ç† ====================\nfunction handleRoomClick(roomCard, targetDoc) {\n    if (isBuildMode) {\n        openManagementMenu(roomCard, targetDoc);\n    } else {\n        showTenantInfoModal(roomCard, targetDoc);\n    }\n}\n\n// ==================== ç§Ÿå®¢ä¿¡æ¯æ˜¾ç¤º ====================\nasync function showTenantInfoModal(roomCard, targetDoc) {\n    try {\n        // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™é‡æ–°è·å–\n        let data = cachedMVUData;\n        if (!data && typeof Mvu !== 'undefined') {\n            let targetMessageId = 'latest';\n            if (typeof getLastMessageId === 'function') {\n                targetMessageId = getLastMessageId();\n            }\n            const mvuResult = Mvu.getMvuData({ type: 'message', message_id: targetMessageId });\n            data = mvuResult?.stat_data;\n        }\n        if (!data) return;\n        const roomNameKey = roomCard.dataset.roomName;\n        const occupantName = roomCard.dataset.occupant;\n        \n        if (!occupantName) {\n            openInfoModal(roomCard, targetDoc, data);\n            return;\n        }\n        \n        // æŸ¥æ‰¾ç§Ÿå®¢æ•°æ®\n        let tenantData = null;\n        const tenantList = data.ç§Ÿå®¢åˆ—è¡¨?.[0];\n        if (tenantList) {\n            for (const key in tenantList) {\n                if (key === '$meta') continue;\n                if (key === occupantName) {\n                    tenantData = tenantList[key];\n                    break;\n                }\n            }\n        }\n        \n        if (tenantData) {\n            targetDoc.getElementById('info-modal-title').textContent = occupantName;\n            targetDoc.getElementById('info-modal-subtitle').textContent = `${SafeGetValue(tenantData, 'èŒä¸š')} | ${SafeGetValue(tenantData, 'å¹´é¾„')}å²`;\n            \n            const favorability = parseInt(SafeGetValue(tenantData, 'å¥½æ„Ÿåº¦', '0'), 10);\n            const lust = parseInt(SafeGetValue(tenantData, 'æ€§æ¬²', '0'), 10);\n            const daysHere = parseInt(SafeGetValue(tenantData, 'å…¥ä½å¤©æ•°', '0'), 10);\n            const rent = SafeGetValue(tenantData, 'æœˆç§Ÿé‡‘', '1500');\n            const rentPaid = SafeGetValue(tenantData, 'æœ¬æœˆå·²ç¼´ç§Ÿ', 'false') === 'true';\n            \n            let detailsHTML = '<ul>';\n            detailsHTML += `<li><strong>å¤–è²Œ:</strong> ${SafeGetValue(tenantData, 'å¤–è²Œ')}</li>`;\n            detailsHTML += `<li><strong>æ€§æ ¼:</strong> ${SafeGetValue(tenantData, 'æ€§æ ¼')}</li>`;\n            detailsHTML += `<li><strong>æ‹æƒ…:</strong> ${SafeGetValue(tenantData, 'æ‹æƒ…')}</li>`;\n            detailsHTML += `<li><strong>å½“å‰ä½ç½®:</strong> ${SafeGetValue(tenantData, 'å½“å‰ä½ç½®')}</li>`;\n            detailsHTML += `<li><strong>å†…å¿ƒ:</strong> ${SafeGetValue(tenantData, 'å†…å¿ƒ')}</li>`;\n            detailsHTML += `<li><strong>çŠ¶æ€:</strong> ${SafeGetValue(tenantData, 'çŠ¶æ€')}</li>`;\n            detailsHTML += `<li><strong>ç©¿æ­:</strong> ${SafeGetValue(tenantData, 'ç©¿æ­')}</li>`;\n            \n            detailsHTML += `<hr style=\"margin: 8px 0; border: none; border-top: 1px solid var(--theme-border-color);\">`;\n            detailsHTML += `<li><strong>å…¥ä½æ—¥æœŸ:</strong> ${SafeGetValue(tenantData, 'å…¥ä½æ—¥æœŸ')}</li>`;\n            detailsHTML += `<li><strong>å…¥ä½å¤©æ•°:</strong> ${daysHere}å¤©</li>`;\n            detailsHTML += `<li><strong>æœˆç§Ÿé‡‘:</strong> Â¥${rent} ${rentPaid ? 'âœ…å·²ç¼´' : 'âš ï¸æœªç¼´'}</li>`;\n            \n            // âš ï¸ äººé™…å…³ç³»å­—æ®µå·²ç§»é™¤ï¼Œè¯·ç‚¹å‡»åº•éƒ¨\"å…³ç³»\"æŒ‰é’®æŸ¥çœ‹å…³ç³»ç½‘ç»œ\n            \n            detailsHTML += `<hr style=\"margin: 8px 0; border: none; border-top: 1px solid var(--theme-border-color);\">`;\n            detailsHTML += `<li>\n                                <strong>å¥½æ„Ÿåº¦:</strong>\n                                <div class=\"progress-bar-container\">\n                                    <div class=\"progress-bar\"><div class=\"progress-bar-fill progress-bar-favor\" style=\"width: ${favorability}%\"></div></div>\n                                    <span class=\"progress-value\">${favorability}</span>\n                                </div>\n                             </li>`;\n            detailsHTML += `<li>\n                                <strong>æ€§æ¬²:</strong>\n                                <div class=\"progress-bar-container\">\n                                    <div class=\"progress-bar\"><div class=\"progress-bar-fill progress-bar-lust\" style=\"width: ${lust}%\"></div></div>\n                                    <span class=\"progress-value\">${lust}</span>\n                                </div>\n                             </li>`;\n            detailsHTML += '</ul>';\n            targetDoc.getElementById('info-modal-details').innerHTML = detailsHTML;\n        } else {\n            targetDoc.getElementById('info-modal-title').textContent = occupantName;\n            targetDoc.getElementById('info-modal-subtitle').textContent = \"ç§Ÿå®¢ä¿¡æ¯æœªæ‰¾åˆ°\";\n            targetDoc.getElementById('info-modal-details').innerHTML = \"<p style='padding: 10px 0;'>æ— æ³•æ‰¾åˆ°è¯¥ç§Ÿå®¢çš„è¯¦ç»†ä¿¡æ¯</p>\";\n        }\n        targetDoc.getElementById('info-modal').classList.remove('hidden');\n    } catch (e) {\n        console.error(\"æ˜¾ç¤ºç§Ÿå®¢ä¿¡æ¯æ—¶å‡ºé”™: \", e);\n    }\n}\n\nasync function openInfoModal(roomCard, targetDoc, data) {\n    if (!data) {\n        data = cachedMVUData;\n        if (!data && typeof Mvu !== 'undefined') {\n            let targetMessageId = 'latest';\n            if (typeof getLastMessageId === 'function') {\n                targetMessageId = getLastMessageId();\n            }\n            const mvuResult = Mvu.getMvuData({ type: 'message', message_id: targetMessageId });\n            data = mvuResult?.stat_data;\n        }\n    }\n    const roomNameKey = roomCard.dataset.roomName;\n    const roomData = data.å…¬å¯“?.æˆ¿é—´åˆ—è¡¨?.[0]?.[roomNameKey];\n    \n    const roomType = SafeGetValue(roomData, 'ç±»å‹');\n    const roomName = SafeGetValue(roomData, 'åç§°', roomNameKey);\n    const description = SafeGetValue(roomData, 'æè¿°', 'æ— ');\n    \n    targetDoc.getElementById('info-modal-title').textContent = roomName;\n    targetDoc.getElementById('info-modal-subtitle').textContent = `ç±»å‹ï¼š${roomType}`;\n    targetDoc.getElementById('info-modal-details').innerHTML = `<p style=\"padding: 10px 0;\"><strong>æˆ¿é—´æè¿°:</strong> ${description}</p>`;\n    targetDoc.getElementById('info-modal').classList.remove('hidden');\n}\n\n// ==================== æ ¼å­é€‰æ‹©å™¨ ====================\nlet gridSelectionState = { start: null, end: null, isSelecting: false };\n\nfunction openAddRoomModal(floorName, availableSlots) {\n    const targetDoc = window.top ? window.top.document : document;\n    currentFloorForNewRoom = floorName;\n    targetDoc.getElementById('add-room-modal-title').textContent = `åœ¨ã€${floorName}ã€‘æ–°å»ºç©ºæˆ¿é—´`;\n    targetDoc.getElementById('add-room-modal-subtitle').textContent = `æ–°å»ºçš„æˆ¿é—´å°†ä½œä¸º\"ç©ºæˆ¿é—´\"ï¼ˆå ä½ä½†æœªè£…ä¿®ï¼‰ï¼Œä¹‹åå¯åœ¨å»ºé€ æ¨¡å¼ä¸‹è£…ä¿®\\nå¯ç”¨ç©ºä½ï¼š${availableSlots.map(s => `${s.start}-${s.end}`).join(', ')}`;\n    \n    gridSelectionState = { start: null, end: null, isSelecting: false };\n    \n    const gridContainer = targetDoc.getElementById('grid-selector');\n    gridContainer.innerHTML = '';\n    \n    // ç¡®å®šå·²å ç”¨çš„ä½ç½®\n    const occupiedSlots = new Set();\n    if (cachedMVUData) {\n        const roomsData = cachedMVUData.å…¬å¯“?.æˆ¿é—´åˆ—è¡¨?.[0];\n        if (roomsData) {\n            for (const roomKey in roomsData) {\n                if (roomKey === '$meta') continue;\n                const roomData = roomsData[roomKey];\n                const layout = roomData?.å¸ƒå±€;\n                if (layout && SafeGetValue(layout, 'æ¥¼å±‚') === floorName) {\n                    const position = SafeGetValue(layout, 'ä½ç½®', '1-2');\n                    if (position !== 'outdoor-left' && position !== 'outdoor-right') {\n                        const pos = parsePosition(position);\n                        for (let i = pos.start; i <= pos.end; i++) {\n                            occupiedSlots.add(i);\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \n    // åˆ›å»º10ä¸ªæ ¼å­\n    for (let i = 1; i <= 10; i++) {\n        const cell = document.createElement('div');\n        cell.className = 'grid-cell';\n        cell.dataset.position = i;\n        cell.textContent = i;\n        \n        if (occupiedSlots.has(i)) {\n            cell.classList.add('occupied');\n            cell.title = 'å·²å ç”¨';\n        } else {\n            cell.addEventListener('mousedown', () => handleGridSelect(i, occupiedSlots, targetDoc));\n            cell.addEventListener('mouseenter', () => {\n                if (gridSelectionState.isSelecting) {\n                    updateGridSelection(i, occupiedSlots, targetDoc);\n                }\n            });\n            cell.addEventListener('touchstart', (e) => {\n                e.preventDefault();\n                handleGridSelect(i, occupiedSlots, targetDoc);\n            });\n        }\n        \n        gridContainer.appendChild(cell);\n    }\n    \n    const handleEnd = () => {\n        gridSelectionState.isSelecting = false;\n    };\n    document.addEventListener('mouseup', handleEnd, { once: true });\n    document.addEventListener('touchend', handleEnd, { once: true });\n    \n    updateSelectionDisplay(targetDoc);\n    targetDoc.getElementById('add-room-modal').classList.remove('hidden');\n}\n\nfunction handleGridSelect(position, occupiedSlots, targetDoc) {\n    if (occupiedSlots.has(position)) return;\n    \n    gridSelectionState.start = position;\n    gridSelectionState.end = position;\n    gridSelectionState.isSelecting = true;\n    updateGridSelection(position, occupiedSlots, targetDoc);\n}\n\nfunction updateGridSelection(position, occupiedSlots, targetDoc) {\n    if (!gridSelectionState.start) return;\n    \n    const start = Math.min(gridSelectionState.start, position);\n    const end = Math.max(gridSelectionState.start, position);\n    \n    let valid = true;\n    for (let i = start; i <= end; i++) {\n        if (occupiedSlots.has(i)) {\n            valid = false;\n            break;\n        }\n    }\n    \n    if (valid) {\n        gridSelectionState.end = position;\n    }\n    \n    const cells = targetDoc.querySelectorAll('.grid-cell');\n    cells.forEach(cell => {\n        const pos = parseInt(cell.dataset.position);\n        if (!occupiedSlots.has(pos)) {\n            const finalStart = Math.min(gridSelectionState.start, gridSelectionState.end);\n            const finalEnd = Math.max(gridSelectionState.start, gridSelectionState.end);\n            \n            if (pos >= finalStart && pos <= finalEnd) {\n                cell.classList.add('selected');\n            } else {\n                cell.classList.remove('selected');\n            }\n        }\n    });\n    \n    updateSelectionDisplay(targetDoc);\n}\n\nfunction updateSelectionDisplay(targetDoc) {\n    const display = targetDoc.getElementById('selected-range-display');\n    if (gridSelectionState.start && gridSelectionState.end) {\n        const start = Math.min(gridSelectionState.start, gridSelectionState.end);\n        const end = Math.max(gridSelectionState.start, gridSelectionState.end);\n        const size = end - start + 1;\n        display.textContent = `å·²é€‰æ‹©: ${start}-${end} (å¤§å°: ${size} æ ¼)`;\n        display.style.color = '#28a745';\n        display.style.fontWeight = 'bold';\n    } else {\n        display.textContent = 'è¯·é€‰æ‹©æˆ¿é—´ä½ç½®';\n        display.style.color = 'var(--theme-subtitle-color)';\n        display.style.fontWeight = 'normal';\n    }\n}\n\n// ==================== å…¶ä»–æ¨¡æ€æ¡†å‡½æ•° ====================\nfunction openAddFloorModal(position) {\n    const targetDoc = window.top ? window.top.document : document;\n    targetDoc.getElementById('add-floor-position').value = position;\n    targetDoc.getElementById('add-floor-modal').classList.remove('hidden');\n}\n\nfunction openManagementMenu(roomCard, targetDoc) {\n    currentEditingRoomName = roomCard.dataset.roomName;\n    const roomType = SafeGetValue(cachedMVUData, `å…¬å¯“.æˆ¿é—´åˆ—è¡¨.0.${currentEditingRoomName}.ç±»å‹`);\n    const occupant = roomCard.dataset.occupant;\n    \n    targetDoc.getElementById('management-modal-title').textContent = currentEditingRoomName;\n    targetDoc.getElementById('management-modal-subtitle').textContent = `ç±»å‹ï¼š${roomType}`;\n    \n    const choicesDiv = targetDoc.getElementById('management-modal-choices');\n    choicesDiv.innerHTML = '';\n    \n    // ========== ç©ºæˆ¿é—´ï¼ˆæœªè£…ä¿®ï¼‰ï¼šå¯ä»¥è£…ä¿®æˆ–åˆ é™¤ ==========\n    if (roomType === 'ç©ºæˆ¿é—´') {\n        const decorateBtn = document.createElement('button');\n        decorateBtn.textContent = 'ğŸ  è£…ä¿®ä¸ºå§å®¤';\n        decorateBtn.onclick = () => {\n            const command = `å°†ã€${currentEditingRoomName}ã€‘è£…ä¿®ä¸ºå§å®¤ï¼Œè¯·æ‰§è¡Œï¼š\n_.set('å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0].${currentEditingRoomName}.ç±»å‹[0]', 'ç©ºæˆ¿é—´', 'å§å®¤')\n\nè¯·åŒæ—¶æ›´æ–°æè¿°å­—æ®µï¼Œæ·»åŠ é€‚åˆå§å®¤çš„æè¿°ï¼ˆä¾‹å¦‚ï¼š\"æ¸©é¦¨èˆ’é€‚çš„å§å®¤\"ï¼‰`;\n            fillCommand(command);\n            closeAllModals();\n        };\n        choicesDiv.appendChild(decorateBtn);\n        \n        const functionalBtn = document.createElement('button');\n        functionalBtn.textContent = 'ğŸ¨ è£…ä¿®ä¸ºåŠŸèƒ½æ€§æˆ¿é—´';\n        functionalBtn.onclick = () => {\n            const roomPurpose = prompt('è¯·è¾“å…¥æˆ¿é—´ç”¨é€”åç§°ï¼ˆä¾‹å¦‚ï¼šä¹¦æˆ¿ã€å¥èº«æˆ¿ï¼‰');\n            if (roomPurpose) {\n                const command = `å°†ã€${currentEditingRoomName}ã€‘è£…ä¿®ä¸ºåŠŸèƒ½æ€§æˆ¿é—´ã€${roomPurpose}ã€‘ï¼Œè¯·æ‰§è¡Œï¼š\n_.set('å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0].${currentEditingRoomName}.ç±»å‹[0]', 'ç©ºæˆ¿é—´', 'åŠŸèƒ½æ€§æˆ¿é—´')\n_.set('å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0].${currentEditingRoomName}.åç§°[0]', '${currentEditingRoomName}', '${roomPurpose}')\n\nè¯·åŒæ—¶æ›´æ–°æè¿°å­—æ®µï¼Œæ·»åŠ å…³äºã€${roomPurpose}ã€‘çš„è¯¦ç»†æè¿°ï¼ˆä¾‹å¦‚è®¾æ–½ã€åŠŸèƒ½ç­‰ï¼‰`;\n                fillCommand(command);\n                closeAllModals();\n            }\n        };\n        choicesDiv.appendChild(functionalBtn);\n        \n        const deleteBtn = document.createElement('button');\n        deleteBtn.textContent = 'ğŸ—‘ï¸ åˆ é™¤æˆ¿é—´';\n        deleteBtn.className = 'danger-btn';\n        deleteBtn.onclick = () => {\n            const command = `åˆ é™¤æˆ¿é—´ã€${currentEditingRoomName}ã€‘ï¼Œé‡Šæ”¾è¯¥ä½ç½®ï¼Œè¯·æ‰§è¡Œï¼š\n_.remove('å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0]', '${currentEditingRoomName}')`;\n            fillCommand(command);\n            closeAllModals();\n        };\n        choicesDiv.appendChild(deleteBtn);\n    }\n    // ========== å§å®¤ï¼ˆæœ‰ä½æˆ·ï¼‰ï¼šåªèƒ½è®©ç§Ÿå®¢é€€ç§Ÿ ==========\n    else if (roomType === 'å§å®¤' && occupant && occupant !== 'æœªçŸ¥') {\n        const evictBtn = document.createElement('button');\n        evictBtn.textContent = 'ğŸšª è®©ç§Ÿå®¢é€€ç§Ÿ';\n        evictBtn.className = 'danger-btn';\n        evictBtn.onclick = () => {\n            const command = `è®©ç§Ÿå®¢ã€${occupant}ã€‘ä»ã€${currentEditingRoomName}ã€‘é€€ç§Ÿï¼Œè¯·æ‰§è¡Œï¼š\n_.set('å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0].${currentEditingRoomName}.ä½æˆ·[0]', '${occupant}', 'æœªçŸ¥')\n_.remove('ç§Ÿå®¢åˆ—è¡¨[0]', '${occupant}')\n\nåŒæ—¶ç¦ç”¨Chat Loreä¸­çš„ç§Ÿå®¢ä¿¡æ¯ï¼ˆé˜²æ­¢AIç»§ç»­æåŠè¯¥ç§Ÿå®¢ï¼‰ï¼š\n/getchatbook | /findentry file={{pipe}} field=key ${occupant} | /setentryfield file={{pipe:1}} uid={{pipe:0}} field=disable 1`;\n            fillCommand(command);\n            closeAllModals();\n        };\n        choicesDiv.appendChild(evictBtn);\n    }\n    // ========== å§å®¤ï¼ˆæ— ä½æˆ·ï¼‰ï¼šåªèƒ½æ‹†é™¤è£…ä¿® ==========\n    else if (roomType === 'å§å®¤' && (!occupant || occupant === 'æœªçŸ¥')) {\n        const removeDecorationBtn = document.createElement('button');\n        removeDecorationBtn.textContent = 'ğŸ”¨ æ‹†é™¤è£…ä¿®';\n        removeDecorationBtn.className = 'danger-btn';\n        removeDecorationBtn.onclick = () => {\n            const command = `æ‹†é™¤ã€${currentEditingRoomName}ã€‘çš„è£…ä¿®ï¼Œå˜å›ç©ºæˆ¿é—´ï¼Œè¯·æ‰§è¡Œï¼š\n_.set('å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0].${currentEditingRoomName}.ç±»å‹[0]', 'å§å®¤', 'ç©ºæˆ¿é—´')\n\nè¯·åŒæ—¶æ›´æ–°æè¿°å­—æ®µï¼Œæ”¹ä¸ºï¼š\"æ–°å»ºçš„ç©ºæˆ¿é—´ï¼Œç­‰å¾…è£…ä¿®\"`;\n            fillCommand(command);\n            closeAllModals();\n        };\n        choicesDiv.appendChild(removeDecorationBtn);\n    }\n    // ========== åŠŸèƒ½æ€§æˆ¿é—´ï¼šåªèƒ½æ‹†é™¤è£…ä¿® ==========\n    else if (roomType === 'åŠŸèƒ½æ€§æˆ¿é—´') {\n        const removeDecorationBtn = document.createElement('button');\n        removeDecorationBtn.textContent = 'ğŸ”¨ æ‹†é™¤è£…ä¿®';\n        removeDecorationBtn.className = 'danger-btn';\n        removeDecorationBtn.onclick = () => {\n            const currentName = SafeGetValue(cachedMVUData, `å…¬å¯“.æˆ¿é—´åˆ—è¡¨.0.${currentEditingRoomName}.åç§°`);\n            const command = `æ‹†é™¤ã€${currentEditingRoomName}ã€‘ï¼ˆå½“å‰åç§°ï¼š${currentName}ï¼‰çš„è£…ä¿®ï¼Œå˜å›ç©ºæˆ¿é—´ï¼Œè¯·æ‰§è¡Œï¼š\n_.set('å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0].${currentEditingRoomName}.ç±»å‹[0]', 'åŠŸèƒ½æ€§æˆ¿é—´', 'ç©ºæˆ¿é—´')\n_.set('å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0].${currentEditingRoomName}.åç§°[0]', '${currentName}', '${currentEditingRoomName}')\n\nè¯·åŒæ—¶æ›´æ–°æè¿°å­—æ®µï¼Œæ”¹ä¸ºï¼š\"æ–°å»ºçš„ç©ºæˆ¿é—´ï¼Œç­‰å¾…è£…ä¿®\"`;\n            fillCommand(command);\n            closeAllModals();\n        };\n        choicesDiv.appendChild(removeDecorationBtn);\n    }\n    // ========== å›ºå®šè®¾æ–½/æ‚¨çš„æˆ¿é—´/å®¤å¤–åŒºåŸŸï¼šä¸å¯æ“ä½œ ==========\n    else if (roomType === 'å›ºå®šè®¾æ–½' || roomType === 'æ‚¨çš„æˆ¿é—´' || roomType === 'å®¤å¤–åŒºåŸŸ') {\n        const infoText = document.createElement('p');\n        infoText.textContent = 'è¯¥åŒºåŸŸä¸å¯ä¿®æ”¹æˆ–æ‹†é™¤';\n        infoText.style.cssText = 'padding: 20px; text-align: center; color: var(--theme-subtitle-color);';\n        choicesDiv.appendChild(infoText);\n    }\n    \n    targetDoc.getElementById('management-modal').classList.remove('hidden');\n}\n\n// ==================== å‘½ä»¤ç”Ÿæˆ ====================\nfunction confirmAddRoom() {\n    const targetDoc = window.top ? window.top.document : document;\n    const floorName = currentFloorForNewRoom;\n    \n    if (!gridSelectionState.start || !gridSelectionState.end) {\n        alert('è¯·å…ˆé€‰æ‹©æˆ¿é—´ä½ç½®ï¼');\n        return;\n    }\n    \n    const start = Math.min(gridSelectionState.start, gridSelectionState.end);\n    const end = Math.max(gridSelectionState.start, gridSelectionState.end);\n    const position = `${start}-${end}`;\n    \n    // ç”Ÿæˆå‹å¥½çš„æˆ¿é—´åç§°ï¼ˆæ™ºèƒ½åˆ†é…ç¼–å·ï¼Œé¿å…é‡å¤ï¼‰\n    const chineseNumbers = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”'];\n    \n    // ğŸ”§ æ”¶é›†è¯¥æ¥¼å±‚å·²ä½¿ç”¨çš„æˆ¿é—´ç¼–å·\n    const usedNumbers = new Set();\n    if (cachedMVUData && cachedMVUData.å…¬å¯“ && cachedMVUData.å…¬å¯“.æˆ¿é—´åˆ—è¡¨) {\n        const roomsData = cachedMVUData.å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0];\n        if (roomsData) {\n            for (const roomKey in roomsData) {\n                if (roomKey === '$meta') continue;\n                const roomData = roomsData[roomKey];\n                const layout = roomData?.å¸ƒå±€;\n                if (layout && SafeGetValue(layout, 'æ¥¼å±‚') === floorName) {\n                    // æå–æˆ¿é—´ç¼–å·ï¼ˆä¾‹å¦‚ä»\"å››æ¥¼æˆ¿é—´ä¸‰\"ä¸­æå–\"ä¸‰\"ï¼‰\n                    const match = roomKey.match(/æˆ¿é—´(.+)$/);\n                    if (match) {\n                        usedNumbers.add(match[1]);\n                    }\n                }\n            }\n        }\n    }\n    \n    // ğŸ”§ åŠ ä¸Šä¸´æ—¶è®¡æ•°å™¨ä¸­å·²åˆ†é…çš„ç¼–å·\n    if (!tempRoomCounters[floorName]) {\n        tempRoomCounters[floorName] = [];\n    }\n    tempRoomCounters[floorName].forEach(num => usedNumbers.add(num));\n    \n    // ğŸ”§ æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„ç¼–å·\n    let roomNumber = null;\n    for (let i = 0; i < chineseNumbers.length; i++) {\n        if (!usedNumbers.has(chineseNumbers[i])) {\n            roomNumber = chineseNumbers[i];\n            break;\n        }\n    }\n    \n    // å¦‚æœä¸­æ–‡æ•°å­—ç”¨å®Œäº†ï¼Œç”¨é˜¿æ‹‰ä¼¯æ•°å­—\n    if (!roomNumber) {\n        let numIndex = chineseNumbers.length + 1;\n        while (usedNumbers.has(numIndex.toString())) {\n            numIndex++;\n        }\n        roomNumber = numIndex.toString();\n    }\n    \n    // è®°å½•åˆ°ä¸´æ—¶è®¡æ•°å™¨\n    tempRoomCounters[floorName].push(roomNumber);\n    \n    // ç”Ÿæˆæˆ¿é—´åï¼šå››æ¥¼æˆ¿é—´ä¸€ã€å››æ¥¼æˆ¿é—´äºŒ...\n    const roomName = `${floorName}æˆ¿é—´${roomNumber}`;\n    \n    const command = `åœ¨ã€${floorName}ã€‘æ–°å»ºç©ºæˆ¿é—´ã€${roomName}ã€‘ï¼ˆå æ®ä½ç½®ä½†æœªè£…ä¿®ï¼Œä¹‹åå¯è£…ä¿®ä¸ºå§å®¤æˆ–åŠŸèƒ½æ€§æˆ¿é—´ï¼‰ï¼Œè¯·æ‰§è¡Œï¼š\n_.insert('å…¬å¯“.æˆ¿é—´åˆ—è¡¨[0]', '${roomName}', {\n  \"ç±»å‹\": [\"ç©ºæˆ¿é—´\", \"æˆ¿é—´ç±»å‹\"],\n  \"åç§°\": [\"${roomName}\", \"æˆ¿é—´åç§°\"],\n  \"ä½æˆ·\": [\"æœªçŸ¥\", \"å½“å‰ä½æˆ·\"],\n  \"æè¿°\": [\"æ–°å»ºçš„ç©ºæˆ¿é—´ï¼Œç­‰å¾…è£…ä¿®\", \"è¯¦ç»†æè¿°\"],\n  \"å¸ƒå±€\": { \"æ¥¼å±‚\": \"${floorName}\", \"ä½ç½®\": \"${position}\" }\n})`;\n    \n    fillCommand(command);\n    closeAllModals();\n}\n\nfunction confirmAddFloor() {\n    const targetDoc = window.top ? window.top.document : document;\n    const floorName = targetDoc.getElementById('add-floor-name').value.trim();\n    const position = targetDoc.getElementById('add-floor-position').value;\n    \n    if (!floorName) {\n        alert('è¯·è¾“å…¥æ¥¼å±‚åç§°ï¼');\n        return;\n    }\n    \n    const command = `æ–°å»ºæ¥¼å±‚ã€${floorName}ã€‘ï¼ˆ${position === 'top' ? 'å‘ä¸Šæ‰©å±•' : 'å‘ä¸‹æ‰©å±•'}ï¼‰ï¼Œè¯·æ‰§è¡Œï¼š\n_.insert('å…¬å¯“.æ¥¼å±‚é…ç½®', '${floorName}', {\n  \"æ˜¾ç¤ºåç§°\": [\"${floorName}\", \"æ˜¾ç¤ºåç§°\"],\n  \"æ€»å®¹é‡\": [10, \"æ€»å®¹é‡\"],\n  \"é¡ºåº\": [${position === 'top' ? '5' : '-2'}, \"é¡ºåºå€¼\"]\n})\n\nç„¶ååˆ·æ–°çŠ¶æ€æ å³å¯çœ‹åˆ°æ–°æ¥¼å±‚ã€‚`;\n    \n    fillCommand(command);\n    closeAllModals();\n}\n\nfunction confirmRecruitment() {\n    const targetDoc = window.top ? window.top.document : document;\n    const keywords = targetDoc.getElementById('recruitment-keywords').value.trim();\n    const command = `æ‹›å‹Ÿä¸€åç¬¦åˆä»¥ä¸‹ç‰¹å¾çš„ç§Ÿå®¢ï¼š${keywords}`;\n    fillCommand(command);\n    closeAllModals();\n}\n\nfunction fillCommand(command) {\n    try {\n        const chatInput = parent.document.querySelector('#send_textarea');\n        if (chatInput) {\n            if (chatInput.value.trim() !== '') {\n                chatInput.value += '\\n' + command;\n            } else { \n                chatInput.value = command;\n            }\n            chatInput.focus();\n        } else {\n            throw new Error();\n        }\n    } catch (e) {\n        alert('æœªèƒ½è‡ªåŠ¨æ‰¾åˆ°è¾“å…¥æ¡†ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š\\n\\n' + command);\n    }\n}\n\n// ==================== å…¶ä»–åŠŸèƒ½ ====================\nfunction closeAllModals() {\n    const targetDoc = window.top ? window.top.document : document;\n    const allModals = targetDoc.querySelectorAll('.modal-overlay');\n    allModals.forEach(modal => modal.classList.add('hidden'));\n}\n\nfunction openRecruitmentModal() {\n    const targetDoc = window.top ? window.top.document : document;\n    targetDoc.getElementById('recruitment-modal').classList.remove('hidden');\n}\n\nfunction openSettingsModal() {\n    const targetDoc = window.top ? window.top.document : document;\n    targetDoc.getElementById('settings-modal').classList.remove('hidden');\n}\n\nfunction switchTheme(theme) {\n    const targetDoc = window.top ? window.top.document : document;\n    const panel = targetDoc.getElementById('apartment-main-panel');\n    if (theme === 'dark') {\n        panel.classList.add('dark-theme');\n    } else { \n        panel.classList.remove('dark-theme');\n    }\n}\n\nfunction openHistoryModal() {\n    const targetDoc = window.top ? window.top.document : document;\n    const data = cachedMVUData;\n    if (!data) return;\n    \n    // MVUæ ¼å¼ï¼š[æ•°æ®æ•°ç»„, æè¿°æ–‡æœ¬]ï¼Œéœ€è¦ç”¨[0]è·å–å®é™…æ•°æ®æ•°ç»„\n    const historyArray = data.äº‹ä»¶å†å²?.[0];\n    const contentDiv = targetDoc.getElementById('history-content');\n    \n    const events = [];\n    if (historyArray && Array.isArray(historyArray)) {\n        for (let i = 0; i < historyArray.length; i++) {\n            const item = historyArray[i];\n            // è·³è¿‡å…ƒæ•°æ®æ ‡è®°\n            if (item === \"$__META_EXTENSIBLE__$\") continue;\n            if (typeof item === 'string') {\n                events.push(item);\n            }\n        }\n    }\n    \n    if (events.length === 0) {\n        contentDiv.innerHTML = '<p style=\"color: var(--theme-subtitle-color); text-align: center;\">æš‚æ— äº‹ä»¶è®°å½•</p>';\n    } else {\n        let html = '<div style=\"line-height: 1.8;\">';\n        events.forEach(event => {\n            html += `<div style=\"padding: 8px 0; border-bottom: 1px solid var(--theme-border-color);\">ğŸ“Œ ${event}</div>`;\n        });\n        html += '</div>';\n        contentDiv.innerHTML = html;\n    }\n    \n    targetDoc.getElementById('history-modal').classList.remove('hidden');\n}\n\nfunction openAchievementModal() {\n    const targetDoc = window.top ? window.top.document : document;\n    const data = cachedMVUData;\n    if (!data) return;\n    \n    // MVUæ ¼å¼ï¼š[æ•°æ®æ•°ç»„, æè¿°æ–‡æœ¬]ï¼Œéœ€è¦ç”¨[0]è·å–å®é™…æ•°æ®æ•°ç»„\n    const achievementsArray = data.æˆå°±åˆ—è¡¨?.[0];\n    const contentDiv = targetDoc.getElementById('achievement-content');\n    \n    // æ”¶é›†æ‰€æœ‰æˆå°±\n    const achievementList = [];\n    \n    if (achievementsArray && Array.isArray(achievementsArray)) {\n        achievementsArray.forEach((item, index) => {\n            // è·³è¿‡å…ƒæ•°æ®æ ‡è®°\n            if (item === \"$__META_EXTENSIBLE__$\") return;\n            \n            if (typeof item === 'string') {\n                // è§£ææ ¼å¼ï¼š\"æˆå°±å - æˆå°±æè¿°\"\n                const parts = item.split(' - ');\n                if (parts.length >= 2) {\n                    achievementList.push({\n                        name: parts[0].trim(),\n                        desc: parts.slice(1).join(' - ').trim(),\n                        achieved: true,\n                        date: 'æœªçŸ¥'\n                    });\n                } else {\n                    // å¦‚æœæ²¡æœ‰æŒ‰ç…§æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨æ•´ä¸ªå­—ç¬¦ä¸²ä½œä¸ºæè¿°\n                    achievementList.push({\n                        name: `æˆå°± ${achievementList.length + 1}`,\n                        desc: item,\n                        achieved: true,\n                        date: 'æœªçŸ¥'\n                    });\n                }\n            }\n        });\n    }\n    \n    if (achievementList.length === 0) {\n        contentDiv.innerHTML = '<p style=\"color: var(--theme-subtitle-color); text-align: center;\">æš‚æ— æˆå°±<br><small style=\"font-size: 0.85em;\">AIä¼šåœ¨è¾¾æˆç‰¹å®šæ¡ä»¶æ—¶è‡ªåŠ¨æ·»åŠ æˆå°±</small></p>';\n    } else { \n        let html = '<div style=\"display: grid; gap: 15px;\">';\n        achievementList.forEach(achievement => {\n            html += `<div style=\"padding: 15px; background-color: ${achievement.achieved ? 'var(--color-outdoor)' : 'var(--theme-phone-bg)'}; border-radius: 8px; border: 1px solid var(--theme-border-color);\">\n                <div style=\"font-weight: bold; margin-bottom: 5px;\">${achievement.achieved ? 'ğŸ†' : 'ğŸ”’'} ${achievement.name}</div>\n                <div style=\"font-size: 0.9em; color: var(--theme-subtitle-color);\">${achievement.desc}</div>\n                ${achievement.achieved && achievement.date !== 'æœªçŸ¥' ? `<div style=\"font-size: 0.8em; color: var(--theme-subtitle-color); margin-top: 5px;\">è¾¾æˆäºï¼š${achievement.date}</div>` : ''}\n            </div>`;\n        });\n        html += '</div>';\n        contentDiv.innerHTML = html;\n    }\n    \n    targetDoc.getElementById('achievement-modal').classList.remove('hidden');\n}\n\n// ==================== äº‹ä»¶ç”Ÿæˆå™¨ ====================\nconst singleEventTypes = [\"ä¸ªäººæƒ…æ„Ÿç±»\", \"ç”Ÿæ´»ç»æµç±»\", \"æ—¥å¸¸å§”æ‰˜ç±»\", \"å®¶å±…ä¿®ç†ç±»\"];\nconst groupEventTypes = [\"èŠ‚æ—¥æ´¾å¯¹ç±»\", \"å®¤å†…å¨±ä¹ç±»\", \"çªå‘çŠ¶å†µç±»\", \"å…±åŒåˆ›ä½œç±»\"];\n\nfunction openEventGenerator() {\n    const targetDoc = window.top ? window.top.document : document;\n    targetDoc.getElementById('event-modal').classList.add('visible');\n}\n\nfunction closeEventGenerator() {\n    const targetDoc = window.top ? window.top.document : document;\n    targetDoc.getElementById('event-modal').classList.remove('visible');\n}\n\nfunction triggerEvent(type, category) {\n    let eventName = type;\n    if (type.startsWith('random-')) {\n        const isSingle = type.includes('single');\n        const eventList = isSingle ? singleEventTypes : groupEventTypes;\n        eventName = eventList[Math.floor(Math.random() * eventList.length)];\n        category = isSingle ? 'ä¸ªäºº' : 'é›†ä½“';\n    }\n    const command = `æˆ‘é€‰æ‹©è§¦å‘${category}éšæœºäº‹ä»¶ï¼š${eventName}ï¼Œè¯·å¸®æˆ‘ä¸æ»‘è¿‡æ¸¡ã€‚`;\n    fillCommand(command);\n    closeEventGenerator();\n}\n\n// ==================== å…³ç³»ç½‘ç»œåŠŸèƒ½ ====================\nfunction openRelationModal() {\n    const targetDoc = window.top ? window.top.document : document;\n    const data = cachedMVUData;\n    if (!data) return;\n    \n    const tenantList = data.ç§Ÿå®¢åˆ—è¡¨?.[0];\n    const contentDiv = targetDoc.getElementById('relation-content');\n    \n    if (!tenantList || Object.keys(tenantList).filter(k => k !== '$meta').length === 0) {\n        contentDiv.innerHTML = '<p style=\"color: var(--theme-subtitle-color); text-align: center;\">æš‚æ— ç§Ÿå®¢æ•°æ®</p>';\n        targetDoc.getElementById('relation-modal').classList.remove('hidden');\n        return;\n    }\n    \n    // æ„å»ºç§Ÿå®¢åˆ—è¡¨ï¼ˆä¸åŒ…æ‹¬<user>ï¼Œæ”¾å¼ƒåæ¨ï¼‰\n    const tenants = [];\n    \n    for (const key in tenantList) {\n        if (key === '$meta') continue;\n        const tenant = tenantList[key];\n        const relations = tenant.å…³ç³» || {};\n        \n        tenants.push({\n            name: key,\n            displayName: key,\n            relations: relations\n        });\n    }\n    \n    // ç”Ÿæˆç•Œé¢\n    let html = '<div style=\"display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;\">';\n    \n    console.log('ğŸ“Š æ‰€æœ‰ç§Ÿå®¢æ•°æ®:', tenants);\n    \n    tenants.forEach(tenant => {\n        const relationCount = Object.keys(tenant.relations).filter(k => k !== '$meta').length;\n        console.log(`ğŸ” ç§Ÿå®¢ ${tenant.name} çš„å…³ç³»:`, tenant.relations, `æ•°é‡: ${relationCount}`);\n        html += `\n            <div class=\"tenant-relation-card\" data-tenant-name=\"${tenant.name}\"\n                 style=\"padding: 15px; background: var(--theme-modal-btn-bg); border-radius: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid var(--theme-border-color); text-align: center;\"\n                 onmouseover=\"this.style.transform='translateY(-3px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';\"\n                 onmouseout=\"this.style.transform='translateY(0)'; this.style.boxShadow='none';\">\n                <div style=\"font-size: 28px; margin-bottom: 8px;\">ğŸ‘¥</div>\n                <div style=\"font-weight: bold; margin-bottom: 5px; font-size: 14px;\">${tenant.displayName}</div>\n                <div style=\"font-size: 12px; color: var(--theme-subtitle-color);\">\n                    ${relationCount > 0 ? `${relationCount} ä¸ªå…³ç³»` : 'æš‚æ— å…³ç³»'}\n                </div>\n            </div>\n        `;\n    });\n    \n    html += '</div>';\n    contentDiv.innerHTML = html;\n    \n    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ç‚¹å‡»\n    contentDiv.removeEventListener('click', handleRelationCardClick); // å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨\n    contentDiv.addEventListener('click', handleRelationCardClick);\n    \n    targetDoc.getElementById('relation-modal').classList.remove('hidden');\n}\n\n// äº‹ä»¶å§”æ‰˜å¤„ç†å‡½æ•°\nfunction handleRelationCardClick(e) {\n    const card = e.target.closest('.tenant-relation-card');\n    if (card) {\n        const tenantName = card.dataset.tenantName;\n        console.log('ğŸ¯ ç‚¹å‡»äº†ç§Ÿå®¢å¡ç‰‡:', tenantName);\n        showCharacterRelations(tenantName);\n    }\n}\n\n// æ˜¾ç¤ºæŸä¸ªç§Ÿå®¢çš„å…³ç³»è¯¦æƒ…ï¼ˆç®€å•åˆ—è¡¨ï¼‰\nfunction showCharacterRelations(characterName) {\n    console.log('ğŸ¯ showCharacterRelations è¢«è°ƒç”¨ï¼Œè§’è‰²å:', characterName);\n    \n    const targetDoc = window.top ? window.top.document : document;\n    const data = cachedMVUData;\n    if (!data) {\n        console.error('âŒ cachedMVUData ä¸ºç©º');\n        return;\n    }\n    \n    const tenantList = data.ç§Ÿå®¢åˆ—è¡¨?.[0];\n    const contentDiv = targetDoc.getElementById('relation-content');\n    \n    if (!tenantList) {\n        console.error('âŒ tenantList ä¸ºç©º');\n        contentDiv.innerHTML = '<p style=\"color: var(--theme-subtitle-color); text-align: center;\">ç§Ÿå®¢æ•°æ®ä¸ºç©º</p>';\n        return;\n    }\n    \n    // ç›´æ¥è·å–ç§Ÿå®¢æ•°æ®\n    const tenant = tenantList[characterName];\n    if (!tenant) {\n        console.error('âŒ æœªæ‰¾åˆ°ç§Ÿå®¢:', characterName);\n        contentDiv.innerHTML = '<p style=\"color: var(--theme-subtitle-color); text-align: center;\">æœªæ‰¾åˆ°ç§Ÿå®¢æ•°æ®</p>';\n        return;\n    }\n    \n    const character = {\n        name: characterName,\n        displayName: characterName,\n        relations: tenant.å…³ç³» || {}\n    };\n    \n    console.log('âœ… æ‰¾åˆ°ç§Ÿå®¢æ•°æ®:', character);\n    \n    // æ˜¾ç¤ºç§Ÿå®¢å…³ç³»\n    let html = `\n        <div style=\"margin-bottom: 15px; text-align: center;\">\n            <button id=\"relation-back-btn\"\n                    style=\"padding: 8px 16px; background: var(--theme-modal-btn-bg); border: 1px solid var(--theme-border-color); border-radius: 8px; cursor: pointer; color: var(--theme-text-color);\">\n                â† è¿”å›åˆ—è¡¨\n            </button>\n        </div>\n        \n        <div style=\"text-align: center; margin-bottom: 20px;\">\n            <div style=\"font-size: 18px; font-weight: bold; color: var(--theme-text-color);\">\n                ğŸ‘¥ ${character.displayName} çš„å…³ç³»ç½‘ç»œ\n            </div>\n        </div>\n    `;\n    \n    // è¿‡æ»¤æ‰$metaå­—æ®µï¼Œè·å–çœŸå®çš„å…³ç³»æ¡ç›®\n    const relationEntries = Object.entries(character.relations).filter(([k, v]) => {\n        return k !== '$meta';\n    });\n    \n    console.log('ğŸ” è°ƒè¯•ä¿¡æ¯ - è§’è‰²:', character.name);\n    console.log('ğŸ” åŸå§‹å…³ç³»å¯¹è±¡:', character.relations);\n    console.log('ğŸ” è¿‡æ»¤åçš„å…³ç³»æ¡ç›®:', relationEntries);\n    \n    if (relationEntries.length === 0) {\n        html += `\n            <div style=\"text-align: center; padding: 40px; color: var(--theme-subtitle-color);\">\n                <div style=\"font-size: 48px; margin-bottom: 15px; opacity: 0.5;\">ğŸ¤·</div>\n                <div style=\"font-size: 16px;\">æš‚æ— å…³ç³»è®°å½•</div>\n            </div>\n        `;\n    } else {\n        // ç®€å•åˆ—è¡¨å½¢å¼æ˜¾ç¤ºå…³ç³»\n        html += '<div style=\"display: flex; flex-direction: column; gap: 12px;\">';\n        \n        relationEntries.forEach(([targetName, relationDesc]) => {\n            // å…³ç³»æ•°æ®æ ¼å¼ï¼š[å…³ç³»æè¿°, è¯´æ˜æ–‡æœ¬]ï¼Œéœ€è¦å–[0]è·å–å®é™…æè¿°\n            const relationText = Array.isArray(relationDesc) ? relationDesc[0] : relationDesc;\n            const displayName = targetName === '<user>' ? 'æ‚¨' : targetName;\n            const icon = targetName === '<user>' ? 'ğŸ‘¤' : 'ğŸ‘¥';\n            \n            html += `\n                <div style=\"padding: 15px; background: var(--theme-modal-btn-bg); border-radius: 10px; border: 1px solid var(--theme-border-color); display: flex; align-items: center; gap: 15px;\">\n                    <div style=\"font-size: 32px; flex-shrink: 0;\">${icon}</div>\n                    <div style=\"flex: 1;\">\n                        <div style=\"font-weight: bold; font-size: 16px; margin-bottom: 5px; color: var(--theme-text-color);\">\n                            ${character.displayName} â†’ ${displayName}\n                        </div>\n                        <div style=\"font-size: 14px; color: var(--theme-subtitle-color);\">\n                            å…³ç³»ï¼š<span style=\"color: #667eea; font-weight: bold;\">${relationText}</span>\n                        </div>\n                    </div>\n                </div>\n            `;\n        });\n        \n        html += '</div>';\n    }\n    \n    contentDiv.innerHTML = html;\n    \n    // ç»‘å®šè¿”å›æŒ‰é’®äº‹ä»¶\n    const backBtn = targetDoc.getElementById('relation-back-btn');\n    if (backBtn) {\n        backBtn.addEventListener('click', () => {\n            console.log('ğŸ”™ è¿”å›ç§Ÿå®¢åˆ—è¡¨');\n            openRelationModal();\n        });\n    }\n}\n\n// ç»˜åˆ¶å…³ç³»ç½‘ç»œå›¾\nfunction drawRelationGraph(character, relationEntries, targetDoc) {\n    const canvas = targetDoc.getElementById('relation-canvas');\n    if (!canvas) return;\n    \n    const ctx = canvas.getContext('2d');\n    const dpr = window.devicePixelRatio || 1;\n    \n    // è®¾ç½®Canvaså®é™…å¤§å°\n    const rect = canvas.getBoundingClientRect();\n    canvas.width = rect.width * dpr;\n    canvas.height = rect.height * dpr;\n    ctx.scale(dpr, dpr);\n    \n    const width = rect.width;\n    const height = rect.height;\n    \n    // ä¸­å¿ƒç‚¹ä½ç½®\n    const centerX = width / 2;\n    const centerY = height / 2;\n    const centerRadius = 35;\n    \n    // è®¡ç®—å‘¨å›´èŠ‚ç‚¹çš„ä½ç½®ï¼ˆåœ†å½¢åˆ†å¸ƒï¼‰\n    const nodeRadius = 30;\n    const orbitRadius = Math.min(width, height) * 0.32; // è½¨é“åŠå¾„\n    const angleStep = (Math.PI * 2) / relationEntries.length;\n    \n    // è·å–ä¸»é¢˜é¢œè‰²\n    const isDarkTheme = targetDoc.getElementById('apartment-main-panel').classList.contains('dark-theme');\n    const textColor = isDarkTheme ? '#e0e0e0' : '#333333';\n    const lineColor = isDarkTheme ? '#667eea' : '#667eea';\n    const centerColor = isDarkTheme ? '#7c3aed' : '#8b5cf6';\n    const nodeColor = isDarkTheme ? '#4ade80' : '#10b981';\n    const bgColor = isDarkTheme ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.02)';\n    \n    // æ¸…ç©ºç”»å¸ƒ\n    ctx.clearRect(0, 0, width, height);\n    \n    // ç»˜åˆ¶èƒŒæ™¯\n    ctx.fillStyle = bgColor;\n    ctx.fillRect(0, 0, width, height);\n    \n    // è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹ä½ç½®\n    const nodes = relationEntries.map(([targetName, relationDesc], index) => {\n        const angle = angleStep * index - Math.PI / 2; // ä»é¡¶éƒ¨å¼€å§‹\n        // å…³ç³»æ•°æ®æ ¼å¼ï¼š[å…³ç³»æè¿°, è¯´æ˜æ–‡æœ¬]ï¼Œéœ€è¦å–[0]è·å–å®é™…æè¿°\n        const relationText = Array.isArray(relationDesc) ? relationDesc[0] : relationDesc;\n        return {\n            x: centerX + Math.cos(angle) * orbitRadius,\n            y: centerY + Math.sin(angle) * orbitRadius,\n            name: targetName,\n            displayName: targetName === '<user>' ? 'æ‚¨' : targetName,\n            relation: relationText\n        };\n    });\n    \n    // 1. ç»˜åˆ¶è¿æ¥çº¿\n    ctx.strokeStyle = lineColor;\n    ctx.lineWidth = 2;\n    ctx.setLineDash([5, 5]);\n    \n    nodes.forEach(node => {\n        ctx.beginPath();\n        ctx.moveTo(centerX, centerY);\n        ctx.lineTo(node.x, node.y);\n        ctx.stroke();\n    });\n    \n    ctx.setLineDash([]);\n    \n    // 2. ç»˜åˆ¶å…³ç³»æ–‡å­—ï¼ˆåœ¨çº¿çš„ä¸­ç‚¹ï¼‰\n    ctx.font = '12px Arial';\n    ctx.textAlign = 'center';\n    ctx.textBaseline = 'middle';\n    \n    nodes.forEach(node => {\n        const midX = (centerX + node.x) / 2;\n        const midY = (centerY + node.y) / 2;\n        \n        // è®¡ç®—æ–‡å­—çš„æ—‹è½¬è§’åº¦\n        const angle = Math.atan2(node.y - centerY, node.x - centerX);\n        const distance = Math.sqrt(Math.pow(node.x - centerX, 2) + Math.pow(node.y - centerY, 2));\n        \n        // æ–‡å­—èƒŒæ™¯\n        const text = node.relation;\n        const metrics = ctx.measureText(text);\n        const textWidth = metrics.width;\n        const textHeight = 16;\n        \n        ctx.fillStyle = isDarkTheme ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.9)';\n        ctx.fillRect(midX - textWidth / 2 - 4, midY - textHeight / 2, textWidth + 8, textHeight);\n        \n        ctx.fillStyle = lineColor;\n        ctx.fillText(text, midX, midY);\n    });\n    \n    // 3. ç»˜åˆ¶å‘¨å›´èŠ‚ç‚¹\n    nodes.forEach(node => {\n        // èŠ‚ç‚¹åœ†å½¢\n        ctx.beginPath();\n        ctx.arc(node.x, node.y, nodeRadius, 0, Math.PI * 2);\n        ctx.fillStyle = nodeColor;\n        ctx.fill();\n        ctx.strokeStyle = isDarkTheme ? '#333' : '#fff';\n        ctx.lineWidth = 3;\n        ctx.stroke();\n        \n        // èŠ‚ç‚¹å›¾æ ‡\n        ctx.font = '20px Arial';\n        ctx.textAlign = 'center';\n        ctx.textBaseline = 'middle';\n        ctx.fillStyle = '#fff';\n        ctx.fillText(node.name === '<user>' ? 'ğŸ‘¤' : 'ğŸ‘¥', node.x, node.y - 2);\n        \n        // èŠ‚ç‚¹åç§°ï¼ˆåœ¨åœ†å½¢ä¸‹æ–¹ï¼‰\n        ctx.font = 'bold 13px Arial';\n        ctx.fillStyle = textColor;\n        ctx.fillText(node.displayName, node.x, node.y + nodeRadius + 15);\n    });\n    \n    // 4. ç»˜åˆ¶ä¸­å¿ƒèŠ‚ç‚¹ï¼ˆæœ€åç»˜åˆ¶ï¼Œåœ¨æœ€ä¸Šå±‚ï¼‰\n    ctx.beginPath();\n    ctx.arc(centerX, centerY, centerRadius, 0, Math.PI * 2);\n    ctx.fillStyle = centerColor;\n    ctx.fill();\n    ctx.strokeStyle = isDarkTheme ? '#333' : '#fff';\n    ctx.lineWidth = 4;\n    ctx.stroke();\n    \n    // ä¸­å¿ƒèŠ‚ç‚¹å›¾æ ‡\n    ctx.font = '28px Arial';\n    ctx.textAlign = 'center';\n    ctx.textBaseline = 'middle';\n    ctx.fillStyle = '#fff';\n    ctx.fillText(character.name === '<user>' ? 'ğŸ‘¤' : 'ğŸ‘¥', centerX, centerY - 3);\n    \n    // ä¸­å¿ƒèŠ‚ç‚¹åç§°ï¼ˆåœ¨åœ†å½¢ä¸‹æ–¹ï¼‰\n    ctx.font = 'bold 16px Arial';\n    ctx.fillStyle = textColor;\n    ctx.fillText(character.displayName, centerX, centerY + centerRadius + 20);\n}\n\n// ==================== å¯åŠ¨è„šæœ¬ ====================\n// ç­‰å¾… jQuery åŠ è½½å®Œæˆ\nfunction waitForJQuery(callback) {\n    if (typeof jQuery !== 'undefined' || typeof $ !== 'undefined') {\n        console.log('âœ… jQuery å·²å°±ç»ª');\n        callback();\n    } else {\n        console.log('â³ ç­‰å¾… jQuery...');\n        setTimeout(() => waitForJQuery(callback), 100);\n    }\n}\n\n// DOM åŠ è½½å®Œæˆååˆå§‹åŒ–\nwaitForJQuery(() => {\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', initializeApartmentPlugin);\n    } else {\n        initializeApartmentPlugin();\n    }\n});\n\nconsole.log('âœ… æŒä¸Šå…¬å¯“æ’ä»¶è„šæœ¬åŠ è½½å®Œæˆ');\n",
  "info": "",
  "button": {
    "enabled": true,
    "buttons": []
  },
  "data": {}
}