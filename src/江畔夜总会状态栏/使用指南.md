# 江畔夜总会状态栏 - 使用指南

## ✨ 功能特点

- ✅ **符合酒馆助手规范**：使用 TypeScript 编写，完全符合项目规范
- ✅ **原生实现**：不依赖 Vue 框架，使用原生 HTML + TypeScript
- ✅ **可拖动按钮**：浮动按钮支持拖动，位置自动保存
- ✅ **可拖动面板**：通过标题栏拖动整个面板，支持鼠标和触屏操作
- ✅ **数据实时显示**：从 MVU 框架读取最新数据并展示
- ✅ **美观界面**：深色主题，符合夜总会风格
- ✅ **响应式设计**：完美支持移动端、平板和桌面端
- ✅ **竖屏优化**：移动端竖屏模式自动全屏显示
- ✅ **触屏友好**：所有拖动操作都支持触摸屏

## 📦 安装步骤

### 1. 构建脚本

在项目根目录运行：

```bash
pnpm run build
```

这将在 `dist/江畔夜总会状态栏/` 文件夹中生成打包后的文件。

### 2. 导入到酒馆

1. 打开酒馆助手的**脚本管理**界面
2. 点击 **导入脚本**
3. 选择 `dist/江畔夜总会状态栏/index.js` 文件
4. 给脚本命名（例如：江畔夜总会-状态栏）
5. 启用脚本

### 3. 使用脚本

启用脚本后，浏览器页面右下角会出现一个 🌙 按钮：

#### 🌙 浮动按钮操作

- **点击按钮**：打开/关闭状态栏面板
- **拖动按钮**：长按并拖动可以调整按钮位置，位置会自动保存
- **触摸拖动**：移动设备上可以通过触摸拖动按钮

#### 📱 面板操作

- **拖动面板**：点击并拖动面板标题栏（顶部深粉色区域）可以移动整个面板
- **触屏拖动**：移动设备上支持触摸拖动面板（横屏模式）
- **关闭面板**：点击右上角的 × 按钮关闭面板
- **查看数据**：面板中会显示夜总会的经营状况、培养对象等信息
- **自动保存位置**：面板位置会自动保存，下次打开时恢复

#### 📐 屏幕适配

- **桌面端**：面板可自由拖动，默认居中显示
- **平板横屏**：面板可拖动，宽度自适应
- **手机横屏**：面板可拖动，显示完整内容
- **手机竖屏**：面板自动全屏显示，不可拖动（获得最佳阅读体验）

## 📊 数据结构要求

脚本从 MVU 框架读取最新消息楼层的 `stat_data`，期望的数据结构如下：

```yaml
时间信息:
  当前日期: "2025年10月25日"
  当前时间: "20:30"
  营业状态: "营业中"

地点信息:
  当前位置: "江畔夜总会"

夜总会经营:
  本月营收: "500000"
  在职员工数: "30"
  VIP客户数: "15"
  待处理订单: []

工坊培养对象:
  当前培养人数: "2"
  培养列表:
    - 姓名: "张三"
      编号: "001"
      基本信息:
        培养天数: "10"
      定制信息:
        目标形象: "高端名媛"
        对应订单: "VIP-001"
      当前状态: "基础培训中"
      培养进度:
        社交礼仪: "60"
        才艺培养: "45"
        性爱技巧: "30"
        形体改造: "40"
        综合完成度: "45"

已归档艺人:
  总归档数: "5"
  档案列表:
    - 艺名: "小花"
      类型: "陪酒小姐"
      培养周期: "30天"
      最终评级: "A级"

当前媒体播放:
  正在播放: "钢琴曲 - 夜的钢琴曲五"
  播放进度: "45%"
```

## 🔧 技术实现

### 项目结构

```
src/江畔夜总会状态栏/
├── index.ts           # 主入口文件（TypeScript）
├── README.md          # 项目说明
├── 使用指南.md        # 本文档
└── 参考.js            # 参考实现（掌上公寓）
```

### 核心特性

1. **无 Vue 依赖**：使用原生 HTML + TypeScript，打包后体积小（仅 20.5 KB）

2. **正确的初始化方式**：

```typescript
// ✅ 使用 waitForJQuery 等待依赖加载
waitForJQuery(() => {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeNightclubPlugin);
  } else {
    initializeNightclubPlugin();
  }
});
```

3. **目标文档处理**：

```typescript
// 所有 DOM 操作都在主文档上
const targetDoc = window.top ? window.top.document : document;
```

4. **样式和 HTML 注入**：

```typescript
// 直接注入到主文档
targetDoc.head.insertAdjacentHTML('beforeend', styles);
targetDoc.body.insertAdjacentHTML('beforeend', html);
```

5. **MVU 数据读取**：

```typescript
// 从 MVU 框架获取最新消息的数据
const mvuResult = Mvu.getMvuData({
  type: 'message',
  message_id: 'latest',
});
const data = mvuResult?.stat_data;
```

6. **面板拖动功能**：

```typescript
// 支持鼠标和触摸拖动
function initializePanelDrag(targetDoc: Document) {
  // 在标题栏上绑定拖动事件
  $(header).on('mousedown.nightclub-panel touchstart.nightclub-panel', ...);
  
  // 移动端竖屏自动全屏，不允许拖动
  const isPortraitMobile = window.innerWidth <= 480 && window.innerWidth < window.innerHeight;
  if (isPortraitMobile) return false;
  
  // 位置保存到 localStorage
  localStorage.setItem('nightclub-panel-position', JSON.stringify(position));
}
```

7. **响应式布局**：

- 移动端适配：`@media (max-width: 768px)`
- 竖屏优化（全屏显示）：`@media (max-width: 480px) and (orientation: portrait)`
- 横屏优化：`@media (max-height: 600px) and (orientation: landscape)`

## 🐛 故障排查

### 问题：按钮无法拖动或点击

**可能原因**：

- 其他插件或元素遮挡了按钮
- 浏览器扩展干扰了事件

**解决方案**：

1. 检查浏览器控制台是否有报错
2. 尝试禁用其他浏览器扩展
3. 刷新页面重新加载脚本

### 问题：面板显示"MVU 框架未加载"

**可能原因**：

- MVU 框架脚本未启用
- MVU 框架加载顺序在状态栏之后

**解决方案**：

1. 确保 MVU 框架脚本已启用
2. 在酒馆助手中调整脚本加载顺序，让 MVU 框架先加载
3. 刷新页面重新加载

### 问题：面板显示"未能加载数据"

**可能原因**：

- 当前消息楼层没有 MVU 数据
- 数据结构不符合预期

**解决方案**：

1. 确保角色卡使用了 MVU 变量
2. 检查数据结构是否符合要求（见上方"数据结构要求"）
3. 在浏览器控制台查看详细错误信息

### 问题：面板无法拖动

**可能原因**：

- 在移动端竖屏模式下（面板自动全屏，不可拖动）
- 点击了关闭按钮区域
- 浏览器扩展干扰了拖动事件

**解决方案**：

1. 确认不是在移动端竖屏模式（宽度 ≤ 480px）
2. 确保点击的是标题栏区域，而不是关闭按钮
3. 尝试刷新页面或禁用其他浏览器扩展
4. 在桌面端或横屏模式下测试
5. 在控制台检查是否有错误日志

## 📝 开发说明

### 修改脚本

如果需要修改脚本功能：

1. 编辑 `src/江畔夜总会状态栏/index.ts`
2. 运行 `pnpm run build` 重新构建
3. 在酒馆中重新导入 `dist/江畔夜总会状态栏/index.js`

### 调试技巧

1. **查看控制台日志**：
   - 打开浏览器控制台（F12）
   - 查看以 "🌙" 开头的日志

2. **检查数据**：
   - 在控制台输入 `Mvu.getMvuData({ type: 'message', message_id: 'latest' })`
   - 查看返回的数据结构

3. **清除按钮位置**：
   - 在控制台输入 `localStorage.removeItem('nightclub-btn-position')`
   - 刷新页面，按钮会恢复到默认位置

4. **清除面板位置**：
   - 在控制台输入 `localStorage.removeItem('nightclub-panel-position')`
   - 刷新页面，面板会恢复到居中位置

5. **测试拖动功能**：
   - 检查是否在竖屏模式：`window.innerWidth <= 480 && window.innerWidth < window.innerHeight`
   - 查看拖动状态：面板拖动时标题栏会显示 `cursor: grabbing`

## 📄 许可证

本项目基于 [酒馆助手模板](https://github.com/...) 开发，遵循相同的许可证。

## 🙏 致谢

- 参考了[掌上公寓]插件的实现方式
- 基于 [酒馆助手](https://n0vi028.github.io/JS-Slash-Runner-Doc/) 框架
- 使用 [MVU 变量框架](https://...) 进行数据管理
