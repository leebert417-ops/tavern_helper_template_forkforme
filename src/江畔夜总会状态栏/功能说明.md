# 江畔夜总会状态栏 - 功能说明

## 🎯 核心功能

### 1. 浮动按钮 🌙

**位置**：默认在页面右下角

**功能**：

- 点击打开/关闭管理面板
- 长按拖动调整位置
- 位置自动保存

**交互**：

- 桌面端：鼠标左键点击/拖动
- 移动端：手指点击/拖动
- 拖动距离 < 5px 时视为点击

### 2. 管理面板

**显示内容**：

- 时间信息（日期、时间、营业状态）
- 经营状况（营收、员工数、VIP客户、待处理订单）
- 工坊培养对象（培养列表、进度条）
- 已归档艺人（档案列表）
- 当前媒体播放（播放进度）

**交互功能**：

- 拖动标题栏移动面板
- 点击关闭按钮关闭面板
- 滚动查看完整内容

### 3. 拖动功能

#### 浮动按钮拖动

- ✅ 鼠标拖动（桌面端）
- ✅ 触摸拖动（移动端）
- ✅ 边界限制（不会拖出视口）
- ✅ 位置保存（localStorage）
- ✅ 自动恢复上次位置

#### 面板拖动

- ✅ 通过标题栏拖动
- ✅ 鼠标拖动（桌面端）
- ✅ 触摸拖动（移动端横屏）
- ✅ 边界限制（至少保留 50px 在视口内）
- ✅ 位置保存（localStorage）
- ✅ 自动恢复上次位置
- ⚠️ 移动端竖屏禁用（全屏显示）

### 4. 响应式布局

#### 桌面端（宽度 > 768px）

- 面板宽度：90vw，最大 800px
- 面板高度：85vh，最大 600px
- 按钮大小：64x64px
- 完整功能：可自由拖动面板

#### 平板/横屏（768px > 宽度 > 480px）

- 面板宽度：95vw
- 面板高度：90vh
- 按钮大小：56x56px
- 完整功能：可自由拖动面板

#### 手机竖屏（宽度 ≤ 480px）

- **面板全屏显示**（100vw × 100vh）
- 无边框、无圆角
- 面板固定位置，**不可拖动**
- 按钮大小：50x50px
- 获得最佳阅读体验

#### 横屏低高度（高度 ≤ 600px）

- 面板高度：95vh
- 内容区域优化
- 可正常拖动

### 5. 数据管理

#### 数据来源

- 从 MVU 框架读取最新消息楼层的 `stat_data`
- 自动重试机制（最多 5 次，每次间隔 400ms）
- 支持从父窗口引用 MVU

#### 数据校验

- 使用 `safeGet` 函数安全获取数据
- 缺失数据显示默认值
- 错误数据显示错误提示

#### 数据显示

- 实时更新（每次打开面板时加载）
- 加载状态提示
- 错误状态提示
- 空状态提示

## 🎨 视觉效果

### 主题颜色

- 主色调：`#e94560`（深粉色）
- 背景深色：`#1a1a2e`
- 背景中色：`#16213e`
- 文字浅色：`#eee`
- 文字暗色：`#aaa`

### 动画效果

- 按钮悬停：缩放 1.05
- 拖动时：半透明效果
- 进度条：宽度过渡动画
- 加载图标：旋转动画

### 阴影效果

- 按钮阴影：`0 4px 12px rgba(233, 69, 96, 0.4)`
- 面板阴影：`0 8px 32px rgba(233, 69, 96, 0.4)`
- 标题栏阴影：`0 2px 8px rgba(0, 0, 0, 0.2)`

## 🔧 技术特性

### 初始化流程

1. 等待 jQuery 加载完成
2. 检查 DOM 是否加载完成
3. 获取目标文档（主文档）
4. 清理旧的插件实例
5. 注入样式和 HTML
6. 恢复按钮位置
7. 初始化按钮拖动功能
8. 初始化面板系统
9. 初始化面板拖动功能

### 事件管理

- 使用命名空间：`.nightclub-plugin`、`.nightclub-panel`
- 支持事件委托
- 卸载时自动清理所有事件
- 防止事件冒泡和默认行为

### 性能优化

- 使用原生 HTML（无 Vue 框架）
- 打包后仅 20.5 KB
- 样式内联（无外部 CSS 文件）
- 事件监听统一管理

### 兼容性

- 支持现代浏览器（Chrome、Firefox、Edge、Safari）
- 支持移动浏览器（iOS Safari、Chrome Mobile）
- 支持触摸屏设备
- 支持不同屏幕尺寸和方向

## 📱 移动端优化

### 触摸支持

- `touchstart`：开始拖动
- `touchmove`：拖动移动
- `touchend`：结束拖动
- `touchcancel`：取消拖动

### 视口适配

- 使用 `vw`/`vh` 单位
- 响应 `resize` 事件
- 响应 `orientationchange` 事件
- 自动调整布局

### 交互优化

- 增大触摸目标（按钮、关闭按钮）
- 防止误触（拖动距离检测）
- 平滑滚动（内容区域）
- 禁用用户选择（拖动区域）

## 🔒 安全性

### 数据安全

- 只读取 MVU 数据，不修改
- 使用 `safeGet` 函数避免访问错误
- 类型检查和默认值处理

### 存储安全

- 只存储位置信息到 localStorage
- 不存储敏感数据
- 可随时清除存储数据

### DOM 安全

- 使用 `insertAdjacentHTML` 而非 `innerHTML`
- 避免 XSS 攻击
- 事件监听正确清理

## 📊 状态管理

### 全局状态

- `btnDragData`：按钮拖动状态
- `panelDragData`：面板拖动状态
- `cachedMVUData`：缓存的 MVU 数据
- `currentRetry`：当前重试次数

### 本地存储

- `nightclub-btn-position`：按钮位置
- `nightclub-panel-position`：面板位置

### DOM 状态

- `.active`：面板是否显示
- `.dragging`：是否正在拖动

## 🎓 使用建议

### 桌面端使用

1. 点击浮动按钮打开面板
2. 拖动标题栏调整面板位置
3. 查看数据后点击关闭按钮

### 移动端使用（横屏）

1. 点击浮动按钮打开面板
2. 可以拖动标题栏调整位置
3. 滚动查看完整内容

### 移动端使用（竖屏）

1. 点击浮动按钮打开面板
2. **面板自动全屏显示**
3. 滚动查看完整内容
4. 点击关闭按钮关闭

### 数据更新

- 每次打开面板都会重新加载数据
- 如果数据未更新，尝试刷新页面
- 检查 MVU 框架是否正常工作

## 🛠️ 维护建议

### 定期清理

- 清除浏览器缓存
- 清除 localStorage 数据
- 重新导入最新版本脚本

### 问题排查

1. 查看浏览器控制台日志
2. 检查 MVU 框架是否加载
3. 检查数据结构是否符合要求
4. 尝试禁用其他插件

### 性能监控

- 监控页面加载时间
- 监控内存使用情况
- 监控事件监听器数量
- 及时清理不用的数据
