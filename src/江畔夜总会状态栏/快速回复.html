<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ±Ÿç•”å¤œæ€»ä¼š - å¿«é€Ÿå›å¤</title>
    <style>
      :root {
        --nightclub-primary: #e94560;
        --nightclub-secondary: #0f3460;
        --nightclub-bg-dark: #16213e;
        --nightclub-bg-mid: #1a2332;
        --nightclub-bg-light: #2a3447;
        --nightclub-text-light: #e4e7eb;
        --nightclub-text-dim: #a0a8b5;
        --nightclub-border: rgba(255, 255, 255, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        background-color: transparent;
        color: var(--nightclub-text-light);
        padding: 10px;
        margin: 0;
      }

      .container {
        max-width: 100%;
        margin: 0 auto;
      }

      .card {
        background-color: var(--nightclub-bg-light);
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .card-header {
        color: var(--nightclub-primary);
        font-size: 1.1em;
        font-weight: bold;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
      }

      .card.collapsed .card-header {
        padding-bottom: 15px;
      }

      .card-content {
        display: block;
        padding: 0 15px 15px 15px;
      }

      .card.collapsed .card-content {
        display: none;
      }

      .collapse-toggle {
        font-size: 1.2em;
        transform-origin: center;
        transition: transform 0.3s ease;
      }

      .card.collapsed .collapse-toggle {
        transform: rotate(-90deg);
      }

      .replies-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      .reply-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--nightclub-border);
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .reply-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--nightclub-primary);
        transform: scaleX(0);
        transition: transform 0.3s ease;
      }

      .reply-card:hover {
        border-color: var(--nightclub-primary);
        background: rgba(233, 69, 96, 0.1);
        transform: translateY(-2px);
      }

      .reply-card:hover::before {
        transform: scaleX(1);
      }

      .reply-card:active {
        transform: translateY(0);
      }

      .reply-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--nightclub-primary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .reply-label .badge {
        display: inline-block;
        padding: 2px 8px;
        background: var(--nightclub-primary);
        border-radius: 4px;
        font-size: 11px;
        color: white;
      }

      .reply-content {
        font-size: 14px;
        line-height: 1.6;
        color: var(--nightclub-text-light);
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
        color: var(--nightclub-text-dim);
      }

      .loading-icon {
        font-size: 48px;
        margin-bottom: 16px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .error {
        background: rgba(255, 69, 58, 0.1);
        border: 1px solid rgba(255, 69, 58, 0.3);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        color: #ff453a;
      }

      .error-icon {
        font-size: 48px;
        margin-bottom: 12px;
      }

      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--nightclub-primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--nightclub-text-dim);
      }

      .empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
      }

      /* ç§»åŠ¨ç«¯é€‚é… */
      @media (max-width: 1024px) {
        .replies-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .replies-grid {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 24px;
        }

        .reply-card {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card collapsed" id="quick-reply-card">
        <div class="card-header" onclick="toggleCard()">
          <span>ğŸŒ™ æ±Ÿç•”å¤œæ€»ä¼š - å¿«é€Ÿå›å¤</span>
          <span id="collapse-toggle" class="collapse-toggle">â–¼</span>
        </div>
        <div class="card-content" id="content">
          <div class="loading">
            <div class="loading-icon">â³</div>
            <div>æ­£åœ¨åŠ è½½å›å¤é€‰é¡¹...</div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      // ==================== å·¥å…·å‡½æ•° ====================
      function safeGet(obj, path, defaultValue = null) {
        if (!obj) return defaultValue;
        const keys = path.split('.');
        let current = obj;
        for (const key of keys) {
          if (current === undefined || current === null || typeof current !== 'object') {
            return defaultValue;
          }
          current = current[key];
        }
        return current === undefined || current === null ? defaultValue : current;
      }

      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
        }, 2000);
      }

      function fillCommand(text) {
        try {
          const chatInput = (parent.document || document).querySelector('#send_textarea');
          if (chatInput) {
            if (chatInput.value.trim() !== '') {
              chatInput.value += '\n\n' + text;
            } else {
              chatInput.value = text;
            }
            chatInput.focus();
            showToast('âœ… å·²å¡«å……åˆ°è¾“å…¥æ¡†');
          } else {
            throw new Error('æœªæ‰¾åˆ°è¾“å…¥æ¡†');
          }
        } catch (e) {
          navigator.clipboard
            .writeText(text)
            .then(() => {
              showToast('ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            })
            .catch(() => {
              alert('è¯·æ‰‹åŠ¨å¤åˆ¶ï¼š\n\n' + text);
            });
        }
      }

      function toggleCard() {
        const card = document.getElementById('quick-reply-card');
        const isCollapsed = card.classList.contains('collapsed');
        if (isCollapsed) {
          card.classList.remove('collapsed');
        } else {
          card.classList.add('collapsed');
        }
        document.getElementById('collapse-toggle').innerText = card.classList.contains('collapsed') ? 'â–¼' : 'â–²';
      }

      function renderReplies(data) {
        const currentReplies = safeGet(data, 'å¿«é€Ÿå›å¤.å½“å‰å›å¤', []);
        const fastForwardReplies = safeGet(data, 'å¿«é€Ÿå›å¤.å¿«è¿›å›å¤', []);

        // åˆå¹¶æ‰€æœ‰å›å¤é€‰é¡¹
        const allReplies = [];

        // æ·»åŠ å½“å‰å›å¤ï¼ˆæ ‡è®°ä¸ºç±»å‹1ï¼‰
        if (currentReplies && Array.isArray(currentReplies)) {
          currentReplies.forEach((reply, index) => {
            if (reply && typeof reply === 'object' && reply.æ ‡ç­¾ && reply.å†…å®¹) {
              allReplies.push({
                type: 'current',
                icon: 'ğŸ’¬',
                index: index + 1,
                label: reply.æ ‡ç­¾,
                content: reply.å†…å®¹,
              });
            }
          });
        }

        // æ·»åŠ å¿«è¿›å›å¤ï¼ˆæ ‡è®°ä¸ºç±»å‹2ï¼‰
        if (fastForwardReplies && Array.isArray(fastForwardReplies)) {
          fastForwardReplies.forEach((reply, index) => {
            if (reply && typeof reply === 'object' && reply.æ ‡ç­¾ && reply.å†…å®¹) {
              allReplies.push({
                type: 'forward',
                icon: 'â­ï¸',
                index: index + 1,
                label: reply.æ ‡ç­¾,
                content: reply.å†…å®¹,
              });
            }
          });
        }

        // æ¸²æŸ“ç•Œé¢
        let html = '';

        if (allReplies.length > 0) {
          html += '<div class="replies-grid">';

          allReplies.forEach(reply => {
            html += `
              <div class="reply-card" onclick="fillCommand(\`${reply.content.replace(/`/g, '\\`')}\`)">
                <div class="reply-label">
                  <span class="badge">${reply.icon}</span>
                  <span>${reply.label}</span>
                </div>
                <div class="reply-content">${reply.content}</div>
              </div>
            `;
          });

          html += '</div>';
        } else {
          html += `
            <div class="empty">
              <div class="empty-icon">ğŸ“­</div>
              <div>æš‚æ— å¿«é€Ÿå›å¤é€‰é¡¹</div>
            </div>
          `;
        }

        document.getElementById('content').innerHTML = html;
      }

      function showError(message) {
        document.getElementById('content').innerHTML = `
                <div class="error">
                    <div class="error-icon">âš ï¸</div>
                    <div>${message}</div>
                </div>
            `;
      }

      // ==================== æ•°æ®åŠ è½½ ====================
      async function loadData() {
        try {
          // ç­‰å¾… MVU åˆå§‹åŒ–
          if (typeof Mvu === 'undefined') {
            if (window.parent && typeof window.parent.Mvu !== 'undefined') {
              window.Mvu = window.parent.Mvu;
            } else {
              throw new Error('MVU æ¡†æ¶æœªåŠ è½½');
            }
          }

          // è·å–æœ€æ–°æ¶ˆæ¯çš„ MVU æ•°æ®
          const mvuResult = Mvu.getMvuData({
            type: 'message',
            message_id: 'latest',
          });

          const data = mvuResult?.stat_data;

          if (!data) {
            throw new Error('æœªèƒ½åŠ è½½æ•°æ®');
          }

          console.log('âœ… æ•°æ®åŠ è½½æˆåŠŸ', data);
          renderReplies(data);
        } catch (error) {
          console.error('âŒ åŠ è½½æ•°æ®å‡ºé”™:', error);
          showError('åŠ è½½å‡ºé”™: ' + error.message);
        }
      }

      // ==================== åˆå§‹åŒ– ====================
      function init() {
        // å»¶è¿ŸåŠ è½½ï¼Œç­‰å¾… MVU æ¡†æ¶å®Œå…¨åˆå§‹åŒ–
        setTimeout(loadData, 500);
      }

      // ä½¿ç”¨ jQuery æ–¹å¼åˆå§‹åŒ–ï¼ˆç¬¦åˆé¡¹ç›®è§„èŒƒï¼‰
      if (typeof $ !== 'undefined') {
        $(() => {
          init();
        });
      } else {
        // å¦‚æœ jQuery æœªåŠ è½½ï¼Œä½¿ç”¨åŸç”Ÿæ–¹å¼
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      }
    </script>
  </body>
</html>
