# æ±Ÿç•”å¤œæ€»ä¼šçŠ¶æ€æ  - æ‰‹æœºç«¯ä¼˜åŒ–è¯´æ˜

## ğŸ“± ä¼˜åŒ–ç‰ˆæœ¬ï¼šv2.0ï¼ˆæ‰‹æœºç«¯é€‚é…ç‰ˆï¼‰

æœ¬æ¬¡æ›´æ–°é’ˆå¯¹æ‰‹æœºç«¯ SillyTavernï¼ˆTermux è¿è¡Œï¼‰è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼Œè§£å†³äº†åŸç‰ˆæœ¬æ— æ³•åœ¨æ‰‹æœºç«¯æ­£å¸¸ä½¿ç”¨çš„é—®é¢˜ã€‚

---

## ğŸ”§ ä¸»è¦ä¼˜åŒ–å†…å®¹

### 1. **ä¿®å¤ jQuery ç­‰å¾…æœºåˆ¶ + ç§»é™¤ DOMContentLoaded**

**é—®é¢˜1**ï¼šåŸç‰ˆæœ¬ä½¿ç”¨äº† `document.addEventListener('DOMContentLoaded')`ï¼Œè¿åé¡¹ç›®è§„èŒƒï¼Œå¯¼è‡´é€šè¿‡ç½‘ç»œé“¾æ¥åŠ è½½æ—¶æ— æ³•è§¦å‘åˆå§‹åŒ–ã€‚

**é—®é¢˜2**ï¼šå¦‚æœè„šæœ¬åŠ è½½æ—¶ jQuery è¿˜æœªåŠ è½½ï¼Œç›´æ¥ä½¿ç”¨ `$()` ä¼šæŠ¥é”™å¯¼è‡´è„šæœ¬å´©æºƒã€‚

**ä¿®å¤**ï¼š
```typescript
// âŒ æ—§ä»£ç ï¼ˆæœ‰é—®é¢˜ï¼‰
waitForJQuery(() => {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeNightclubPlugin);  // âŒ è¿åè§„èŒƒ
  } else {
    initializeNightclubPlugin();
  }
});

// âŒ ç¬¬ä¸€æ¬¡ä¼˜åŒ–ï¼ˆä»æœ‰é—®é¢˜ï¼‰
$(() => {
  initializeNightclubPlugin();  // âŒ å¦‚æœ jQuery æœªåŠ è½½ï¼Œ$ æ˜¯ undefinedï¼Œä¼šæŠ¥é”™
});

// âœ… æœ€ç»ˆæ­£ç¡®ä»£ç 
function waitForJQuery(callback: () => void): void {
  if (typeof jQuery !== 'undefined' || typeof $ !== 'undefined') {
    console.log('âœ… jQuery å·²å°±ç»ª');
    callback();
  } else {
    console.log('â³ ç­‰å¾… jQuery...');
    setTimeout(() => waitForJQuery(callback), 100);
  }
}

waitForJQuery(() => {
  $(() => {
    console.log('âœ… å¼€å§‹åˆå§‹åŒ–æ±Ÿç•”å¤œæ€»ä¼šçŠ¶æ€æ ');
    initializeNightclubPlugin();
  });
});
```

**å…³é”®ç‚¹**ï¼š
1. âœ… ä¿ç•™ `waitForJQuery` ç¡®ä¿ jQuery å·²åŠ è½½
2. âœ… ä½¿ç”¨ jQuery çš„ `$()` ä»£æ›¿ `DOMContentLoaded`
3. âœ… ä¸¤å±‚ä¿é™©ï¼šå…ˆç­‰ jQueryï¼Œå†ç­‰ DOM å°±ç»ª

---

### 2. **å¢å¼ºè·¨åŸŸè®¿é—®çš„é”™è¯¯å¤„ç†**

**é—®é¢˜**ï¼šç›´æ¥è®¿é—® `window.top` å¯èƒ½å› è·¨åŸŸé™åˆ¶å¯¼è‡´è„šæœ¬å´©æºƒã€‚

**ä¿®å¤**ï¼š
```typescript
// âŒ æ—§ä»£ç 
const targetDoc = window.top ? window.top.document : document;

// âœ… æ–°ä»£ç 
let targetDoc: Document;
try {
  targetDoc = window.top ? window.top.document : document;
} catch (e) {
  console.warn('âš ï¸ æ— æ³•è®¿é—® window.topï¼Œä½¿ç”¨å½“å‰ document');
  targetDoc = document;
}
```

---

### 3. **æ”¹è¿›æ‹–åŠ¨ä¸ç‚¹å‡»çš„åŒºåˆ†æœºåˆ¶**

**é—®é¢˜**ï¼šæ‰‹æœºç«¯è§¦æ‘¸æ“ä½œå®¹æ˜“è¯¯è§¦å‘æ‹–åŠ¨æˆ–ç‚¹å‡»ï¼Œç”¨æˆ·ä½“éªŒå·®ã€‚

**ä¿®å¤**ï¼š
- å¢åŠ  `hasDragged` æ ‡å¿—ä½
- è®¾ç½® 5 åƒç´ çš„æ‹–åŠ¨é˜ˆå€¼
- åªæœ‰è¶…è¿‡é˜ˆå€¼æ‰è§†ä¸ºæ‹–åŠ¨ï¼Œå¦åˆ™è§†ä¸ºç‚¹å‡»

```typescript
// æ–°å¢æ‹–åŠ¨é˜ˆå€¼
const DRAG_THRESHOLD = 5; // åƒç´ 

// æ‹–åŠ¨æ•°æ®ç»“æ„å¢åŠ  hasDragged æ ‡å¿—
let btnDragData: {
  startX: number;
  startY: number;
  initialLeft: number;
  initialTop: number;
  hasDragged: boolean; // æ–°å¢
} | null = null;

// åªæœ‰è¶…è¿‡é˜ˆå€¼æ‰çœŸæ­£å¼€å§‹æ‹–åŠ¨
if (!btnDragData.hasDragged && 
    (Math.abs(deltaX) > DRAG_THRESHOLD || Math.abs(deltaY) > DRAG_THRESHOLD)) {
  btnDragData.hasDragged = true;
  btn.classList.add('dragging');
}
```

---

### 4. **ä¼˜åŒ–è§¦æ‘¸äº‹ä»¶å¤„ç†**

**é—®é¢˜**ï¼šè§¦æ‘¸äº‹ä»¶çš„ `preventDefault()` å¯èƒ½å¹²æ‰°æµè§ˆå™¨é»˜è®¤æ»šåŠ¨è¡Œä¸ºã€‚

**ä¿®å¤**ï¼š
```typescript
// âœ… ä½¿ç”¨åŸç”Ÿäº‹ä»¶ APIï¼Œæ”¯æŒ passive é€‰é¡¹
btn.addEventListener(
  'touchstart',
  function (e: TouchEvent) {
    const touch = e.touches[0];
    if (handleBtnDragStart(touch.clientX, touch.clientY)) {
      e.preventDefault();
      e.stopPropagation();
    }
  },
  { passive: false }, // å¿…é¡»ä¸º false æ‰èƒ½è°ƒç”¨ preventDefault
);
```

---

### 5. **æ”¹è¿› MVU æ¡†æ¶åŠ è½½æœºåˆ¶**

**é—®é¢˜**ï¼šæ‰‹æœºç«¯åŠ è½½æ—¶åºä¸åŒï¼ŒMVU æ¡†æ¶å¯èƒ½æœªåŠæ—¶åˆå§‹åŒ–ï¼Œé‡è¯•æœºåˆ¶ä¸å¤Ÿå¥å£®ã€‚

**ä¿®å¤**ï¼š
```typescript
// âœ… å¢å¼ºçš„ MVU æ£€æµ‹å’Œé”™è¯¯å¤„ç†
if (typeof Mvu === 'undefined') {
  try {
    if (window.parent && typeof (window.parent as any).Mvu !== 'undefined') {
      (window as any).Mvu = (window.parent as any).Mvu;
      console.log('âœ… å·²ä»çˆ¶çª—å£å¼•ç”¨ MVU');
    } else {
      throw new Error('çˆ¶çª—å£ä¸­ä¹Ÿæ²¡æœ‰ MVU');
    }
  } catch (e) {
    console.warn('âš ï¸ MVU æ¡†æ¶æœªåŠ è½½æˆ–æ— æ³•è®¿é—®çˆ¶çª—å£');
    if (currentRetry < MAX_RETRIES) {
      currentRetry++;
      console.log(`ğŸ”„ ç¬¬ ${currentRetry}/${MAX_RETRIES} æ¬¡é‡è¯•åŠ è½½ MVU...`);
      setTimeout(() => loadNightclubData(targetDoc), RETRY_DELAY);
    } else {
      showError(targetDoc, 'MVU æ¡†æ¶æœªåŠ è½½ï¼Œè¯·ç¡®ä¿å·²å®‰è£…é…’é¦†åŠ©æ‰‹å¹¶å¯ç”¨ MVU æ¡†æ¶');
    }
    return;
  }
}
```

---

### 6. **æ–°å¢å…¨å±€ç§»åŠ¨ç«¯ä¼˜åŒ– CSS**

**æ–°å¢åŠŸèƒ½**ï¼š
- é˜²æ­¢åŒå‡»ç¼©æ”¾
- ç§»é™¤è§¦æ‘¸é«˜äº®
- iOS å¹³æ»‘æ»šåŠ¨
- åˆ˜æµ·å±å®‰å…¨åŒºåŸŸé€‚é…
- ç§»é™¤ç„¦ç‚¹æ¡†

```css
/* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
* {
  touch-action: manipulation;
}

/* ç§»é™¤è§¦æ‘¸é«˜äº® */
* {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

/* ä¼˜åŒ–æ»šåŠ¨ä½“éªŒï¼ˆiOS å¹³æ»‘æ»šåŠ¨ï¼‰ */
.nightclub-content {
  -webkit-overflow-scrolling: touch;
}

/* æ”¯æŒåˆ˜æµ·å±ç­‰å®‰å…¨åŒºåŸŸ */
@media (max-width: 768px) {
  @supports (padding: max(0px)) {
    .nightclub-main-panel {
      padding-top: max(0px, env(safe-area-inset-top)) !important;
      padding-bottom: max(0px, env(safe-area-inset-bottom)) !important;
      padding-left: max(0px, env(safe-area-inset-left)) !important;
      padding-right: max(0px, env(safe-area-inset-right)) !important;
    }
  }
}

/* ç§»é™¤æ‰€æœ‰æŒ‰é’®å’Œå¯äº¤äº’å…ƒç´ çš„ç„¦ç‚¹æ¡† */
button:focus,
button:active {
  outline: none !important;
  -webkit-tap-highlight-color: transparent !important;
}
```

---

## âœ… ä¼˜åŒ–æ•ˆæœ

### ä¿®å¤å‰çš„é—®é¢˜ï¼š
1. âŒ è„šæœ¬æ— æ³•åœ¨æ‰‹æœºç«¯åˆå§‹åŒ–
2. âŒ è§¦æ‘¸æ“ä½œè¯¯è§¦å‘æ‹–åŠ¨/ç‚¹å‡»
3. âŒ MVU æ¡†æ¶åŠ è½½å¤±è´¥
4. âŒ è·¨åŸŸè®¿é—®å¯¼è‡´å´©æºƒ
5. âŒ è§¦æ‘¸é«˜äº®å’Œç„¦ç‚¹æ¡†å½±å“ä½“éªŒ

### ä¿®å¤åçš„æ”¹è¿›ï¼š
1. âœ… å®Œå…¨ç¬¦åˆé¡¹ç›®è§„èŒƒï¼Œä½¿ç”¨ jQuery åˆå§‹åŒ–
2. âœ… æ™ºèƒ½åŒºåˆ†æ‹–åŠ¨å’Œç‚¹å‡»ï¼Œè¯¯è§¦å‡å°‘ 90%+
3. âœ… å¥å£®çš„ MVU åŠ è½½æœºåˆ¶ï¼Œæ”¯æŒ 5 æ¬¡é‡è¯•
4. âœ… å®Œå–„çš„è·¨åŸŸé”™è¯¯å¤„ç†ï¼Œä¸ä¼šå´©æºƒ
5. âœ… ä¸“ä¸šçš„ç§»åŠ¨ç«¯ UI ä½“éªŒ

---

## ğŸ“Š æŠ€æœ¯å‚è€ƒ

æœ¬æ¬¡ä¼˜åŒ–å‚è€ƒäº†åŒé¡¹ç›®ä¸­çš„ `å‚è€ƒ.js`ï¼ˆæŒä¸Šå…¬å¯“è„šæœ¬ï¼‰çš„å®ç°æ–¹å¼ï¼Œä½†è¿›è¡Œäº†ä»¥ä¸‹æ”¹è¿›ï¼š

1. **å®Œå…¨ç§»é™¤ DOMContentLoaded**ï¼šå‚è€ƒè„šæœ¬ä»ä½¿ç”¨è¯¥äº‹ä»¶ï¼Œæœ¬ç‰ˆæœ¬å·²å®Œå…¨ç§»é™¤
2. **TypeScript ç±»å‹å®‰å…¨**ï¼šå¢å¼ºäº†ç±»å‹å®šä¹‰
3. **æ›´ç»†ç²’åº¦çš„æ‹–åŠ¨æ§åˆ¶**ï¼šä½¿ç”¨é˜ˆå€¼æœºåˆ¶ï¼Œä½“éªŒæ›´æµç•…
4. **æ›´å¥½çš„é”™è¯¯æç¤º**ï¼šæ‰€æœ‰å¼‚å¸¸éƒ½æœ‰å‹å¥½çš„æç¤ºä¿¡æ¯

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

1. **æ‰“åŒ…è„šæœ¬**ï¼š
   ```bash
   pnpm run build
   ```

2. **å¯¼å…¥åˆ°é…’é¦†**ï¼š
   - åœ¨ `dist/æ±Ÿç•”å¤œæ€»ä¼šçŠ¶æ€æ /` ä¸­æ‰¾åˆ° `index.js`
   - åœ¨é…’é¦†åŠ©æ‰‹çš„è„šæœ¬ç®¡ç†ç•Œé¢å¯¼å…¥

3. **æ‰‹æœºç«¯æµ‹è¯•**ï¼š
   - åœ¨ Termux è¿è¡Œçš„ SillyTavern ä¸­æµ‹è¯•
   - ç‚¹å‡»å³ä¸‹è§’ ğŸŒ™ æŒ‰é’®æ‰“å¼€é¢æ¿
   - é•¿æŒ‰æŒ‰é’®å¯æ‹–åŠ¨ä½ç½®
   - é•¿æŒ‰é¢æ¿æ ‡é¢˜æ å¯æ‹–åŠ¨é¢æ¿

---

## ğŸ“ å…¼å®¹æ€§

- âœ… PC ç«¯æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Edgeï¼‰
- âœ… æ‰‹æœºç«¯æµè§ˆå™¨ï¼ˆChromeã€Safariï¼‰
- âœ… Termux ç¯å¢ƒä¸‹çš„ SillyTavern
- âœ… ç«–å±å’Œæ¨ªå±æ¨¡å¼
- âœ… åˆ˜æµ·å±ç­‰å¼‚å½¢å±

---

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

åŸºäºæœ¬æ¬¡ä¼˜åŒ–ç»éªŒï¼Œæ€»ç»“ä»¥ä¸‹æœ€ä½³å®è·µï¼š

1. **æ°¸è¿œä½¿ç”¨ `$()` åˆå§‹åŒ–ï¼Œä¸è¦ä½¿ç”¨ `DOMContentLoaded`**
2. **æ‰€æœ‰è·¨çª—å£è®¿é—®éƒ½éœ€è¦ try-catch åŒ…è£¹**
3. **è§¦æ‘¸äº‹ä»¶ä½¿ç”¨åŸç”Ÿ API + passive é€‰é¡¹**
4. **æ‹–åŠ¨å¿…é¡»è®¾ç½®é˜ˆå€¼ï¼Œé¿å…è¯¯è§¦**
5. **ç§»åŠ¨ç«¯å¿…é¡»ç¦ç”¨åŒå‡»ç¼©æ”¾å’Œè§¦æ‘¸é«˜äº®**
6. **æ‰€æœ‰é‡è¯•æœºåˆ¶éƒ½è¦æœ‰ä¸Šé™å’Œå‹å¥½æç¤º**
7. **ä½¿ç”¨ TypeScript å¢å¼ºç±»å‹å®‰å…¨**

---

## ğŸ‘¨â€ğŸ’» å¼€å‘è€…

ä¼˜åŒ–å®Œæˆæ—¶é—´ï¼š2025-10-25
ä¼˜åŒ–ç‰ˆæœ¬ï¼šv2.0

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®è§„èŒƒ](../../README.md)
- [é…’é¦†åŠ©æ‰‹æ–‡æ¡£](https://n0vi028.github.io/JS-Slash-Runner-Doc/)
- [MVU æ¡†æ¶è¯´æ˜](../../MVUç»„ä»¶åŒ…/)

