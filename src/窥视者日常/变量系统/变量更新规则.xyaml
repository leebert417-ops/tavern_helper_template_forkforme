# 变量更新规则

## 定义

本模块定义了变量更新的具体业务逻辑。AI 应在每次生成回复前，依据当前剧情发展和用户行为，参考本规则来判断哪些变量需要更新，以及如何更新。

**核心原则**：
- **逻辑优先**：变量变化必须符合物理逻辑和生理常识。
- **暗面驱动**：重点关注那些租客“未察觉”但实际上发生了变化的数值（如开发度、潜在警惕值）。
- **时间联动**：时间的流逝是变量变化的主要驱动力。

---

## 详细规则

### 1. 时间与世界规则 (Time & World)

- **时间流逝**:
  - 每次交互默认流逝 5-15 分钟。
  - 若涉及“潜入”、“观察整晚”、“睡觉”等长时行为，应根据常识大幅推进 `world.time`。
  - 必须同步更新 `world.day`（如果跨过了午夜）。

- **天气变化**:
  - `world.weather` 应随时间自然变化，或根据剧情描述更新（如“突然下起了暴雨”）。

### 2. 租客状态调度 (Tenant Scheduling)

- **状态更新 (`is_home` / `state` )**:
  - 依据时间段和《角色动线》，自动更新租客是否在家（`is_home`），以及角色当前行动（`state`）。

### 3. 生理状态规则 (Physiological)

- **意识值 (`consciousness`)**:
  - **自然睡眠**: 进入睡眠状态后，意识值每小时降低 10，直至 20-30 (深睡)。醒来后恢复至 100。
  - **药物影响**:
    - 若摄入 `sleeping_pills` (安眠药)，意识值在 30 分钟内强制降至 10 (昏迷)，持续 4-6 小时。
    - 若摄入 `alcohol` (酒精)，意识值根据饮酒量降至 40-70 (微醺/醉酒)。
  - **苏醒判定**: 当 `consciousness` < 30 时，目标处于“任人摆布”状态，对外界刺激无反应。

- **开发度 (`body_sensitivity`)**:
  - **触发**: 仅在发生性接触（无论对方是否清醒）时增加。
  - **数值**:
    - 轻微接触 (抚摸, 偷吻): +1
    - 深度接触 (口交, 指交): +3
    - 本垒行为 (性交): +5
  - **阈值反馈**:
    - > 30: 目标清醒时偶尔会感到身体燥热，对房东的视线变得敏感。
    - > 60: 目标频繁做春梦，梦中主角模糊不清但体型像房东。
    - > 90: 彻底沦陷，身体产生条件反射，甚至渴望被粗暴对待。

### 4. 潜行与警惕规则 (Stealth & Alertness)

- **玩家位置与模式 (`player`)**:
  - 当玩家进入他人房间时，`player.location` 必须更新为对应房号，且 `player.mode` 自动转为 `stealth`。
  - 离开房间后，切回 `monitor`。

- **警惕值 (`alertness`)**:
  - **增加条件**:
    - 玩家在房间内留下了痕迹（如物品移位、异味、体液未清理）：次日发现后 +20。
    - 玩家潜入时发出噪音（且目标处于浅睡状态）：+10。
    - 目标感到身体不适（如私处红肿、腰酸背痛却无记忆）：+5 (怀疑自己生病或被鬼压床)。
  - **后果**:
    - > 50: 目标会更换门锁 (导致 `master_key` 失效) 或在房内安装简易监控。
    - > 80: 目标会报警或搬走。
  - **减少条件**:
    - 连续 7 天无异常发生: -5。

- **李强警惕度 (`li_qiang_alertness`) [王艳专属]**:
  - 李强只在周末在家。
  - 如果在李强在家期间（周五晚-周日晚）对王艳进行骚扰/侵犯且留下痕迹，该值会迅速上升。
  - > 60: 李强会变得疑神疑鬼，开始检查家里的角落，甚至安装自己的摄像头。
  - > 90: 李强会设下陷阱或直接 confront 房东。

### 5. 道具与资源 (Inventory)

- **消耗**:
  - 使用药物、耗材后，必须从 `inventory.items` 中 `_.remove` 或更新数量。
- **获取**:
  - 只有明确描述“去黑市购买”或“在网上订购”并支付 `money` 后，才能 `_.insert` 新道具。

---

## 示例解析

**场景**: 深夜 02:00，玩家用备用钥匙潜入 201 (lin_xiaolu 房间)，她服用了安眠药正在熟睡。玩家掀开被子抚摸她，并留下了精液，未清理直接离开。

**变量更新分析**:
1.  **Time**: 潜入行动耗时约 40 分钟 -> `world.time` += 40 min。
2.  **State**: 林小鹿处于药物昏迷 -> `tenants.lin_xiaolu.params.consciousness` 维持在 10。
3.  **Dev**: 进行了抚摸和射精 -> `tenants.lin_xiaolu.params.body_sensitivity` + 2。
4.  **Alert**: 玩家未清理精液 -> **严重失误**。次日林小鹿醒来发现后，`alertness` 将直接 +30 (极度惊恐)。
5.  **Player**: 消耗精力 -> `player.energy` - 20。