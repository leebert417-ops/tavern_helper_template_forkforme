# 网红小区-单页版 使用说明

## 📖 项目简介

这是一个基于 SillyTavern 的单页应用模拟经营游戏。玩家扮演公寓房东，与租客互动，管理公寓日常。

### 核心特性

- **单页应用模式**：所有交互都在一个消息楼层中完成，不会产生新的聊天消息
- **动态时间系统**：租客会根据日程表在不同房间之间移动
- **MVU 集成**：使用 MVU Beta 版框架管理游戏状态，LLM 可以通过标准化指令更新变量
- **响应式 UI**：基于 Vue 3 + Pinia 构建，实时反映游戏状态变化

## 🚀 快速开始

### 1. 构建项目

```bash
pnpm build:dev  # 开发模式
# 或
pnpm build      # 生产模式
```

构建完成后，生成的文件位于 `dist/网红小区-单页版/index.html`

### 2. 导入到 SillyTavern

1. 打开 SillyTavern
2. 进入"酒馆助手"扩展
3. 点击"导入前端界面"
4. 选择 `dist/网红小区-单页版/index.html`
5. 在聊天中输入加载命令（例如 `[TavernAI:网红小区-单页版]`）

### 3. 开始游戏

游戏界面分为三个主要区域：

- **左侧**：状态栏 + 行动面板
- **中间**：公寓地图视图
- **右侧**：叙事窗口

## 🎮 游戏玩法

### 时间推进

点击"时间控制"区域的按钮来推进游戏时间：
- **推进 1 小时**：快速推进
- **推进 2 小时**：常规推进
- **推进 6 小时**：跳过半天
- **推进 12 小时**：跳过半天（早晚切换）

租客会根据其日程表自动移动到相应房间。

### 房间移动

在"房间移动"区域点击房间按钮，即可移动到该房间。当前所在房间会高亮显示。

### 与租客互动

当你与租客在同一房间时，会出现"互动"区域。点击租客旁边的"互动"按钮，即可触发互动。

**互动流程**：
1. 系统调用 LLM 生成互动叙事
2. LLM 返回叙事文本 + MVU 更新指令
3. 系统解析指令并更新游戏状态（好感度、记忆等）
4. 叙事文本和状态变化显示在右侧窗口

## 📊 MVU 变量系统

本项目使用 MVU Beta 版框架管理游戏状态。

### 核心文件

- **变量初始化_beta.xyaml**：定义游戏初始状态和数据结构约束
- **变量更新规则.xyaml**：定义各变量的更新规则和触发条件
- **变量处理指令集_beta.xyaml**：LLM 用于理解如何更新变量的指令集

### MVU 指令示例

LLM 会在互动时输出类似以下的指令：

```xml
<UpdateVariable>
  <Analysis>
    tenants.林悦.好感度: Yes
    tenants.林悦.状态: Yes
    tenants.林悦.记忆: Yes
  </Analysis>
  _.add('tenants.林悦.好感度', 5); // 房东的关心让林悦感到温暖
  _.set('tenants.林悦.状态', '正在舞蹈练习', '正在与房东聊天'); // 互动改变了当前状态
  _.insert('tenants.林悦.记忆', '房东来健身房看望我'); // 添加新的记忆
</UpdateVariable>
```

### 支持的 MVU 命令

| 命令 | 用途 | 示例 |
|------|------|------|
| `_.set` | 直接赋值或状态变更 | `_.set('world.时间', '08:00', '10:00')` |
| `_.add` | 数值加减 | `_.add('tenants.林悦.好感度', 5)` |
| `_.insert` | 添加数组元素或对象键值对 | `_.insert('tenants.林悦.记忆', '新记忆')` |
| `_.remove` | 删除数组元素或对象键 | `_.remove('tenants.林悦.记忆', '旧记忆')` |

## 🏗️ 技术架构

### 前端技术栈

- **Vue 3**：响应式 UI 框架
- **Pinia**：状态管理
- **SCSS**：样式预处理
- **TypeScript**：类型安全

### 状态管理流程

```
用户操作 → Pinia Action → 
  ├─ 本地状态更新（时间推进、移动等）
  └─ LLM 交互（与租客互动）
      ├─ generate() 调用 LLM
      ├─ Mvu.parseMessage() 解析指令
      └─ store.$patch() 更新状态
          └─ Vue 自动更新 UI
```

### 数据持久化

游戏状态通过 SillyTavern 的消息楼层变量进行持久化：

```typescript
// 加载状态（App.vue onMounted）
const savedState = getVariables({ type: 'message', message_id: getMessageId() });
store.$patch(savedState);

// 保存状态（App.vue watchEffect）
watchEffect(() => {
  replaceVariables(klona(store.$state), { type: 'message', message_id: getMessageId() });
});
```

## 🎨 自定义与扩展

### 添加新租客

1. 在 `initialData.ts` 的 `initialTenantsState` 中添加新租客数据
2. 定义租客的 `schedule`（日程表）
3. 在 `变量初始化_beta.xyaml` 中添加对应的初始化数据
4. 重新构建项目

### 修改房间布局

编辑 `initialData.ts` 中的 `initialApartmentsState`，修改 `房间列表` 对象。

### 调整互动规则

编辑 `变量处理指令集_beta.xyaml` 中的 `context` 部分，修改好感度变化规则等。

## 🐛 故障排除

### 互动没有反应

1. 检查浏览器控制台是否有错误
2. 确认 MVU 框架已加载（查看控制台日志）
3. 检查 LLM 是否正常响应

### 状态没有保存

1. 确认消息楼层变量功能正常
2. 检查 `App.vue` 中的 `watchEffect` 是否正常执行
3. 查看控制台是否有 `replaceVariables` 相关错误

### 租客位置不更新

1. 检查租客的 `schedule` 是否正确定义
2. 确认时间推进功能正常工作
3. 查看 `advanceTime` 函数的控制台日志

## 📝 开发说明

### 项目结构

```
src/网红小区-单页版/
├── index.html              # HTML 入口
├── index.ts                # TypeScript 入口
├── App.vue                 # 主应用组件
├── gameStore.ts            # Pinia 状态管理
├── initialData.ts          # 初始数据定义
├── components/             # Vue 组件
│   ├── StatusBar.vue       # 状态栏
│   ├── ActionPanel.vue     # 行动面板
│   ├── MapView.vue         # 地图视图
│   └── NarrativeWindow.vue # 叙事窗口
├── styles/                 # 样式文件
│   └── theme.scss          # 主题样式
├── 变量初始化_beta.xyaml   # MVU 初始化
├── 变量更新规则.xyaml       # MVU 更新规则
└── 变量处理指令集_beta.xyaml # MVU 指令集
```

### 开发模式

```bash
# 监听文件变化并自动重新构建
pnpm build:dev --watch
```

## 📄 许可证

本项目遵循与 Tavern Helper Template 相同的许可证。

## 🙏 致谢

- **SillyTavern**：提供强大的 AI 聊天平台
- **Tavern Helper**：提供前端界面和脚本支持
- **MVU 框架**：提供变量管理系统

